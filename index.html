<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nomi Manager</title>
    <link rel="icon" type="image/svg+xml" href="logo.svg?v=1">
    <style>
        :root {
            --bg-body: #0f0f13;
            --bg-sidebar: #18181b;
            --bg-card: #222226;
            --glass-bg: rgba(30, 30, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --bg-input: #121214;
            --accent: #d946ef;
            --accent-hover: #c026d3;
            --success: #10b981;
            --error: #ef4444;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --border: #3f3f46;
            --static-logo: #a855f7;
            /* Fixed Font: Modern */
            --app-font: 'Inter', system-ui, -apple-system, sans-serif;
            --fixed-font: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--app-font);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
            z-index: 50;
            background: var(--bg-sidebar);
            transition: transform 0.3s ease;
        }

        .app-title {
            font-family: var(--fixed-font) !important;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-logo { width: 32px; height: 32px; flex-shrink: 0; }
        .app-logo rect { fill: var(--static-logo); }

        .sidebar-scroll { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
        .section-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: bold; margin-top: 20px; }

        /* SIDEBAR GROUPS */
        .group-item {
            padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s;
            margin-bottom: 8px; border: 1px solid transparent; display: flex;
            align-items: center; justify-content: space-between; font-size: 0.95rem;
        }
        .group-item:hover { background-color: var(--bg-card); }
        .group-item.active { background-color: #2e1065; border-color: var(--accent); }
        
        .group-info { display: flex; align-items: center; gap: 12px; overflow: hidden; width: 100%; }
        .group-avatar { 
            width: 40px; height: 40px; border-radius: 8px; object-fit: cover; 
            background: #333; flex-shrink: 0; border: 1px solid #444; 
        }
        .group-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }

        .btn-action { background-color: var(--accent); color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; margin-bottom: 8px; }
        .btn-action:hover { filter: brightness(1.1); }
        
        .btn-sync { background-color: #3b82f6; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; margin-bottom: 20px; display:flex; align-items:center; justify-content:center; gap:8px;}
        .btn-sync:hover { filter: brightness(1.1); }

        .settings-btn-area { border-top: 1px solid var(--border); padding-top: 15px; margin-top: auto; }
        .settings-btn { background: transparent; color: var(--text-muted); border: none; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 600; padding: 10px; border-radius: 6px; width: 100%; transition: 0.2s; }
        .settings-btn:hover { background: var(--bg-card); color: var(--accent); }

        /* --- MAIN CONTENT --- */
        .main-content { flex-grow: 1; overflow-y: auto; padding: 40px; position: relative; z-index: 10; width: 100%; }

        .hero-bg {
            position: fixed; top: 0; left: 280px; right: 0; bottom: 0;
            background-size: cover; background-position: center;
            filter: blur(25px) brightness(0.25);
            z-index: 0; pointer-events: none;
            transition: background-image 0.5s ease-in-out;
        }

        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; height: 50px; position: relative; z-index: 10; }
        .top-bar h2 { margin: 0; font-size: 1.5rem; }
        
        .mobile-menu-btn {
            display: none;
            background: transparent; border: none; color: var(--text-main);
            cursor: pointer; padding: 8px; margin-right: 10px;
        }

        .search-wrapper { position: relative; display: flex; align-items: center; justify-content: flex-end; }
        .search-icon-btn { background: transparent; border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: 0.2s; z-index: 2; backdrop-filter: blur(5px); }
        .search-icon-btn:hover { border-color: var(--accent); color: var(--accent); }
        .search-input { width: 0; padding: 0; border: none; background: var(--glass-bg); backdrop-filter: blur(10px); color: white; border-radius: 20px; transition: 0.3s ease-in-out; opacity: 0; position: absolute; right: 20px; height: 40px; }
        .search-input.active { width: 300px; padding: 0 15px; border: 1px solid var(--border); opacity: 1; right: 50px; }
        .search-input:focus { outline: none; border-color: var(--accent); }

        /* GALLERY (Home) */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; padding-bottom: 50px; position: relative; z-index: 10; }
        
        /* IMAGE GALLERY (Within Nomi Profile) - SWITCHED TO GRID */
        .masonry-grid { 
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Force 4 columns on PC */
            gap: 20px;
            position: relative; 
            z-index: 10;
            align-items: start; /* Align items to top of row */
        }
        
        @media (max-width: 1200px) { .masonry-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .masonry-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .masonry-grid { grid-template-columns: repeat(2, 1fr); } }

        .nomi-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s; display: flex; flex-direction: column; cursor: pointer; }
        .nomi-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .nomi-card img { width: 100%; height: auto; display: block; background: #000; min-height: 200px; object-fit: cover; }
        .nomi-card-info { padding: 12px; text-align: center; font-weight: 700; }

        .prompt-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative; 
            transition: border-color 0.2s; 
            width: 100%;
        }
        
        .prompt-card:hover { border: 2px solid var(--accent); }
        .prompt-card img { width: 100%; height: auto; display: block; cursor: zoom-in; object-fit: cover; }
        
        .ghost-overlay { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); padding: 5px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 5; }
        .prompt-card:hover .ghost-overlay { opacity: 1; pointer-events: auto; }
        .prompt-card:has(.prompt-popup.active) .ghost-overlay { display: none !important; }
        
        .prompt-popup { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); display: none; flex-direction: column; padding: 20px; justify-content: center; z-index: 10; }
        .prompt-popup.active { display: flex; }
        .prompt-popup textarea { background: transparent; border: 1px solid #444; color: #fff; flex-grow: 1; max-height: 60%; margin-bottom: 10px; padding: 10px; font-family: inherit; }
        
        .tool-btn { background: transparent; border: none; color: rgba(255,255,255,0.8); width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .tool-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .tool-btn.star:hover { color: #fbbf24; }
        .tool-btn.del:hover { color: #ef4444; }

        /* HEADER & NAME EDIT */
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; margin-bottom: 20px; position: relative; z-index: 10; }
        .back-btn:hover { color: var(--accent); }
        
        /* HEADER SECTION: HIGH Z-INDEX TO FIX DROPDOWN OVERLAP */
        .header-section { display: flex; gap: 20px; margin-bottom: 30px; background: var(--glass-bg); backdrop-filter: blur(15px); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); align-items: flex-start; position: relative; z-index: 100; }
        
        .photo-wrapper { position: relative; width: 100px; height: 100px; border-radius: 12px; overflow: hidden; background-color: rgba(0,0,0,0.5); flex-shrink: 0; border: 1px solid var(--glass-border); }
        .photo-wrapper.clickable { cursor: pointer; } 
        
        .photo-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .photo-wrapper .placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 2rem; font-weight: bold; }
        
        .identity-controls { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; /* Fix flex overflow */ }
        
        .name-row { display: flex; align-items: center; gap: 10px; min-height: 50px; flex-wrap: wrap; }
        .name-display { font-size: 2rem; font-weight: 800; color: var(--text-main); word-break: break-word; }
        .name-edit-container { display: none; width: 100%; align-items: center; gap: 10px; }
        .name-edit-container.active { display: flex; }
        .name-input { background: transparent; border: none; border-bottom: 2px solid var(--accent); color: var(--text-main); font-size: 2rem; font-weight: 800; width: 100%; padding: 0; outline:none; font-family: inherit; }
        
        .icon-btn { background: transparent; border: none; width: 32px; height: 32px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transition: 0.2s; padding:0; flex-shrink: 0;}
        .icon-btn:hover { color: var(--accent); transform: scale(1.1); }
        .icon-btn.save { color: var(--success); }

        /* COLUMN LAYOUT */
        .form-column-container { display: flex; gap: 20px; align-items: flex-start; position: relative; z-index: 10; }
        .form-column { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }

        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: all 0.2s; width: 100%; }
        .glass-card:hover { border-color: rgba(255,255,255,0.2); }
        .glass-card.collapsed .card-body { display: none; }
        .glass-card.collapsed { opacity: 0.8; }
        .glass-card.over-limit { border-color: var(--error); }
        .card-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; cursor: pointer; padding-bottom: 5px; }
        .card-arrow { transition: 0.3s; }
        .collapsed .card-arrow { transform: rotate(-90deg); }
        .card-body { display: block; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 5px;}
        textarea.ghost-input { background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); color: #eee; padding: 10px 0; width: 100%; min-height: 100px; resize: vertical; font-family: inherit; font-size: 0.95rem; line-height: 1.6; transition: 0.2s; border-radius: 0; }
        textarea.ghost-input:focus { outline: none; border-bottom-color: var(--accent); background: rgba(255,255,255,0.02); }

        .tab-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; justify-content: space-between; align-items: center; position: relative; z-index: 10; }
        .tab-left { display: flex; gap: 20px; }
        .tab-btn { background: none; border: none; color: var(--text-muted); font-size: 1.1rem; font-weight: bold; cursor: pointer; padding: 5px 10px; font-family: inherit; }
        .tab-btn.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }

        .btn-upload { background-color: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; transition: 0.2s; }
        .btn-upload:hover { filter: brightness(1.1); }
        .btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        .copy-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;}
        .copy-btn:hover { background: var(--accent); border-color: var(--accent); }
        .save-btn { background: #065f46; color: #a7f3d0; border: 1px solid #047857; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .save-btn:hover { background: #059669; color: white; }
        .btn-secondary { background-color: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; width:100%; text-align:center; font-family: inherit;}
        .btn-secondary:hover { background-color: var(--bg-card); color: var(--text-main); }
        
        .delete-btn { 
            color: var(--error); background: transparent; border: 1px solid var(--error); 
            padding: 15px; border-radius: 8px; cursor: pointer; 
            width: 100%; margin-top: 40px; margin-bottom: 40px;
            position:relative; z-index:10; font-family: inherit; font-weight: bold;
            display: block; text-align: center; font-size: 1rem;
        }
        .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }

        .traits-header { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #ccc; }
        .add-trait-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.7rem; }
        .add-trait-btn:hover { background: var(--accent); }
        #traitInput { display: none; background:transparent; border:none; color:white; border-bottom:1px solid #ccc; width:100%; padding:5px; margin-top:5px; font-family: inherit;}
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag { background: var(--accent); color: #000; font-weight:600; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; }

        .custom-select-wrapper { position: relative; display: inline-block; margin-top: 10px; }
        .custom-select-trigger { background: #27272a; color: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        
        /* DROPDOWN FIX: Increased Z-Index to 1000 to overlay delete button */
        .custom-options { position: absolute; top: 100%; left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; display: none; z-index: 1000; max-height: 300px; overflow-y: auto; width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.9); }
        .custom-options.open { display: block; }
        .custom-option { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #333; }
        .custom-option:hover { background: var(--bg-input); color: var(--accent); }
        .custom-option img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        
        .member-list-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 5px;}
        .member-chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 5px 10px 5px 5px; display: flex; align-items: center; gap: 8px; backdrop-filter:blur(5px); }
        .member-chip img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .member-remove { cursor: pointer; color: #ccc; font-weight: bold; margin-left: 5px;}
        .member-remove:hover { color: var(--error); }

        .lightbox { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .lightbox.active { display: flex; }
        .lightbox-content { max-width: 95%; max-height: 95%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid #333; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .lightbox-close:hover { color: var(--accent); }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 99; font-weight: bold; }
        .toast.show { opacity: 1; }

        .settings-modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .settings-modal.active { display: flex; }
        .settings-panel { background: var(--bg-card); border: 1px solid var(--border); width: 500px; max-width: 90%; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .settings-header h2 { margin: 0; color: var(--accent); }
        .settings-close { font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .settings-close:hover { color: var(--accent); }
        .settings-section { margin-bottom: 25px; }
        .settings-label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--text-main); font-size: 0.9rem; }
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .theme-opt { height: 40px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .theme-opt:hover { transform: scale(1.05); }
        .select-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; cursor: pointer; font-family: inherit; }
        .input-text { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; font-family: inherit; }

        /* CROPPER MODAL */
        .crop-modal { display: none; position: fixed; z-index: 6000; top: 0; left: 0; width: 100%; height: 100%; background: #000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-modal.active { display: flex; }
        .crop-container { width: 400px; height: 400px; border: 2px solid #333; position: relative; overflow: hidden; background: #111; cursor: grab; max-width: 100%; }
        .crop-container:active { cursor: grabbing; }
        .crop-image { position: absolute; top:0; left:0; transform-origin: 0 0; }
        .crop-overlay { pointer-events: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 0 9999px rgba(0,0,0,0.5); }
        /* Actually simpler circle overlay */
        .circle-guide { pointer-events: none; position: absolute; top: 0; left: 0; width: 400px; height: 400px; border: 2px solid var(--accent); border-radius: 50%; box-shadow: 0 0 0 200px rgba(0,0,0,0.7); }
        .crop-controls { margin-top: 20px; display: flex; gap: 20px; align-items: center; width: 400px; max-width: 90%; }
        .crop-slider { flex-grow: 1; }
        .crop-btns { margin-top: 20px; display: flex; gap: 10px; }

        /* MOBILE OVERLAY */
        .mobile-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
            z-index: 40;
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0; left: 0;
                height: 100%;
                transform: translateX(-100%); /* Hide by default */
            }
            .sidebar.open { transform: translateX(0); }
            
            /* Add extra padding at bottom for safe area on mobile */
            .main-content { padding: 15px; width: 100%; padding-bottom: 100px; }
            .hero-bg { left: 0; }
            
            .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
            
            .header-section { flex-direction: column; align-items: center; text-align: center; }
            .identity-controls { width: 100%; }
            .name-row { justify-content: center; }
            .traits-header { justify-content: center; }
            .tag-container { justify-content: center; }
            
            /* Center Members on Mobile */
            .member-list-container { justify-content: center; }
            .custom-select-wrapper { display: flex; justify-content: center; width: 100%; }
            
            .search-input.active { width: 200px; right: 50px; }
            
            /* Ensure gallery grid adapts */
            .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            
            .tab-nav { flex-wrap: wrap; gap: 10px; }
            
            .settings-panel { width: 100%; height: 100%; border-radius: 0; max-width: 100%; overflow-y: auto;}
            
            /* Mobile Cropper - Fully Responsive */
            .crop-container { width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; }
            .circle-guide { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
            .crop-controls { width: 90vw; }
            
            /* Fix for delete button on mobile */
            .delete-btn { width: 100%; float: none; margin-top: 20px; padding: 15px; font-size: 1.1rem; }
            
            /* Mobile Prompt Popup Override (Centered Modal) */
            .prompt-popup.active {
                position: fixed;
                top: 50%; left: 50%;
                transform: translate(-50%, -50%);
                width: 90vw;
                max-width: 400px;
                height: auto;
                min-height: 300px;
                max-height: 80vh; /* Increased height for mobile */
                z-index: 10000;
                border: 1px solid var(--accent);
                box-shadow: 0 0 0 9999px rgba(0,0,0,0.85); /* Dark backdrop */
                border-radius: 12px;
                background: var(--bg-card);
            }
            .prompt-card { transform: none !important; z-index: auto; }
        }
        
        @media (max-width: 480px) {
             /* Force 2 columns on mobile as requested */
            .masonry-grid { 
                grid-template-columns: repeat(2, 1fr); 
            }
            
            /* Square aspect ratio for grid cells */
            .prompt-card img { 
                width: 100%; 
                aspect-ratio: 1 / 1; 
                object-fit: cover; 
                display: block; 
            }
            
            /* Make Overlay Icons Always Visible on Mobile */
            .ghost-overlay { 
                opacity: 1 !important; 
                background: rgba(0,0,0,0.4); 
                bottom: 0; top: auto; right: 0; left: 0;
                justify-content: center; padding: 5px 0;
                border-radius: 0; border: none;
            }
            .tool-btn { width: 24px; height: 24px; }
            .tool-btn svg { width: 14px; height: 14px; }
        }
    </style>
</head>
<body>

<div class="mobile-overlay" id="mobileOverlay" onclick="app.toggleSidebar(false)"></div>

<div id="lightbox" class="lightbox" onclick="app.closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightboxImg">
</div>

<div id="cropModal" class="crop-modal">
    <div class="crop-container" id="cropContainer" onmousedown="cropper.startDrag(event)" ontouchstart="cropper.startDrag(event)">
        <img id="cropTarget" class="crop-image" draggable="false">
        <div class="circle-guide"></div>
    </div>
    <div class="crop-controls">
        <span>Zoom:</span>
        <input type="range" min="0.1" max="3" step="0.05" value="1" class="crop-slider" id="cropZoom" oninput="cropper.setZoom(this.value)">
    </div>
    <div class="crop-btns">
        <button class="btn-secondary" onclick="cropper.cancel()">Cancel</button>
        <button class="save-btn" onclick="cropper.save()">Set Profile Picture</button>
    </div>
</div>

<div id="settingsModal" class="settings-modal" onclick="if(event.target === this) app.toggleSettings()">
    <div class="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <span class="settings-close" onclick="app.toggleSettings()">×</span>
        </div>
        <div class="settings-section">
            <span class="settings-label">Nomi.ai API Key</span>
            <input type="password" id="apiKeyInput" class="input-text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" oninput="app.saveSetting('apiKey', this.value)">
            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Found in Nomi App > Profile > Integrations</div>
        </div>
        <div class="settings-section">
            <span class="settings-label">Color Theme</span>
            <div class="theme-grid">
                <div class="theme-opt" style="background:#d946ef;" onclick="app.setTheme('cyber')"></div>
                <div class="theme-opt" style="background:#22c55e;" onclick="app.setTheme('matrix')"></div>
                <div class="theme-opt" style="background:#eab308;" onclick="app.setTheme('royal')"></div>
                <div class="theme-opt" style="background:#ef4444;" onclick="app.setTheme('crimson')"></div>
                <div class="theme-opt" style="background:#06b6d4;" onclick="app.setTheme('ice')"></div>
            </div>
        </div>
        
        <div class="settings-section">
            <span class="settings-label">Start-Up View</span>
            <select id="startUpSelect" class="select-input" onchange="app.saveSetting('startView', this.value)">
                <option value="home">Dashboard (Gallery)</option>
                <option value="last">Last Opened Nomi</option>
            </select>
        </div>
        <div class="settings-section">
            <span class="settings-label">Data Management</span>
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary" onclick="app.exportData()" style="display:flex; align-items:center; gap:8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Backup
                </button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()" style="display:flex; align-items:center; gap:8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Restore
                </button>
            </div>
        </div>
    </div>
</div>

<div class="sidebar" id="appSidebar">
    <div class="app-title" onclick="app.goHome(); app.toggleSidebar(false)">
        <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect x="5" y="5" width="90" height="90" rx="20" ry="20" />
            <text x="50" y="75" font-size="70" font-family="Arial, sans-serif" font-weight="bold" fill="#fff" text-anchor="middle">N</text>
        </svg>
        Nomi Manager
    </div>
    
    <button class="btn-sync" onclick="app.syncFromApi()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
        Sync from Nomi.ai
    </button>
    
    <div class="sidebar-scroll">
        <div class="section-label">Groups</div>
        <div id="groupList"></div>
        <button class="btn-action" onclick="app.createGroup(); app.toggleSidebar(false)">+ New Group</button>
    </div>
    <div class="settings-btn-area">
        <button class="settings-btn" onclick="app.toggleSettings(); app.toggleSidebar(false)">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            Settings
        </button>
    </div>
</div>

<div class="main-content">
    <div id="heroBackground" class="hero-bg"></div>

    <div id="viewHome">
        <div class="top-bar">
            <div style="display:flex; align-items:center;">
                <button class="mobile-menu-btn" onclick="app.toggleSidebar(true)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <h2>My Nomis</h2>
            </div>
            <div class="search-wrapper">
                <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="app.renderGallery()">
                <button class="search-icon-btn" onclick="document.getElementById('searchInput').classList.toggle('active'); document.getElementById('searchInput').focus();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </div>
        </div>
        <button class="btn-action" style="width:auto; margin-bottom: 20px;" onclick="app.createNomi()">+ Create Nomi</button>
        <div class="gallery-grid" id="nomiGallery"></div>
    </div>

    <div id="viewNomi" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div class="back-btn" onclick="app.goHome()" style="margin:0;">← Back</div>
            <button class="mobile-menu-btn" onclick="app.toggleSidebar(true)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <div class="header-section">
            <div class="photo-wrapper">
                <img id="nomiImageDisplay" src="" style="display:none;">
                <div id="nomiImagePlaceholder" class="placeholder">?</div>
            </div>
            <div class="identity-controls">
                
                <div class="name-row">
                    <div id="nomiNameDisplay" class="name-display">Name</div>
                    <button class="icon-btn" onclick="app.toggleNameEdit('nomi', true)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    
                    <div id="nomiNameEdit" class="name-edit-container">
                        <input type="text" class="name-input" id="nomiName" placeholder="Name">
                        <button class="icon-btn save" onclick="app.saveName('nomi')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                    </div>
                </div>

                <div class="traits-header">
                    Key Traits
                    <button class="add-trait-btn" onclick="document.getElementById('traitInput').style.display = 'block'; document.getElementById('traitInput').focus()">+ Add</button>
                </div>
                <input type="text" id="traitInput" placeholder="Type & Enter" maxlength="20">
                <div class="tag-container" id="traitContainer"></div>
            </div>
        </div>
        
        <div class="tab-nav">
            <div class="tab-left">
                <button class="tab-btn active" id="tabProfile" onclick="app.switchTab('profile')">Profile Data</button>
                <button class="tab-btn" id="tabGallery" onclick="app.switchTab('gallery')">Gallery</button>
            </div>
            <div id="galleryActions" style="display:none;">
                <button class="btn-upload" onclick="document.getElementById('galleryUpload').click()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Upload
                </button>
                <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none" onchange="app.addGalleryImages(this)">
            </div>
        </div>

        <div id="contentProfile">
            <div class="form-column-container" id="profileGrid"></div>
            <button class="delete-btn" onclick="app.deleteNomi()">Delete Nomi</button>
        </div>
        
        <div id="contentGallery" style="display:none;">
            <div class="masonry-grid" id="promptGalleryGrid"></div>
        </div>
    </div>

    <div id="viewGroup" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div class="back-btn" onclick="app.goHome()" style="margin:0;">← Back</div>
            <button class="mobile-menu-btn" onclick="app.toggleSidebar(true)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <div class="header-section">
            <div class="photo-wrapper clickable" onclick="document.getElementById('groupPhotoInput').click()">
                <img id="groupImageDisplay" src="" style="display:none;">
                <div id="groupImagePlaceholder" class="placeholder">G</div>
                <input type="file" id="groupPhotoInput" accept="image/*" style="display:none;" onchange="cropper.init(this, 'group')">
            </div>
            <div style="width:100%">
                
                <div class="name-row">
                    <div id="groupNameDisplay" class="name-display">Group Name</div>
                    <button class="icon-btn" onclick="app.toggleNameEdit('group', true)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    
                    <div id="groupNameEdit" class="name-edit-container">
                        <input type="text" class="name-input" id="groupName" placeholder="Group Name">
                        <button class="icon-btn save" onclick="app.saveName('group')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                    </div>
                </div>
                
                <div style="margin-top:15px; font-weight:bold;">Members:</div>
                <div id="groupMembers" class="member-list-container"></div>
                
                <div class="custom-select-wrapper" id="memberDropdownWrapper">
                    <div class="custom-select-trigger" onclick="app.toggleMemberDropdown()">+ Add Member</div>
                    <div class="custom-options" id="memberOptions"></div>
                </div>
            </div>
        </div>
        
        <div id="groupSectionsContainer" style="display:flex; flex-direction:column; gap:20px;">
            <div class="glass-card collapsed">
                <div class="card-header" onclick="app.toggleCard(this.parentNode)"><span>Group Backstory</span><div><span class="char-counter" id="groupCount">0 / 1000</span><span class="card-arrow" style="margin-left:10px">▼</span></div></div>
                <div class="card-body">
                    <textarea id="groupBackstory" class="ghost-input" oninput="app.autoSaveGroup()"></textarea>
                    <div class="btn-row">
                        <button class="save-btn" onclick="app.saveCurrentGroup(true)">Save</button>
                        <button class="copy-btn" onclick="app.copyText('groupBackstory')">Copy</button>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn-secondary" style="margin-top:20px;" onclick="app.addGroupSection()">+ Add Custom Section</button>
        <button class="delete-btn" onclick="app.deleteGroup()">Delete Group</button>
    </div>

</div>

<input type="file" id="importFile" style="display:none" onchange="app.importData(this)">
<div class="toast" id="toast">Saved Successfully!</div>

<script>
/** NOMI MANAGER **/

const DB_NAME = 'NomiArchDB_v14';
const DB_VERSION = 1;
const SECTIONS = [
    { id: 'backstory', label: 'Backstory', limit: 2000 },
    { id: 'inclination', label: 'Inclination', limit: 150 },
    { id: 'current_roleplay', label: 'Current Roleplay', limit: 750 },
    { id: 'your_appearance', label: 'Your Appearance', limit: 200 },
    { id: 'nomi_appearance', label: 'Nomi\'s Appearance', limit: 500 },
    { id: 'appearance_tendencies', label: 'Appearance Tendencies', limit: 200 },
    { id: 'nicknames', label: 'Nicknames', limit: 250 },
    { id: 'preferences', label: 'Preferences', limit: 500 },
    { id: 'desires', label: 'Desires', limit: 500 },
    { id: 'boundaries', label: 'Boundaries', limit: 500 }
];

const THEMES = {
    cyber: { accent: '#d946ef', hover: '#c026d3' },
    matrix: { accent: '#22c55e', hover: '#16a34a' },
    royal: { accent: '#eab308', hover: '#ca8a04' },
    crimson: { accent: '#ef4444', hover: '#dc2626' },
    ice: { accent: '#06b6d4', hover: '#0891b2' }
};

// CROPPER LOGIC
const cropper = {
    active: false,
    img: null,
    scale: 1,
    posX: 0,
    posY: 0,
    isDragging: false,
    startX: 0, startY: 0,
    targetType: null,

    init(input, type) {
        if(!input.files[0]) return;
        this.targetType = type;
        const reader = new FileReader();
        reader.onload = (e) => {
            this.openCropModal(e.target.result);
        };
        reader.readAsDataURL(input.files[0]);
    },
    
    initFromUrl(url, type) {
        this.targetType = type;
        this.openCropModal(url);
    },

    openCropModal(src) {
        const img = document.getElementById('cropTarget');
        img.src = src;
        img.onload = () => {
            this.scale = 1; this.posX = 0; this.posY = 0;
            this.updateTransform();
            document.getElementById('cropZoom').value = 1;
            document.getElementById('cropModal').classList.add('active');
        }
    },

    setZoom(val) {
        this.scale = parseFloat(val);
        this.updateTransform();
    },

    startDrag(e) {
        e.preventDefault();
        this.isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        this.startX = clientX - this.posX;
        this.startY = clientY - this.posY;
        
        const moveHandler = (ev) => {
            if(!this.isDragging) return;
            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
            this.posX = cx - this.startX;
            this.posY = cy - this.startY;
            this.updateTransform();
        };

        const endHandler = () => {
            this.isDragging = false;
            document.removeEventListener('mousemove', moveHandler);
            document.removeEventListener('mouseup', endHandler);
            document.removeEventListener('touchmove', moveHandler);
            document.removeEventListener('touchend', endHandler);
        };

        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', endHandler);
        document.addEventListener('touchmove', moveHandler);
        document.addEventListener('touchend', endHandler);
    },

    updateTransform() {
        const img = document.getElementById('cropTarget');
        img.style.transform = `translate(${this.posX}px, ${this.posY}px) scale(${this.scale})`;
    },

    save() {
        const canvas = document.createElement('canvas');
        canvas.width = 400; canvas.height = 400;
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('cropTarget');
        const container = document.getElementById('cropContainer');
        
        const ratio = 400 / container.offsetWidth;

        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,400,400);
        
        const renderedImg = document.getElementById('cropTarget');
        const renderedWidth = renderedImg.getBoundingClientRect().width / this.scale; 
        
        const naturalWidth = img.naturalWidth;
        const outputRatio = 400 / container.offsetWidth;
        
        ctx.translate(this.posX * outputRatio, this.posY * outputRatio);
        
        const drawScale = (renderedWidth / naturalWidth) * this.scale * outputRatio;
        
        ctx.scale(drawScale, drawScale);
        ctx.drawImage(img, 0, 0);
        
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        
        if(this.targetType === 'nomi') app.setNomiPhoto(dataUrl);
        else app.setGroupPhoto(dataUrl);

        this.cancel();
    },

    cancel() {
        document.getElementById('cropModal').classList.remove('active');
        const nInput = document.getElementById('nomiPhotoInput');
        if(nInput) nInput.value = '';
        const gInput = document.getElementById('groupPhotoInput');
        if(gInput) gInput.value = '';
    }
};

class NomiApp {
    constructor() {
        this.db = null;
        this.data = { nomis: [], groups: [], settings: { theme: 'cyber', startView: 'home', lastNomi: null, apiKey: '' } };
        this.currentNomiId = null;
        this.currentGroupId = null;
        this.resizeDebounce = null;
        window.addEventListener('resize', () => {
            clearTimeout(this.resizeDebounce);
            this.resizeDebounce = setTimeout(() => {
                if(document.getElementById('viewNomi').style.display === 'block' && document.getElementById('tabProfile').classList.contains('active')) {
                    this.renderFormGrid();
                }
            }, 100);
        });
    }

    async init() {
        await this.openDB();
        await this.loadData();
        this.applyTheme(this.data.settings?.theme || 'cyber');
        this.initStartView();
        this.renderGallery();
        this.renderSidebar();
        document.getElementById('traitInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { this.addTrait(e.target.value); e.target.value = ''; document.getElementById('traitInput').style.display='none'; }
        });
        document.addEventListener('click', (e) => {
            if(!e.target.closest('#memberDropdownWrapper')) document.getElementById('memberOptions').classList.remove('open');
        });
    }

    toggleSidebar(show) {
        const sidebar = document.getElementById('appSidebar');
        const overlay = document.getElementById('mobileOverlay');
        if(show) {
            sidebar.classList.add('open');
            overlay.style.display = 'block';
        } else {
            sidebar.classList.remove('open');
            overlay.style.display = 'none';
        }
    }

    openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' });
            };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e);
        });
    }

    saveToDB() {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['data'], 'readwrite');
            const store = transaction.objectStore('data');
            store.put({ id: 'root', nomis: this.data.nomis, groups: this.data.groups, settings: this.data.settings });
            transaction.oncomplete = resolve;
            transaction.onerror = reject;
        });
    }

    loadData() {
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction(['data'], 'readonly');
            const store = transaction.objectStore('data');
            const request = store.get('root');
            request.onsuccess = (e) => {
                if (e.target.result) {
                    this.data.nomis = e.target.result.nomis || [];
                    this.data.groups = e.target.result.groups || [];
                    this.data.settings = e.target.result.settings || { theme: 'cyber', startView: 'home', apiKey: '' };
                }
                resolve();
            };
        });
    }

    toggleSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.toggle('active');
        if(modal.classList.contains('active')) {
            document.getElementById('startUpSelect').value = this.data.settings.startView || 'home';
            document.getElementById('apiKeyInput').value = this.data.settings.apiKey || '';
        }
    }

    setTheme(themeName) {
        this.data.settings.theme = themeName;
        this.applyTheme(themeName);
        this.saveToDB();
    }

    applyTheme(themeName) {
        const t = THEMES[themeName];
        if(!t) return;
        document.documentElement.style.setProperty('--accent', t.accent);
        document.documentElement.style.setProperty('--accent-hover', t.hover);
    }

    saveSetting(key, val) {
        this.data.settings[key] = val;
        this.saveToDB();
    }

    async syncFromApi() {
        const key = this.data.settings.apiKey;
        if (!key) {
            alert("Please go to Settings and enter your Nomi.ai API Key first.");
            this.toggleSettings();
            return;
        }

        const btn = document.querySelector('.btn-sync');
        const origText = btn.innerHTML;
        btn.innerHTML = 'Syncing...';
        btn.disabled = true;

        try {
            this.showToast("Connecting to Nomi.ai...");
            
            const listUrl = "https://corsproxy.io/?https://api.nomi.ai/v1/nomis";
            const listRes = await fetch(listUrl, {
                method: "GET",
                headers: { "Authorization": key }
            });

            if (!listRes.ok) throw new Error("Failed to fetch Nomis. Check API Key.");
            
            const listData = await listRes.json();
            const nomis = listData.nomis; 
            
            let updatedCount = 0;
            let newCount = 0;

            for (const remote of nomis) {
                let local = this.data.nomis.find(n => n.uuid === remote.uuid || n.name === remote.name);
                
                if (!local) {
                    local = {
                        id: Date.now() + Math.random(),
                        uuid: remote.uuid,
                        name: remote.name,
                        photo: null,
                        data: { key_traits: [] },
                        gallery: []
                    };
                    this.data.nomis.push(local);
                    newCount++;
                } else {
                    if(!local.uuid) local.uuid = remote.uuid; 
                    updatedCount++;
                }

                if (!local.photo) {
                    try {
                        const avatarUrl = `https://corsproxy.io/?https://api.nomi.ai/v1/nomis/${remote.uuid}/avatar`;
                        const avatarRes = await fetch(avatarUrl, {
                            headers: { "Authorization": key }
                        });
                        
                        if (avatarRes.ok) {
                            const blob = await avatarRes.blob();
                            const base64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result);
                                reader.readAsDataURL(blob);
                            });
                            local.photo = base64;
                        }
                    } catch (err) {
                        console.warn(`Could not fetch avatar for ${remote.name}`, err);
                    }
                }
            }

            await this.saveToDB();
            this.renderGallery();
            this.showToast(`Sync Complete! Added ${newCount}, Updated ${updatedCount}.`);

        } catch (err) {
            console.error(err);
            alert("Sync Error: " + err.message);
        } finally {
            btn.innerHTML = origText;
            btn.disabled = false;
        }
    }

    initStartView() {
        if(this.data.settings.startView === 'last' && this.data.settings.lastNomi) {
            const exists = this.data.nomis.find(n => n.id === this.data.settings.lastNomi);
            if(exists) this.editNomi(exists.id); else this.goHome();
        } else { this.goHome(); }
    }

    goHome() {
        document.getElementById('viewHome').style.display = 'block';
        document.getElementById('viewNomi').style.display = 'none';
        document.getElementById('viewGroup').style.display = 'none';
        document.getElementById('heroBackground').style.backgroundImage = 'none'; 
        this.currentNomiId = null; this.currentGroupId = null;
        this.renderSidebar(); this.renderGallery();
    }

    switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab' + (tab.charAt(0).toUpperCase() + tab.slice(1))).classList.add('active');
        const actions = document.getElementById('galleryActions');
        if (tab === 'profile') {
            document.getElementById('contentProfile').style.display = 'block';
            document.getElementById('contentGallery').style.display = 'none';
            actions.style.display = 'none';
            this.renderFormGrid(); 
        } else {
            document.getElementById('contentProfile').style.display = 'none';
            document.getElementById('contentGallery').style.display = 'block';
            actions.style.display = 'flex';
            this.renderPromptGallery();
        }
    }

    createNomi() {
        const newNomi = { id: Date.now(), name: "New Nomi", photo: null, data: { key_traits: [] }, gallery: [] };
        this.data.nomis.push(newNomi);
        this.saveToDB().then(() => this.editNomi(newNomi.id));
    }

    editNomi(id) {
        this.currentNomiId = id;
        this.data.settings.lastNomi = id; 
        this.saveToDB(); 

        const nomi = this.data.nomis.find(n => n.id === id);
        document.getElementById('viewHome').style.display = 'none';
        document.getElementById('viewNomi').style.display = 'block';
        document.getElementById('viewGroup').style.display = 'none';
        this.switchTab('profile');

        this.toggleNameEdit('nomi', false);
        document.getElementById('nomiNameDisplay').innerText = nomi.name;
        document.getElementById('nomiName').value = nomi.name;

        const imgDisplay = document.getElementById('nomiImageDisplay');
        const imgPlaceholder = document.getElementById('nomiImagePlaceholder');
        if(nomi.photo) {
            imgDisplay.src = nomi.photo; imgDisplay.style.display = 'block'; imgPlaceholder.style.display = 'none';
            document.getElementById('heroBackground').style.backgroundImage = `url(${nomi.photo})`;
        } else {
            imgDisplay.style.display = 'none'; imgPlaceholder.style.display = 'flex';
            document.getElementById('heroBackground').style.backgroundImage = 'none';
        }
        this.renderTraits();
        this.renderFormGrid();
    }

    toggleNameEdit(type, isEditing) {
        const display = document.getElementById(type + 'NameDisplay');
        const edit = document.getElementById(type + 'NameEdit');
        const btn = display.nextElementSibling; 

        if(isEditing) {
            display.style.display = 'none';
            btn.style.display = 'none';
            edit.classList.add('active');
            document.getElementById(type + 'Name').focus();
        } else {
            display.style.display = 'block';
            btn.style.display = 'flex';
            edit.classList.remove('active');
        }
    }

    saveName(type) {
        const val = document.getElementById(type + 'Name').value;
        if(type === 'nomi') {
            const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
            nomi.name = val;
            document.getElementById('nomiNameDisplay').innerText = val;
            this.autoSaveNomi();
        } else {
            const group = this.data.groups.find(g => g.id === this.currentGroupId);
            group.name = val;
            document.getElementById('groupNameDisplay').innerText = val;
            this.autoSaveGroup();
        }
        this.toggleNameEdit(type, false);
    }

    autoSaveNomi() { this.saveCurrentNomi(false); }
    saveCurrentNomi(showToast = false) {
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        SECTIONS.forEach(sec => {
            const el = document.getElementById(`field_${sec.id}`);
            if(el) nomi.data[sec.id] = el.value;
        });
        this.saveToDB().then(() => { if(showToast) this.showToast("Profile Saved!"); });
    }

    renderTraits() {
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        const container = document.getElementById('traitContainer'); container.innerHTML = '';
        (nomi.data.key_traits || []).forEach(t => {
            const tag = document.createElement('div'); tag.className = 'tag'; tag.innerText = t + ' ×';
            tag.onclick = () => { nomi.data.key_traits = nomi.data.key_traits.filter(x => x !== t); this.saveToDB(); this.renderTraits(); };
            container.appendChild(tag);
        });
    }

    addTrait(text) {
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        if(!nomi.data.key_traits) nomi.data.key_traits = [];
        if(nomi.data.key_traits.length >= 7) return alert("Max 7 traits");
        if(text.trim()) { nomi.data.key_traits.push(text.trim()); this.saveToDB(); this.renderTraits(); }
    }

    renderFormGrid() {
        const container = document.getElementById('profileGrid');
        container.innerHTML = '';
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        if(!nomi) return;

        const width = window.innerWidth;
        let colCount = 3;
        if (width <= 1000) colCount = 2;
        if (width <= 600) colCount = 1;

        const columns = [];
        for (let i = 0; i < colCount; i++) {
            const col = document.createElement('div');
            col.className = 'form-column';
            container.appendChild(col);
            columns.push(col);
        }

        SECTIONS.forEach((sec, index) => {
            const val = nomi.data[sec.id] || '';
            const html = `
                <div class="glass-card collapsed ${val.length > sec.limit ? 'over-limit' : ''}" id="card_${sec.id}">
                    <div class="card-header" onclick="app.toggleCard(this.parentNode)">
                        <span>${sec.label}</span>
                        <div><span id="count_${sec.id}" style="font-size:0.8rem; margin-right:10px; opacity:0.6">${val.length} / ${sec.limit}</span><span class="card-arrow">▼</span></div>
                    </div>
                    <div class="card-body">
                        <textarea id="field_${sec.id}" class="ghost-input" oninput="app.handleInput('${sec.id}', ${sec.limit})">${val}</textarea>
                        <div class="btn-row"><button class="save-btn" onclick="app.saveCurrentNomi(true)">Save</button><button class="copy-btn" onclick="app.copyText('field_${sec.id}')">Copy</button></div>
                    </div>
                </div>`;
            
            const targetColIndex = index % colCount;
            columns[targetColIndex].insertAdjacentHTML('beforeend', html);
        });
    }

    toggleCard(card) { card.classList.toggle('collapsed'); }
    handleInput(id, limit) {
        const el = document.getElementById(`field_${id}`); const card = document.getElementById(`card_${id}`); const count = document.getElementById(`count_${id}`);
        if(count) count.innerText = `${el.value.length} / ${limit}`;
        if(el.value.length > limit) { card.classList.add('over-limit'); count.style.color = '#ef4444'; } else { card.classList.remove('over-limit'); count.style.color = 'inherit'; }
        this.autoSaveNomi();
    }

    async addGalleryImages(input) {
        const files = Array.from(input.files);
        if(files.length === 0) return;
        for (const file of files) {
            await new Promise(resolve => {
                this.processImage(file, 1024, (base64) => {
                    const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
                    if(!nomi.gallery) nomi.gallery = [];
                    nomi.gallery.push({ id: Date.now() + Math.random(), img: base64, prompt: "" });
                    resolve();
                });
            });
        }
        this.saveToDB().then(() => this.renderPromptGallery());
    }

    renderPromptGallery() {
        const grid = document.getElementById('promptGalleryGrid'); grid.innerHTML = '';
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        (nomi.gallery || []).forEach(item => {
            const div = document.createElement('div'); div.className = 'prompt-card';
            div.innerHTML = `
                <img src="${item.img}" onclick="app.openLightbox('${item.img}')">
                <div class="ghost-overlay">
                    <button class="tool-btn star" title="Crop & Set as Profile" onclick="event.stopPropagation(); cropper.initFromUrl('${item.img}', 'nomi')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    </button>
                    <button class="tool-btn" title="View/Edit Prompt" onclick="event.stopPropagation(); app.togglePromptPopup(${item.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="tool-btn del" title="Delete Image" onclick="event.stopPropagation(); app.deleteGalleryItem(${item.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
                <div class="prompt-popup" id="popup_${item.id}" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                         <strong style="color:var(--accent);">Image Prompt</strong>
                         <span style="cursor:pointer; font-size:1.2rem;" onclick="app.togglePromptPopup(${item.id})">✕</span>
                    </div>
                    <textarea id="prompt_input_${item.id}" oninput="app.updatePrompt(${item.id}, this.value)">${item.prompt}</textarea>
                    <div class="btn-row">
                        <button class="save-btn" onclick="app.savePromptManual()">Save</button>
                        <button class="copy-btn" onclick="app.copyText('prompt_input_${item.id}')">Copy Prompt</button>
                    </div>
                </div>`;
            grid.appendChild(div);
        });
    }
    
    togglePromptPopup(id) { document.getElementById(`popup_${id}`).classList.toggle('active'); }
    updatePrompt(imgId, text) { const nomi = this.data.nomis.find(n => n.id === this.currentNomiId); const item = nomi.gallery.find(g => g.id === imgId); if(item) { item.prompt = text; this.saveToDB(); } }
    savePromptManual() { this.showToast("Prompt Saved!"); }
    deleteGalleryItem(imgId) { if(!confirm("Remove image?")) return; const nomi = this.data.nomis.find(n => n.id === this.currentNomiId); nomi.gallery = nomi.gallery.filter(g => g.id !== imgId); this.saveToDB(); this.renderPromptGallery(); }
    
    setNomiPhoto(base64) {
        const nomi = this.data.nomis.find(n => n.id === this.currentNomiId);
        nomi.photo = base64;
        this.saveToDB();
        document.getElementById('nomiImageDisplay').src = base64; 
        document.getElementById('nomiImageDisplay').style.display = 'block'; 
        document.getElementById('nomiImagePlaceholder').style.display = 'none';
        document.getElementById('heroBackground').style.backgroundImage = `url(${base64})`;
    }

    setGroupPhoto(base64) {
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        group.photo = base64;
        this.saveToDB();
        document.getElementById('groupImageDisplay').src = base64;
        document.getElementById('groupImageDisplay').style.display = 'block';
        document.getElementById('groupImagePlaceholder').style.display = 'none';
        this.renderSidebar();
    }

    createGroup() {
        const newGroup = { id: Date.now(), name: "New Group", photo: null, backstory: "", members: [], custom_sections: [] };
        this.data.groups.push(newGroup);
        this.saveToDB().then(() => this.editGroup(newGroup.id));
    }

    editGroup(id) {
        this.currentGroupId = id;
        const group = this.data.groups.find(g => g.id === id);
        document.getElementById('viewHome').style.display = 'none'; document.getElementById('viewNomi').style.display = 'none'; document.getElementById('viewGroup').style.display = 'block';
        document.getElementById('heroBackground').style.backgroundImage = 'none'; 
        
        this.toggleNameEdit('group', false);
        document.getElementById('groupNameDisplay').innerText = group.name;
        document.getElementById('groupName').value = group.name;

        document.getElementById('groupBackstory').value = group.backstory || '';
        document.getElementById('groupCount').innerText = `${(group.backstory || "").length} / 1000`;

        const imgDisplay = document.getElementById('groupImageDisplay');
        const imgPlaceholder = document.getElementById('groupImagePlaceholder');
        if(group.photo) { imgDisplay.src = group.photo; imgDisplay.style.display = 'block'; imgPlaceholder.style.display = 'none'; }
        else { imgDisplay.style.display = 'none'; imgPlaceholder.style.display = 'flex'; }

        this.renderGroupMembers();
        this.renderGroupSections();
        this.renderSidebar();
    }

    renderGroupMembers() {
        const container = document.getElementById('groupMembers'); container.innerHTML = '';
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        group.members.forEach(memberId => {
            const nomi = this.data.nomis.find(n => n.id === memberId);
            if(nomi) {
                const chip = document.createElement('div'); chip.className = 'member-chip';
                const imgSrc = nomi.photo || '';
                chip.innerHTML = `<img src="${imgSrc}" onerror="this.style.display='none'"> <span>${nomi.name}</span><span class="member-remove" onclick="app.removeMember(${nomi.id})">×</span>`;
                container.appendChild(chip);
            }
        });
    }

    toggleMemberDropdown() {
        const dropdown = document.getElementById('memberOptions');
        if (dropdown.classList.contains('open')) { dropdown.classList.remove('open'); return; }
        dropdown.innerHTML = '';
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        let hasOptions = false;
        this.data.nomis.forEach(n => {
            if(!group.members.includes(n.id)) {
                hasOptions = true;
                const div = document.createElement('div'); div.className = 'custom-option';
                const imgSrc = n.photo || '';
                div.innerHTML = `<img src="${imgSrc}" onerror="this.style.display='none'"> <span>${n.name}</span>`;
                div.onclick = () => app.addMember(n.id);
                dropdown.appendChild(div);
            }
        });
        if(!hasOptions) dropdown.innerHTML = '<div style="padding:10px; color:#666; font-size:0.9rem;">No other Nomis available.</div>';
        dropdown.classList.add('open');
    }

    addMember(id) {
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        group.members.push(id); this.saveToDB(); this.renderGroupMembers(); this.renderSidebar();
        document.getElementById('memberOptions').classList.remove('open');
    }

    removeMember(id) {
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        group.members = group.members.filter(m => m !== id); this.saveToDB(); this.renderGroupMembers(); this.renderSidebar();
    }

    addGroupSection() {
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        if(!group.custom_sections) group.custom_sections = [];
        group.custom_sections.push({ id: Date.now(), title: "New Section", content: "" }); this.saveToDB(); this.renderGroupSections();
    }

    renderGroupSections() {
        const container = document.getElementById('groupSectionsContainer');
        while(container.children.length > 1) { container.removeChild(container.lastChild); }
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        (group.custom_sections || []).forEach(sec => {
            const div = document.createElement('div'); div.className = 'glass-card collapsed';
            div.innerHTML = `
                <div class="card-header" onclick="app.toggleCard(this.parentNode)">
                    <input type="text" value="${sec.title}" 
                        style="background:transparent; border:none; color:var(--accent); font-weight:bold; font-size:1rem;"
                        onclick="event.stopPropagation()" oninput="app.updateGroupSectionTitle(${sec.id}, this.value)">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="tool-btn del" onclick="event.stopPropagation(); app.deleteGroupSection(${sec.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                        <span class="card-arrow">▼</span>
                    </div>
                </div>
                <div class="card-body">
                    <textarea id="group_sec_${sec.id}" class="ghost-input" oninput="app.updateGroupSectionContent(${sec.id}, this.value)">${sec.content}</textarea>
                    <div class="btn-row"><button class="save-btn" onclick="app.saveCurrentGroup(true)">Save</button><button class="copy-btn" onclick="app.copyText('group_sec_${sec.id}')">Copy</button></div>
                </div>`;
            container.appendChild(div);
        });
    }
    
    updateGroupSectionTitle(id, val) { const group = this.data.groups.find(g => g.id === this.currentGroupId); const s = group.custom_sections.find(x => x.id === id); if(s) s.title = val; this.saveToDB(); }
    updateGroupSectionContent(id, val) { const group = this.data.groups.find(g => g.id === this.currentGroupId); const s = group.custom_sections.find(x => x.id === id); if(s) s.content = val; this.autoSaveGroup(); }
    deleteGroupSection(id) { if(!confirm("Delete section?")) return; const group = this.data.groups.find(g => g.id === this.currentGroupId); group.custom_sections = group.custom_sections.filter(x => x.id !== id); this.saveToDB(); this.renderGroupSections(); }

    autoSaveGroup() { this.saveCurrentGroup(false); }
    saveCurrentGroup(showToast = false) {
        const group = this.data.groups.find(g => g.id === this.currentGroupId);
        group.name = document.getElementById('groupName').value;
        const bs = document.getElementById('groupBackstory'); group.backstory = bs.value;
        document.getElementById('groupCount').innerText = `${bs.value.length} / 1000`;
        this.saveToDB().then(() => { if(showToast) this.showToast("Group Saved!"); });
        this.renderSidebar();
    }

    renderGallery() {
        const grid = document.getElementById('nomiGallery'); grid.innerHTML = '';
        const term = document.getElementById('searchInput').value.toLowerCase();
        const filtered = this.data.nomis.filter(n => (n.name + JSON.stringify(n.data)).toLowerCase().includes(term));
        filtered.forEach(n => {
            const html = `<div class="nomi-card" onclick="app.editNomi(${n.id})"><img src="${n.photo || ''}" loading="lazy"><div class="nomi-card-info">${n.name}</div></div>`;
            grid.insertAdjacentHTML('beforeend', html);
        });
    }
    renderSidebar() {
        const list = document.getElementById('groupList'); list.innerHTML = '';
        this.data.groups.forEach(g => {
            const imgSrc = g.photo || '';
            const html = `
                <div class="group-item ${g.id === this.currentGroupId ? 'active' : ''}" onclick="app.editGroup(${g.id}); app.toggleSidebar(false)">
                    <div class="group-info"><img class="group-avatar" src="${imgSrc}" onerror="this.style.display='none'"><span class="group-name">${g.name}</span></div>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
        });
    }
    deleteNomi() { if(confirm("Delete permanently?")) { this.data.nomis = this.data.nomis.filter(n => n.id !== this.currentNomiId); this.saveToDB(); this.goHome(); } }
    deleteGroup() { if(confirm("Delete Group?")) { this.data.groups = this.data.groups.filter(g => g.id !== this.currentGroupId); this.saveToDB(); this.goHome(); } }

    exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data)); const anchor = document.createElement('a'); anchor.setAttribute("href", dataStr); anchor.setAttribute("download", "nomi_backup.json"); document.body.appendChild(anchor); anchor.click(); anchor.remove(); }
    importData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const json = JSON.parse(e.target.result); if(confirm("Overwrite data?")) { this.data = json; this.saveToDB().then(() => { alert("Done!"); location.reload(); }); } } catch(err) { alert("Invalid JSON"); } }; reader.readAsText(file); }
    
    processImage(file, maxWidth, callback) { if(!file) return; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const scale = maxWidth / img.width; canvas.width = maxWidth; canvas.height = img.height * scale; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); callback(canvas.toDataURL('image/jpeg', 0.85)); }; }; reader.readAsDataURL(file); }
    
    copyText(id) { const el = document.getElementById(id); navigator.clipboard.writeText(el.value).then(() => this.showToast("Copied!")); }
    showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
    openLightbox(src) { if(!src) return; document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').classList.add('active'); }
    closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }
}

const app = new NomiApp(); window.onload = () => app.init();
</script>
</body>
</html>



