<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nomi Manager</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nomi Manager">
    <link rel="apple-touch-icon" href="logo.svg">
    <meta name="theme-color" content="#0f0f13">

    <style>
        :root {
            --bg-body: #0f0f13;
            --bg-card: #222226;
            --glass-bg: rgba(30, 30, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --bg-input: #121214;
            --accent: #d946ef;
            --accent-dim: rgba(217, 70, 239, 0.05);
            --accent-hover: #c026d3;
            --success: #10b981;
            --error: #ef4444;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --border: #3f3f46;
            --app-font: 'Inter', system-ui, -apple-system, sans-serif;
            --fixed-font: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html { overflow-y: scroll; }

        body {
            font-family: var(--app-font);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* --- BACKGROUND --- */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f0f13 0%, #1a1a20 100%); z-index: 0; pointer-events: none;
        }
        body::after {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 0%, var(--accent-dim) 0%, transparent 60%); z-index: 0; pointer-events: none;
        }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* FIX: New animation specifically for centered popups to prevent jumping */
        @keyframes popInCenter { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } 
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 
        }
        
        @keyframes slideUpFade { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }

        /* --- MAIN CONTENT --- */
        .main-content { flex-grow: 1; padding: 40px; position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; padding-bottom: 120px; max-width: 1600px; margin: 0 auto; }
        
        .hero-bg {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; background-position: center;
            filter: blur(25px) brightness(0.25);
            z-index: 0; pointer-events: none;
            transition: background-image 0.5s ease-in-out;
        }

        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; height: 50px; position: relative; z-index: 10; }
        .top-bar h2 { margin: 0; font-size: 1.8rem; font-family: var(--fixed-font); font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 10px; }
        
        .search-wrapper { position: relative; display: flex; align-items: center; justify-content: flex-end; }
        .search-icon-btn { background: var(--bg-card); border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: 0.2s; z-index: 2; backdrop-filter: blur(5px); }
        
        @media (hover: hover) {
            .search-icon-btn:hover { border-color: var(--accent); color: var(--accent); }
            .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
            .fab-btn:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }
            .sync-pill:hover { border-color: var(--accent); color: var(--accent); }
            .nomi-card:hover { transform: translateY(-7px) scale(1.02); border-color: var(--accent); box-shadow: 0 10px 25px var(--accent-dim); }
            .nomi-card:hover .fav-btn { opacity: 1; }
            .fav-btn.active:hover { color: #ef4444; }
            .fav-btn:hover { transform: scale(1.1); color: white; }
            .profile-avatar-wrapper:hover { transform: scale(1.05); border-color: var(--accent); }
            .prompt-card:hover { border: 2px solid var(--accent); }
            .prompt-card:hover .ghost-overlay { opacity: 1; pointer-events: auto; }
            .tool-btn:hover { background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
            .tool-btn.star:hover { color: #fbbf24; }
            .tool-btn.del:hover { color: #ef4444; }
            .back-btn:hover { color: var(--accent); }
            .icon-btn:hover { color: var(--accent); transform: scale(1.1); }
            .btn-upload:hover { filter: brightness(1.1); }
            .copy-btn:hover { background: var(--accent); border-color: var(--accent); }
            .save-btn:hover { background: #059669; color: white; }
            .btn-secondary:hover { background-color: var(--bg-card); color: var(--text-main); }
            .btn-add-section:hover { background-color: rgba(16, 185, 129, 0.1); border-color: #34d399; color: #34d399; transform: translateY(-2px); }
            .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }
            .tool-text-btn:hover { color: var(--text-main); border-color: var(--text-muted); }
            .glass-card:hover { border-color: rgba(255,255,255,0.2); }
            .add-trait-btn:hover { background: var(--accent); }
            .custom-option:hover { background: var(--bg-input); color: var(--accent); }
            .member-remove:hover { color: var(--error); }
            .lightbox-close:hover { color: var(--accent); }
            .settings-close:hover { color: var(--accent); }
            .theme-opt:hover { transform: scale(1.05); }
            .image-option-btn:hover { background: var(--accent); border-color: var(--accent); }
        }

        .search-input { width: 0; padding: 0; border: none; background: var(--glass-bg); backdrop-filter: blur(10px); color: white; border-radius: 20px; transition: 0.3s ease-in-out; opacity: 0; position: absolute; right: 20px; height: 40px; }
        .search-input.active { width: 300px; padding: 0 15px; border: 1px solid var(--border); opacity: 1; right: 50px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        
        .section-divider { display: flex; align-items: center; gap: 15px; margin: 40px 0 20px 0; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .section-divider::after { content: ''; flex-grow: 1; height: 1px; background: var(--border); }
        .btn-action { background-color: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        
        .fab-group { position: fixed; bottom: 30px; right: 30px; z-index: 9000; display: flex; gap: 15px; align-items: flex-end; }
        
        .fab-btn {
            width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7); backdrop-filter: blur(10px); cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .fab-btn:active { transform: scale(0.95); }

        .sync-pill {
            height: 50px; border-radius: 25px; background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-main); display: flex; align-items: center; justify-content: flex-end;
            padding: 0 13px; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            cursor: pointer; transition: all 0.3s ease; overflow: hidden; width: 50px;
        }
        .sync-pill.expanded { width: auto; padding-left: 20px; padding-right: 15px; }
        .sync-text { white-space: nowrap; font-size: 0.9rem; font-weight: bold; opacity: 0; transition: opacity 0.2s; display: none; }
        .sync-pill.expanded .sync-text { opacity: 1; display: block; }
        .sync-pill svg.spin { animation: spin 1s linear infinite; }

        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding-bottom: 20px; position: relative; z-index: 10; }
        .nomi-card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; 
            overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; 
            display: flex; flex-direction: column; cursor: pointer; position: relative; 
        }
        .nomi-card.pop-in { animation: popIn 0.4s ease-out forwards; }
        .nomi-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; display: block; background: #000; }
        .nomi-card-info { padding: 12px; text-align: center; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem;}
        .fav-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; color: #ccc; cursor: pointer; backdrop-filter: blur(4px); opacity: 0; transition: 0.2s; }
        @media (hover: none) { .fav-btn { opacity: 1; } }
        .fav-btn.active { color: #ef4444; opacity: 1; }

        .profile-header-card {
            margin-bottom: 30px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 30px; display: flex; align-items: center; gap: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUpFade 0.5s ease-out; position: relative; z-index: 30; 
        }

        .profile-avatar-wrapper {
            position: relative; width: 140px; height: 140px; flex-shrink: 0; border-radius: 50%; border: 2px solid var(--border);
            background: #000; cursor: pointer; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.2s, border-color 0.2s;
        }
        .profile-avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .profile-avatar-wrapper .placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: #666; font-weight: bold; background: #222; }

        .profile-info { flex-grow: 1; min-width: 0; }
        .profile-name-row { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; min-height: 50px; }
        .profile-name { font-size: 2.5rem; font-weight: 900; color: #fff; letter-spacing: -1px; line-height: 1.1; }
        .profile-name-input { background: transparent; border: none; border-bottom: 2px solid var(--accent); color: #fff; font-size: 2.5rem; font-weight: 900; width: 100%; padding: 0; outline:none; font-family: inherit; }
        .name-edit-container { display: none; width: 100%; align-items: center; gap: 15px; }
        .name-edit-container.active { display: flex; }

        .masonry-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; position: relative; z-index: 10; align-items: start; animation: slideUpFade 0.6s ease-out; }
        @media (max-width: 1200px) { .masonry-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 800px) { .masonry-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .prompt-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative; transition: border-color 0.2s; width: 100%; cursor: pointer; }
        .prompt-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; display: block; }
        .prompt-card.selected { border: 3px solid var(--accent); }
        .prompt-card.selected::after { content: '✓'; position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: var(--accent); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        .ghost-overlay { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); padding: 5px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 5; }
        
        /* PC IN-PLACE PROMPT EDITOR */
        .prompt-popup-inplace {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; flex-direction: column; padding: 15px; z-index: 20;
            animation: fadeIn 0.2s ease-out;
        }
        .prompt-popup-inplace textarea {
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff;
            flex-grow: 1; margin-bottom: 10px; padding: 10px; font-family: inherit;
            border-radius: 6px; resize: none; font-size: 0.9rem;
        }
        .prompt-popup-inplace textarea:focus { outline: none; border-color: var(--accent); }
        
        /* Logic to show In-Place Editor on PC when 'editing' class is present */
        .prompt-card.editing .prompt-popup-inplace { display: flex; }
        .prompt-card.editing .ghost-overlay { display: none; }
        
        /* GLOBAL MOBILE PROMPT POPUP (Fixed Animation) */
        .global-prompt-popup { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90vw; max-width: 400px; height: auto; min-height: 300px; max-height: 80vh; 
            background: rgba(20,20,25,0.95); backdrop-filter: blur(15px); 
            display: none; flex-direction: column; padding: 20px; justify-content: center; 
            z-index: 100000; border: 1px solid var(--accent); 
            box-shadow: 0 10px 50px rgba(0,0,0,0.9); border-radius: 12px;
            animation: popInCenter 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
        }
        .global-prompt-popup.active { display: flex; }
        .global-prompt-popup textarea { background: rgba(0,0,0,0.3); border: 1px solid #444; color: #fff; flex-grow: 1; max-height: 60%; margin-bottom: 10px; padding: 10px; font-family: inherit; border-radius: 8px; resize: none; }
        .global-prompt-popup textarea:focus { border-color: var(--accent); outline: none; }
        
        .tool-btn { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); width: 34px; height: 34px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .tool-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; margin-bottom: 20px; position: relative; z-index: 10; font-weight: bold; }
        .icon-btn { background: transparent; border: none; width: 32px; height: 32px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transition: 0.2s; padding:0; flex-shrink: 0;}
        .icon-btn.save { color: var(--success); }
        .btn-upload { background-color: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; transition: 0.2s; }
        .btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
        .copy-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold;}
        .save-btn { background: #065f46; color: #a7f3d0; border: 1px solid #047857; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }
        .btn-secondary { background-color: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; width:100%; text-align:center; font-family: inherit; margin-top: 20px;}
        .btn-add-section { background-color: transparent; color: #10b981; border: 1px solid #10b981; font-weight: 800; padding: 15px; width: 100%; margin-top: 25px; cursor: pointer; border-radius: 8px; font-family: inherit; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; position: relative; z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .delete-btn { color: var(--error); background: transparent; border: 1px solid var(--error); padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 40px; margin-bottom: 40px; position:relative; z-index:10; font-family: inherit; font-weight: bold; display: block; text-align: center; font-size: 1rem; }
        
        .global-tools { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        .tools-left { display: flex; gap: 10px; }
        .tools-right { display: flex; gap: 10px; }
        .tool-text-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 4px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}

        .form-column-container { display: flex; flex-direction: column; gap: 20px; width: 100%; margin: 0 auto; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 0; display: flex; flex-direction: column; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-bottom:0; overflow:hidden;}
        .glass-card.collapsed .card-body { display: none; }
        .glass-card.collapsed { opacity: 0.8; }
        .glass-card.over-limit { border-color: var(--error); }
        .glass-card.dragging { opacity: 0.4; border: 2px dashed var(--accent); transform: scale(0.98); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; cursor: pointer; padding: 20px; user-select: none; }
        .card-header-left { display: flex; align-items: center; gap: 10px; flex-grow: 1; pointer-events: none; }
        .card-header-left * { pointer-events: auto; }
        .card-controls { display: flex; align-items: center; gap: 8px; }
        
        .drag-handle { cursor: grab; opacity: 0.5; padding: 5px; transition: 0.2s; touch-action: none; display: none; }
        @media (hover: hover) { .drag-handle:hover { opacity: 1; color: var(--text-main); } }
        .drag-handle:active { cursor: grabbing; }
        
        .card-arrow { transition: 0.3s; }
        .collapsed .card-arrow { transform: rotate(-90deg); }
        .card-body { display: block; border-top: 1px solid rgba(255,255,255,0.1); padding: 20px; padding-top: 10px; margin-top: 0;}
        textarea.ghost-input { background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.1); color: #eee; padding: 10px 0; width: 100%; min-height: 100px; resize: vertical; font-family: inherit; font-size: 0.95rem; line-height: 1.6; transition: 0.2s; border-radius: 0; }
        textarea.ghost-input:focus { outline: none; border-bottom-color: var(--accent); background: rgba(255,255,255,0.02); }
        .tab-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; justify-content: space-between; align-items: center; position: relative; z-index: 10; }
        .tab-left { display: flex; gap: 20px; }
        .tab-btn { background: none; border: none; color: var(--text-muted); font-size: 1.1rem; font-weight: bold; cursor: pointer; padding: 5px 10px; font-family: inherit; }
        .tab-btn.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }
        
        .traits-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .traits-header { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #ccc; }
        .add-trait-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.7rem; }
        #traitInput { display: none; background:transparent; border:none; color:white; border-bottom:1px solid #ccc; width:100%; padding:5px; margin-top:5px; font-family: inherit;}
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag { background: var(--accent); color: #000; font-weight:600; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; }

        .custom-select-wrapper { position: relative; display: inline-block; margin-top: 10px; z-index: 9999; }
        .custom-select-trigger { background: #27272a; color: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .custom-options { position: absolute; top: 100%; left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; display: none; z-index: 10000; max-height: 300px; overflow-y: auto; width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.9); }
        .custom-options.open { display: block; }
        .custom-option { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid #333; }
        .custom-option img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        
        .member-list-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 5px;}
        .member-chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 5px 10px 5px 5px; display: flex; align-items: center; gap: 8px; backdrop-filter:blur(5px); }
        .member-chip img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .member-remove { cursor: pointer; color: #ccc; font-weight: bold; margin-left: 5px;}

        .lightbox { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; animation: popIn 0.3s ease; }
        .lightbox.active { display: flex; }
        .lightbox-content { max-width: 95%; max-height: 95%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid #333; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 9000; font-weight: bold; }
        .toast.show { opacity: 1; }
        
        .settings-modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
        .settings-modal.active { display: flex; }
        .settings-panel { background: var(--bg-card); border: 1px solid var(--border); width: 500px; max-width: 90%; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 90vh; animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; flex-shrink: 0;}
        .settings-header h2 { margin: 0; color: var(--accent); }
        .settings-close { font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .settings-section { margin-bottom: 25px; }
        .settings-label { display: block; font-weight: bold; margin-bottom: 10px; color: var(--text-main); font-size: 0.9rem; }
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .theme-opt { height: 40px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; position: relative; }
        .select-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; cursor: pointer; font-family: inherit; }
        .input-text { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; font-family: inherit; }
        
        .image-option-modal { display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .image-option-modal.active { display: flex; }
        .image-option-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; gap: 15px; display: flex; flex-direction: column; width: 300px; animation: popIn 0.3s; }
        .image-option-btn { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }

        .crop-modal { display: none; position: fixed; z-index: 7000; top: 0; left: 0; width: 100%; height: 100%; background: #000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-modal.active { display: flex; }
        .crop-container { width: 400px; height: 400px; border: 2px solid #333; position: relative; overflow: hidden; background: #111; cursor: grab; max-width: 100%; }
        .crop-container:active { cursor: grabbing; }
        .crop-image { position: absolute; top:0; left:0; transform-origin: 0 0; }
        .circle-guide { pointer-events: none; position: absolute; top: 0; left: 0; width: 400px; height: 400px; border: 2px solid var(--accent); border-radius: 50%; box-shadow: 0 0 0 200px rgba(0,0,0,0.7); }

        .crop-controls { margin-top: 20px; display: flex; gap: 20px; align-items: center; width: 400px; max-width: 90%; }
        .crop-slider { flex-grow: 1; }
        .crop-btns { margin-top: 20px; display: flex; gap: 10px; }

        /* --- RESPONSIVE --- */
       @media (max-width: 768px) {
        .main-content { padding: 15px; width: 100%; padding-bottom: 50px; }
        .hero-bg { left: 0; }
        .mobile-menu-btn { display: flex; align-items: center; justify-content: center; }
        .header-section { flex-direction: column; align-items: center; text-align: center; }
        .identity-controls { width: 100%; }
    
        /* --- CENTERING FIX STARTS --- */
        
        /* 1. Force the info container to span full width so centering works relative to screen */
        .profile-info {
            width: 100%;
        }
    
        /* 2. Use Flexbox to space items: [Spacer] [Name] [Button] */
        .profile-name-row { 
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            position: relative;
            margin-bottom: 15px; /* Ensure space below name */
        }
        
        /* 3. Invisible Spacer on the LEFT to balance the Button on the RIGHT */
        .profile-name-row::before {
            content: '';
            width: 32px; /* Matches the width of the .icon-btn (pencil) */
            flex-shrink: 0;
            display: block;
        }
    
        /* 4. Name takes up all remaining space and centers itself */
        .profile-name {
            flex-grow: 1;
            text-align: center;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 5px;
        }
        
        /* 5. Button sits naturally in the flow on the right (No Absolute Positioning) */
        .profile-name-row .icon-btn {
            position: static;
            transform: none;
            flex-shrink: 0;
        }
        /* --- CENTERING FIX ENDS --- */
    
        .traits-header { justify-content: center; }
        .traits-row { justify-content: center; }
        .tag-container { justify-content: center; }
        .member-list-container { justify-content: center; }
        .custom-select-wrapper { display: flex; justify-content: center; width: 100%; }
        .search-input.active { width: 200px; right: 50px; }
        .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .tab-nav { 
            flex-direction: column; 
            align-items: stretch; 
            gap: 15px; 
            margin-bottom: 25px;
        }
        
        .tab-left {
            width: 100%;
            justify-content: flex-start;
        }

        #galleryActions {
            width: 100%;
            justify-content: flex-end;
        }
        .settings-panel, .chat-panel { width: 100%; height: 100%; border-radius: 0; max-width: 100%;}
        .chat-panel-content { overflow-y: auto; flex-grow: 1; }
        .crop-container { width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; }
        .circle-guide { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
        .crop-controls { width: 90vw; }
        .delete-btn { width: 100%; float: none; margin-top: 20px; padding: 15px; font-size: 1.1rem; }
        
        .profile-header-card { flex-direction: column; text-align: center; }
        
        .fab-group { bottom: 20px; right: 20px; }
        
        .global-tools { width: 100%; justify-content: space-between; }
    }
        
        @media (max-width: 480px) {
            .masonry-grid { grid-template-columns: repeat(2, 1fr); }
            /* FIX: Ensure pointer events are AUTO so buttons are clickable on mobile */
            .ghost-overlay { opacity: 1 !important; pointer-events: auto !important; background: rgba(0,0,0,0.4); bottom: 0; top: auto; right: 0; left: 0; justify-content: center; padding: 5px 0; border-radius: 0; border: none; }
            .tool-btn { width: 24px; height: 24px; }
            .tool-btn svg { width: 14px; height: 14px; }
        }
        /* --- PC OPTIMIZATION --- */
        @media (min-width: 1024px) {
            .form-column-container {
                display: grid;
                grid-template-columns: 1fr 1fr; /* 2 Columns */
                gap: 20px;
                align-items: start;
            }

            /* Make Backstory always take full width for better reading */
            #card_backstory, #card_group_backstory {
                grid-column: 1 / -1;
            }
        }
    </style>
</head>
<body>

<div id="lightbox" class="lightbox" onclick="app.closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightboxImg">
</div>

<div class="global-prompt-popup" id="globalPromptPopup" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <strong style="color:var(--accent);">Edit Prompt</strong>
        <span style="cursor:pointer; font-size:1.2rem;" onclick="app.closePromptPopup()">✕</span>
    </div>
    <textarea id="globalPromptInput" placeholder="Enter prompt here..."></textarea>
    <div class="btn-row">
        <button class="save-btn" onclick="app.savePromptManual()">Save</button>
        <button class="copy-btn" onclick="app.copyText('globalPromptInput')">Copy</button>
    </div>
</div>

<div id="cropModal" class="crop-modal">
    <div class="crop-container" id="cropContainer" 
         onmousedown="cropper.startDrag(event)" 
         ontouchstart="cropper.startDrag(event)"
         onwheel="cropper.handleWheel(event)">
        
        <img id="cropTarget" class="crop-image" draggable="false">
        <div id="cropGuide" class="circle-guide"></div>
    </div>
    <div class="crop-controls">
        <span>Zoom:</span>
        <input type="range" min="0.1" max="1.5" step="0.01" value="1" class="crop-slider" id="cropZoom" oninput="cropper.setZoom(this.value)">
    </div>
    <div class="crop-btns">
        <button class="btn-secondary" style="margin:0;" onclick="cropper.cancel()">Cancel</button>
        <button class="save-btn" onclick="cropper.save()">Set</button>
    </div>
</div>

<div id="imageOptionModal" class="image-option-modal" onclick="if(event.target===this) this.classList.remove('active')">
    <div class="image-option-panel">
        <h3 style="margin:0;color:var(--accent)">Set Image As...</h3>
        <button class="image-option-btn" onclick="app.confirmImageSet('profile')">Profile Picture</button>
        <button class="btn-secondary" onclick="document.getElementById('imageOptionModal').classList.remove('active')">Cancel</button>
    </div>
</div>

<div id="settingsModal" class="settings-modal" onclick="if(event.target === this) app.toggleSettings()">
    <div class="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <span class="settings-close" onclick="app.toggleSettings()">×</span>
        </div>
        <div class="settings-section">
            <span class="settings-label">Nomi.ai API Key</span>
            <input type="password" id="apiKeyInput" class="input-text" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" oninput="app.saveSetting('apiKey', this.value)">
            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Found in Nomi App > Profile > Integrations</div>
        </div>
        <div class="settings-section">
            <span class="settings-label">Color Theme</span>
            <div class="theme-grid">
                <div class="theme-opt" style="background:#d946ef;" onclick="app.setTheme('cyber')"></div>
                <div class="theme-opt" style="background:#22c55e;" onclick="app.setTheme('matrix')"></div>
                <div class="theme-opt" style="background:#eab308;" onclick="app.setTheme('royal')"></div>
                <div class="theme-opt" style="background:#ef4444;" onclick="app.setTheme('crimson')"></div>
                <div class="theme-opt" style="background:#06b6d4;" onclick="app.setTheme('ice')"></div>
            </div>
        </div>
        
        <div class="settings-section">
            <span class="settings-label">Start-Up View</span>
            <select id="startUpSelect" class="select-input" onchange="app.saveSetting('startView', this.value)">
                <option value="home">Dashboard</option>
                <option value="last">Last Visited Page</option>
            </select>
        </div>
        <div class="settings-section">
            <span class="settings-label">Data Management</span>
            <div style="display:flex; gap:10px;">
                <button class="btn-secondary" onclick="app.exportData()" style="display:flex; align-items:center; gap:8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Backup
                </button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()" style="display:flex; align-items:center; gap:8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Restore
                </button>
            </div>
        </div>
    </div>
</div>

<div class="fab-group">
    <div class="sync-pill" id="syncBtn" onclick="app.syncFromApi()">
        <span id="syncText" class="sync-text">Syncing...</span>
        <svg id="syncIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
    </div>
    <div class="fab-btn" onclick="app.toggleSettings()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </div>
</div>

<div class="main-content">
    <div id="heroBackground" class="hero-bg"></div>

    <div id="viewHome">
        <div class="top-bar">
            <h2>
                <svg class="app-logo" style="width:28px;height:28px;" viewBox="0 0 100 100"><rect x="5" y="5" width="90" height="90" rx="20" ry="20" fill="var(--static-logo)"/><text x="50" y="75" font-size="70" font-family="Arial" font-weight="bold" fill="#fff" text-anchor="middle">N</text></svg>
                Nomi Manager
            </h2>
            <div class="search-wrapper">
                <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="app.renderGallery()">
                <button class="search-icon-btn" onclick="document.getElementById('searchInput').classList.toggle('active'); document.getElementById('searchInput').focus();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </div>
        </div>

        <div class="section-divider">
            <span>My Nomis</span>
            <button class="btn-action" style="font-size:0.8rem; padding: 5px 10px;" onclick="app.createNomi()">+ Create</button>
        </div>
        <div class="gallery-grid" id="nomiGallery"></div>
        
        <div class="section-divider">
            <span>Groups</span>
            <button class="btn-action" style="font-size:0.8rem; padding: 5px 10px;" onclick="app.createGroup()">+ Create</button>
        </div>
        <div class="gallery-grid" id="groupGallery"></div>
    </div>

    <div id="viewNomi" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:relative; z-index:20;">
            <div class="back-btn" onclick="app.goHome()" style="margin:0; background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:20px; backdrop-filter:blur(5px);">← Dashboard</div>
        </div>
        
        <div class="profile-header-card">
            <div class="profile-avatar-wrapper clickable" onclick="document.getElementById('nomiPhotoInput').click()">
                <img id="nomiImageDisplay" src="" style="display:none;">
                <div id="nomiImagePlaceholder" class="placeholder">?</div>
                <input type="file" id="nomiPhotoInput" accept="image/*" style="display:none;" onchange="cropper.init(this, 'nomi')">
            </div>
            <div class="profile-info">
                <div class="profile-name-row">
                    <div id="nomiNameDisplay" class="profile-name">Name</div>
                    <button id="nomiEditBtn" class="icon-btn" onclick="app.toggleNameEdit('nomi', true)" style="color:rgba(255,255,255,0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    <div id="nomiNameEdit" class="name-edit-container">
                        <input type="text" class="profile-name-input" id="nomiName" placeholder="Name">
                        <button class="icon-btn save" onclick="app.saveName('nomi')"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                    </div>
                </div>
                <div class="traits-row">
                    <span class="traits-header">Traits <button class="add-trait-btn" onclick="document.getElementById('traitInput').style.display='block';document.getElementById('traitInput').focus()">+</button></span>
                    <input type="text" id="traitInput" placeholder="Add..." maxlength="20" style="background:rgba(0,0,0,0.5); border:1px solid #555; color:white; border-radius:4px; padding:2px 5px; width:80px; display:none;">
                    <div class="tag-container" id="traitContainer" style="margin:0;"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-nav">
            <div class="tab-left">
                <button class="tab-btn active" id="tabProfile" onclick="app.switchTab('profile')">Profile Data</button>
                <button class="tab-btn" id="tabGallery" onclick="app.switchTab('gallery')">Gallery</button>
            </div>
            
            <div class="global-tools" id="expandTools">
                <div class="tools-left">
                    <button class="tool-btn" onclick="app.copyAllSections(false)" title="Copy All Sections"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></button>
                    <button class="tool-btn" id="btnSortNomi" onclick="app.toggleReorderMode()" title="Sort / Reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></button>
                    <button class="tool-btn" id="btnResetNomi" onclick="app.resetSort()" title="Reset Order" style="visibility:hidden;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
                </div>
                <div class="tools-right">
                    <button class="tool-text-btn" onclick="app.setAllSections(false)">▼ Expand All</button>
                    <button class="tool-text-btn" onclick="app.setAllSections(true)">▲ Collapse All</button>
                </div>
            </div>

            <div id="galleryActions" style="display:none; align-items: center; gap: 10px;">
                <button class="tool-btn" id="btnBatchMode" title="Batch Select Mode" onclick="app.toggleBatchMode()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                <button class="tool-btn del" id="btnBatchDelete" title="Delete Selected" style="display:none;" onclick="app.deleteBatchImages()"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                
                <button class="btn-upload" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);" onclick="app.pasteGalleryImage()">Paste</button>
                
                <button class="btn-upload" onclick="document.getElementById('galleryUpload').click()">Upload</button>
                <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none" onchange="app.addGalleryImages(this)">
            </div>
        </div>

        <div id="contentProfile">
            <div class="form-column-container" id="profileGrid"></div>
            <button class="btn-add-section" onclick="app.addNomiSection()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Custom Section
            </button>
            <button class="delete-btn" onclick="app.deleteNomi()">Delete Nomi</button>
        </div>
        
        <div id="contentGallery" style="display:none;">
            <div class="masonry-grid" id="promptGalleryGrid"></div>
        </div>
    </div>

    <div id="viewGroup" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:relative; z-index:20;">
            <div class="back-btn" onclick="app.goHome()" style="margin:0; background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:20px; backdrop-filter:blur(5px);">← Dashboard</div>
        </div>
        
        <div class="profile-header-card">
            <div class="profile-avatar-wrapper clickable" onclick="document.getElementById('groupPhotoInput').click()">
                <img id="groupImageDisplay" src="" style="display:none;">
                <div id="groupImagePlaceholder" class="placeholder">G</div>
                <input type="file" id="groupPhotoInput" accept="image/*" style="display:none;" onchange="cropper.init(this, 'group')">
            </div>
            <div class="profile-info">
                <div class="profile-name-row">
                    <div id="groupNameDisplay" class="profile-name">Group Name</div>
                    <button id="groupEditBtn" class="icon-btn" onclick="app.toggleNameEdit('group', true)" style="color:rgba(255,255,255,0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    <div id="groupNameEdit" class="name-edit-container">
                        <input type="text" class="profile-name-input" id="groupName" placeholder="Group Name">
                        <button class="icon-btn save" onclick="app.saveName('group')"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                    </div>
                </div>
                <div>
                    <div id="groupMembers" class="member-list-container" style="margin:0;"></div>
                    <div class="custom-select-wrapper" id="memberDropdownWrapper" style="margin-top:5px;">
                        <div class="custom-select-trigger" onclick="app.toggleMemberDropdown()" style="background:rgba(255,255,255,0.1); border:none; padding:4px 10px; font-size:0.8rem;">+ Member</div>
                        <div class="custom-options" id="memberOptions"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-nav">
             <div class="global-tools" style="margin-left:auto;">
                 <div class="tools-left">
                    <button class="tool-btn" onclick="app.copyAllSections(true)" title="Copy All Sections"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></button>
                    <button class="tool-btn" id="btnSortGroup" onclick="app.toggleReorderMode()" title="Sort / Reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></button>
                    <button class="tool-btn" id="btnResetGroup" onclick="app.resetSort()" title="Reset Order" style="visibility:hidden;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
                 </div>
                 <div class="tools-right">
                    <button class="tool-text-btn" onclick="app.setAllSections(false)">▼ Expand All</button>
                    <button class="tool-text-btn" onclick="app.setAllSections(true)">▲ Collapse All</button>
                 </div>
            </div>
        </div>
        
        <div id="groupSectionsContainer" class="form-column-container"></div>
        
        <button class="btn-add-section" onclick="app.addGroupSection()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Custom Section
        </button>
        <button class="delete-btn" onclick="app.deleteGroup()">Delete Group</button>
    </div>

</div>

<input type="file" id="importFile" style="display:none" onchange="app.importData(this)">
<input type="file" id="bannerUpload" style="display:none" accept="image/*" onchange="cropper.init(this, 'banner')">

<div class="toast" id="toast">Saved Successfully!</div>

<script>
// REGISTER SERVICE WORKER
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker failed', err));
    });
}

/** NOMI MANAGER v3.5 **/

const DB_NAME = 'NomiArchDB_v22';
const DB_VERSION = 1;

const DEFAULT_SECTIONS = [
    { id: 'backstory', label: 'Backstory', limit: 2000 },
    { id: 'inclination', label: 'Inclination', limit: 150 },
    { id: 'current_roleplay', label: 'Current Roleplay', limit: 750 },
    { id: 'your_appearance', label: 'Your Appearance', limit: 200 },
    { id: 'nomi_appearance', label: 'Nomi\'s Appearance', limit: 500 },
    { id: 'appearance_tendencies', label: 'Appearance Tendencies', limit: 200 },
    { id: 'nicknames', label: 'Nicknames', limit: 250 },
    { id: 'preferences', label: 'Preferences', limit: 500 },
    { id: 'desires', label: 'Desires', limit: 500 },
    { id: 'boundaries', label: 'Boundaries', limit: 500 }
];

const THEMES = {
    cyber: { accent: '#d946ef', hover: '#c026d3', userBg: '#3f3f46', nomiBg: '#27272a' },
    matrix: { accent: '#22c55e', hover: '#16a34a', userBg: '#14532d', nomiBg: '#052e16' },
    royal: { accent: '#eab308', hover: '#ca8a04', userBg: '#422006', nomiBg: '#3f3f46' },
    crimson: { accent: '#ef4444', hover: '#dc2626', userBg: '#450a0a', nomiBg: '#3f3f46' },
    ice: { accent: '#06b6d4', hover: '#0891b2', userBg: '#0e7490', nomiBg: '#164e63' }
};

const cropper = {
    active: false, img: null, scale: 1, posX: 0, posY: 0, isDragging: false, startX: 0, startY: 0, targetType: null, tempUrl: null,
    
    init(input, type) { 
        if(!input.files[0]) return; 
        this.targetType = type; 
        const reader = new FileReader(); 
        reader.onload = (e) => { this.openCropModal(e.target.result); }; 
        reader.readAsDataURL(input.files[0]); 
    },

    initFromUrl(url, type) { this.targetType = type; this.openCropModal(url); },

    openCropModal(src) { 
        // 1. Show modal first to get dimensions
        document.getElementById('cropModal').classList.add('active'); 

        const img = document.getElementById('cropTarget'); 
        img.src = src; 
        
        img.onload = () => { 
            const container = document.getElementById('cropContainer');
            const cw = container.offsetWidth;
            const ch = container.offsetHeight;
            const iw = img.naturalWidth;
            const ih = img.naturalHeight;

            // 2. Calculate "Perfect Fit" scale
            this.scale = Math.max(cw / iw, ch / ih);
            
            // 3. Center the image
            this.posX = (cw - (iw * this.scale)) / 2;
            this.posY = (ch - (ih * this.scale)) / 2;

            this.updateTransform(); 
            
            // Sync slider
            const slider = document.getElementById('cropZoom');
            slider.value = this.scale; 
        } 
    },

    setZoom(val) { 
        const oldScale = this.scale;
        this.scale = parseFloat(val); 
        const container = document.getElementById('cropContainer');
        
        const cx = container.offsetWidth / 2;
        const cy = container.offsetHeight / 2;
        
        const centerX = (cx - this.posX) / oldScale;
        const centerY = (cy - this.posY) / oldScale;
        
        this.posX = cx - (centerX * this.scale);
        this.posY = cy - (centerY * this.scale);
        
        this.updateTransform(); 
    },

    handleWheel(e) {
        e.preventDefault();
        const slider = document.getElementById('cropZoom');
        
        // REDUCED SENSITIVITY: Changed 0.05 to 0.02 for smoother control
        const delta = -Math.sign(e.deltaY) * 0.02; 
        let newScale = this.scale + delta;

        // Respect limits
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        newScale = Math.max(min, Math.min(newScale, max));

        slider.value = newScale;
        this.setZoom(newScale);
    },

    startDrag(e) { 
        e.preventDefault(); 
        this.isDragging = true; 
        const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
        const clientY = e.touches ? e.touches[0].clientY : e.clientY; 
        this.startX = clientX - this.posX; 
        this.startY = clientY - this.posY; 
        
        const moveHandler = (ev) => { 
            if(!this.isDragging) return; 
            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX; 
            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY; 
            this.posX = cx - this.startX; 
            this.posY = cy - this.startY; 
            this.updateTransform(); 
        }; 
        
        const endHandler = () => { 
            this.isDragging = false; 
            document.removeEventListener('mousemove', moveHandler); 
            document.removeEventListener('mouseup', endHandler); 
            document.removeEventListener('touchmove', moveHandler); 
            document.removeEventListener('touchend', endHandler); 
        }; 
        
        document.addEventListener('mousemove', moveHandler); 
        document.addEventListener('mouseup', endHandler); 
        document.addEventListener('touchmove', moveHandler); 
        document.addEventListener('touchend', endHandler); 
    },

    updateTransform() { 
        document.getElementById('cropTarget').style.transform = `translate(${this.posX}px, ${this.posY}px) scale(${this.scale})`; 
    },

    save() {
        const guide = document.getElementById('cropGuide');
        const img = document.getElementById('cropTarget');
        const container = document.getElementById('cropContainer');
        const guideRect = guide.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const offsetLeft = guideRect.left - containerRect.left;
        const offsetTop = guideRect.top - containerRect.top;
        const width = guideRect.width;
        const height = guideRect.height;
        
        const canvas = document.createElement('canvas'); 
        canvas.width = width; canvas.height = height; 
        const ctx = canvas.getContext('2d'); 
        
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,width,height);
        
        ctx.translate(-offsetLeft, -offsetTop);
        ctx.translate(this.posX, this.posY);
        ctx.scale(this.scale, this.scale);
        ctx.drawImage(img, 0, 0); 
        
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        
        if(this.targetType === 'nomi') app.setNomiPhoto(dataUrl);
        else if(this.targetType === 'group') app.setGroupPhoto(dataUrl);
        
        this.cancel();
    },

    cancel() { 
        document.getElementById('cropModal').classList.remove('active'); 
        const n = document.getElementById('nomiPhotoInput'); if(n) n.value=''; 
        const g = document.getElementById('groupPhotoInput'); if(g) g.value='';
    }
};

class NomiApp {
    constructor() {
        this.db = null;
        this.data = { nomis: [], groups: [], settings: { theme: 'cyber', startView: 'home', lastNomi: null, apiKey: '', lastState: null } };
        this.currentNomiId = null;
        this.currentGroupId = null;
        this.isSyncing = false;
        this.isReordering = false;
        this.touchDragItem = null;
        this.resizeDebounce = null;
        this.dragSrcEl = null;
        this.isBatchMode = false;
        this.selectedImages = new Set();
        this.currentEditingImageId = null; 
        
        // Resize listener removed to prevent keyboard from closing on mobile
    }

    async init() {
        await this.openDB();
        await this.loadData();
        this.migrateData();
        this.applyTheme(this.data.settings?.theme || 'cyber');
        this.initStartView();
        this.renderGallery();
        document.getElementById('traitInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { this.addTrait(e.target.value); e.target.value = ''; document.getElementById('traitInput').style.display='none'; } });
        document.addEventListener('click', (e) => { if(!e.target.closest('#memberDropdownWrapper')) document.getElementById('memberOptions').classList.remove('open'); });
        
        // --- ADD THIS LINE ---
        document.addEventListener('paste', (e) => this.handleGlobalPaste(e));
        // ---------------------

        document.getElementById('globalPromptInput').addEventListener('input', (e) => {
             if(this.currentEditingImageId) this.updatePrompt(this.currentEditingImageId, e.target.value);
        });

        window.addEventListener('popstate', (event) => {
            if(event.state) {
                if(event.state.view === 'home') this.goHome(false);
                else if(event.state.view === 'nomi') this.editNomi(event.state.id, false);
                else if(event.state.view === 'group') this.editGroup(event.state.id, false);
            }
        });
        history.replaceState({view: 'home'}, '', '');
    }

    // Handle Ctrl+V / Cmd+V
    handleGlobalPaste(e) {
        // Only trigger if in Nomi View AND Gallery Tab is active
        if(document.getElementById('viewNomi').style.display === 'block' && 
           document.getElementById('tabGallery').classList.contains('active')) {
            
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let found = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile();
                    this.addBlobToGallery(blob);
                    found = true;
                }
            }
            if(found) {
                e.preventDefault();
                this.showToast("Pasted from clipboard!");
            }
        }
    }

    // Handle "Paste" Button Click
    async pasteGalleryImage() {
        try {
            const items = await navigator.clipboard.read();
            let found = false;
            for (const item of items) {
                const type = item.types.find(t => t.startsWith('image/'));
                if (type) {
                    const blob = await item.getType(type);
                    this.addBlobToGallery(blob);
                    found = true;
                }
            }
            if(found) this.showToast("Pasted from clipboard!");
            else this.showToast("No image found on clipboard");
        } catch (err) {
            console.error(err);
            // Fallback for browsers (like Firefox) that block programmatic read without explicit permission
            alert("Clipboard access blocked. Please use Ctrl+V (Cmd+V) to paste directly.");
        }
    }

    // Helper to process a single blob
    addBlobToGallery(blob) {
        this.processImage(blob, 1024, (b64) => {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            if (!n.gallery) n.gallery = [];
            n.gallery.push({ id: Date.now() + Math.random(), img: b64, prompt: "" });
            this.saveToDB().then(() => this.renderPromptGallery());
        });
    }
    
    migrateData() {
        this.data.nomis.forEach(n => {
            if(n.isFavorite === undefined) n.isFavorite = false;
            if(!n.custom_sections) n.custom_sections = [];
            if(!n.sectionOrder) { n.sectionOrder = DEFAULT_SECTIONS.map(s => s.id); n.custom_sections.forEach(cs => n.sectionOrder.push(cs.id)); }
            if(!n.banner) n.banner = null;
        });
        this.data.groups.forEach(g => {
            if(!g.sectionOrder && g.custom_sections) { g.sectionOrder = ['backstory']; g.custom_sections.forEach(cs => g.sectionOrder.push(cs.id)); }
            if(!g.banner) g.banner = null;
        });
    }

    openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' }); };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e);
        });
    }

    saveToDB() {
        return new Promise((resolve, reject) => {
            const t = this.db.transaction(['data'], 'readwrite');
            t.objectStore('data').put({ id: 'root', nomis: this.data.nomis, groups: this.data.groups, settings: this.data.settings });
            t.oncomplete = resolve; t.onerror = reject;
        });
    }

    loadData() {
        return new Promise((resolve, reject) => {
            const t = this.db.transaction(['data'], 'readonly');
            t.objectStore('data').get('root').onsuccess = (e) => {
                if (e.target.result) {
                    this.data.nomis = e.target.result.nomis || [];
                    this.data.groups = e.target.result.groups || [];
                    this.data.settings = e.target.result.settings || { theme: 'cyber', startView: 'home', apiKey: '' };
                }
                resolve();
            };
        });
    }

    toggleSettings() {
        const m = document.getElementById('settingsModal'); m.classList.toggle('active');
        if(m.classList.contains('active')) { document.getElementById('startUpSelect').value = this.data.settings.startView || 'home'; document.getElementById('apiKeyInput').value = this.data.settings.apiKey || ''; }
    }

    setTheme(name) { this.data.settings.theme = name; this.applyTheme(name); this.saveToDB(); }
    applyTheme(name) { const t = THEMES[name]; if(!t) return; document.documentElement.style.setProperty('--accent', t.accent); document.documentElement.style.setProperty('--accent-hover', t.hover); document.documentElement.style.setProperty('--chat-user-bg', t.userBg); document.documentElement.style.setProperty('--chat-nomi-bg', t.nomiBg); }
    saveSetting(k, v) { this.data.settings[k] = v; this.saveToDB(); }
    
    saveState(viewType, id = null) {
        this.data.settings.lastState = { view: viewType, id: id };
        this.saveToDB();
    }

    async syncFromApi() {
        if(this.isSyncing) return;
        const key = this.data.settings.apiKey;
        if (!key) { alert("Please go to Settings and enter your Nomi.ai API Key first."); this.toggleSettings(); return; }
        this.isSyncing = true;
        const pill = document.getElementById('syncBtn');
        const icon = document.getElementById('syncIcon');
        const text = document.getElementById('syncText');
        pill.classList.add('expanded');
        icon.classList.add('spin');
        text.innerText = "Syncing...";
        try {
            const listRes = await fetch("https://corsproxy.io/?https://api.nomi.ai/v1/nomis", { headers: { "Authorization": key } });
            if (!listRes.ok) throw new Error("Check API Key.");
            const listData = await listRes.json();
            let added=0, updated=0;
            for (const r of listData.nomis) {
                let l = this.data.nomis.find(n => n.uuid === r.uuid || n.name === r.name);
                if (!l) {
                    l = { id: Date.now() + Math.random(), uuid: r.uuid, name: r.name, photo: null, banner: null, data: { key_traits: [] }, gallery: [], custom_sections: [], sectionOrder: DEFAULT_SECTIONS.map(s=>s.id), isFavorite: false };
                    this.data.nomis.push(l); added++;
                } else { if(!l.uuid) l.uuid = r.uuid; updated++; }
                if (!l.photo) {
                    try {
                        const avRes = await fetch(`https://corsproxy.io/?https://api.nomi.ai/v1/nomis/${r.uuid}/avatar`, { headers: { "Authorization": key } });
                        if (avRes.ok) { 
                            const b = await avRes.blob(); 
                            l.photo = await new Promise(r=>{const fr=new FileReader();fr.onloadend=()=>r(fr.result);fr.readAsDataURL(b);});
                            if(l.gallery === undefined) l.gallery = [];
                            l.gallery.unshift({ id: Date.now() + Math.random(), img: l.photo, prompt: "Imported from Nomi.ai" });
                        }
                    } catch (e) {}
                }
            }
            await this.saveToDB(); 
            this.renderGallery(false); 
            text.innerText = `Added ${added}, Upd ${updated}`;
        } catch (e) { text.innerText = "Error"; alert(e.message); } finally { icon.classList.remove('spin'); setTimeout(() => { pill.classList.remove('expanded'); this.isSyncing = false; }, 3000); }
    }

    initStartView() {
        if(this.data.settings.startView === 'last' && this.data.settings.lastState) {
            const state = this.data.settings.lastState;
            if(state.view === 'nomi' && state.id) {
                const exists = this.data.nomis.find(n => n.id === state.id);
                if(exists) return this.editNomi(state.id);
            } else if(state.view === 'group' && state.id) {
                const exists = this.data.groups.find(g => g.id === state.id);
                if(exists) return this.editGroup(state.id);
            }
        }
        this.goHome(); 
    }

    goHome(pushHistory = true) {
        this.isReordering = false; 
        this.isBatchMode = false; 
        this.selectedImages.clear();
        document.getElementById('viewHome').style.display = 'block'; document.getElementById('viewNomi').style.display = 'none'; document.getElementById('viewGroup').style.display = 'none';
        document.getElementById('heroBackground').style.backgroundImage = 'none'; this.currentNomiId = null; this.currentGroupId = null; this.renderGallery(false);
        this.saveState('home');
        if(pushHistory) history.pushState({view: 'home'}, '', '#home');
    }

    switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab' + (t.charAt(0).toUpperCase() + t.slice(1))).classList.add('active');
        const a = document.getElementById('galleryActions');
        const tools = document.getElementById('expandTools');
        this.isReordering = false;
        const btnNomi = document.getElementById('btnSortNomi');
        const btnGroup = document.getElementById('btnSortGroup');
        const rstNomi = document.getElementById('btnResetNomi');
        const rstGroup = document.getElementById('btnResetGroup');
        if(btnNomi) btnNomi.classList.remove('active');
        if(btnGroup) btnGroup.classList.remove('active');
        if(rstNomi) rstNomi.style.visibility = 'hidden';
        if(rstGroup) rstGroup.style.visibility = 'hidden';
        
        if (t === 'profile') { 
            document.getElementById('contentProfile').style.display = 'block'; 
            document.getElementById('contentGallery').style.display = 'none'; 
            a.style.display = 'none'; 
            if(tools) tools.style.display = 'flex';
            this.renderFormGrid(); 
        }
        else { 
            document.getElementById('contentProfile').style.display = 'none'; 
            document.getElementById('contentGallery').style.display = 'block'; 
            a.style.display = 'flex'; 
            if(tools) tools.style.display = 'none';
            this.renderPromptGallery(); 
        }
    }

    createNomi() { const n = { id: Date.now(), name: "New Nomi", photo: null, banner: null, data: {}, gallery: [], custom_sections: [], sectionOrder: DEFAULT_SECTIONS.map(s=>s.id), isFavorite: false }; this.data.nomis.push(n); this.saveToDB().then(() => this.editNomi(n.id)); }
    
    editNomi(id, pushHistory = true) { 
        this.currentNomiId = id; 
        this.saveState('nomi', id);
        this.isReordering = false;
        
        // Reset tools
        const btnNomi = document.getElementById('btnSortNomi');
        if(btnNomi) btnNomi.classList.remove('active');
        const rstNomi = document.getElementById('btnResetNomi');
        if(rstNomi) rstNomi.style.visibility = 'hidden';
        this.isBatchMode = false;
        this.selectedImages.clear();

        if(pushHistory) history.pushState({view: 'nomi', id: id}, '', '#nomi/'+id);
        
        const n = this.data.nomis.find(x => x.id === id); 
        // Ensure section order exists
        if(!n.sectionOrder) { n.sectionOrder = DEFAULT_SECTIONS.map(s=>s.id); (n.custom_sections||[]).forEach(c=>n.sectionOrder.push(c.id)); } 
        
        // Toggle Views
        document.getElementById('viewHome').style.display = 'none'; 
        document.getElementById('viewNomi').style.display = 'block'; 
        document.getElementById('viewGroup').style.display = 'none'; 
        
        // *** FIX: Scroll to the top of the page immediately ***
        window.scrollTo(0, 0);
        
        this.switchTab('profile'); 
        this.toggleNameEdit('nomi', false); 
        document.getElementById('nomiNameDisplay').innerText = n.name; 
        document.getElementById('nomiName').value = n.name; 
        
        const disp = document.getElementById('nomiImageDisplay'); 
        const plac = document.getElementById('nomiImagePlaceholder'); 
        
        if(n.photo) { 
            disp.src = n.photo; disp.style.display='block'; plac.style.display='none'; 
        } else { 
            disp.style.display='none'; plac.style.display='flex'; 
        }

        this.renderTraits(); 
        this.renderFormGrid(); 
    }

    selectGalleryImageOptions(imgUrl, imgId) {
        cropper.initFromUrl(imgUrl, this.currentNomiId ? 'nomi' : 'group');
    }
    
    toggleFavorite(e, id) { e.stopPropagation(); const n = this.data.nomis.find(x => x.id === id); n.isFavorite = !n.isFavorite; this.saveToDB(); this.renderGallery(false); }
    
    renderGallery(animate = false) { 
        const g = document.getElementById('nomiGallery'); g.innerHTML = ''; 
        const term = document.getElementById('searchInput').value.toLowerCase(); 
        let sorted = this.data.nomis.filter(n => (n.name + JSON.stringify(n.data)).toLowerCase().includes(term)).sort((a,b) => (b.isFavorite === a.isFavorite) ? 0 : b.isFavorite ? 1 : -1); 
        
        sorted.forEach(n => { 
            const favClass = n.isFavorite ? 'active' : ''; 
            const animClass = animate ? 'pop-in' : ''; 
            const html = `<div class="nomi-card ${animClass}" onclick="app.editNomi(${n.id})"><img src="${n.photo || ''}" loading="lazy"><button class="fav-btn ${favClass}" onclick="app.toggleFavorite(event, ${n.id})"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button><div class="nomi-card-info">${n.name}</div></div>`; 
            g.insertAdjacentHTML('beforeend', html); 
        }); 
        
        const gg = document.getElementById('groupGallery'); gg.innerHTML = ''; 
        this.data.groups.filter(gr => gr.name.toLowerCase().includes(term)).forEach(gr => { 
            const animClass = animate ? 'pop-in' : '';
            const html = `<div class="nomi-card ${animClass}" onclick="app.editGroup(${gr.id})"><img src="${gr.photo || ''}" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSI1MCUiIHk9IjU1IiBmb250LXNpemU9IjIwIiBmaWxsPSIjY2NjIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj4/PC90ZXh0Pjwvc3ZnPg=='"><div class="nomi-card-info">${gr.name}</div></div>`; 
            gg.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    
    toggleNameEdit(type, isEditing) {
        const display = document.getElementById(type + 'NameDisplay');
        const btn = document.getElementById(type + 'EditBtn'); 
        const editor = document.getElementById(type + 'NameEdit');
        
        if(isEditing) {
            display.style.display = 'none';
            btn.style.display = 'none';
            editor.classList.add('active');
            document.getElementById(type + 'Name').focus();
        } else {
            display.style.display = 'block';
            btn.style.display = 'flex'; 
            editor.classList.remove('active');
        }
    }

    saveName(type) { 
        const val = document.getElementById(type + 'Name').value; 
        if(type === 'nomi') { 
            const n = this.data.nomis.find(x => x.id === this.currentNomiId); 
            n.name = val; 
            document.getElementById('nomiNameDisplay').innerText = val; 
            this.autoSaveNomi(); 
        } else { 
            const g = this.data.groups.find(x => x.id === this.currentGroupId); 
            g.name = val; 
            document.getElementById('groupNameDisplay').innerText = val; 
            this.autoSaveGroup(); 
        } 
        this.toggleNameEdit(type, false); 
    }
    
    setAllSections(collapsed) {
        document.querySelectorAll('.glass-card').forEach(card => {
            if(collapsed) card.classList.add('collapsed');
            else card.classList.remove('collapsed');
        });
    }

    copyAllSections(isGroup) {
        let text = "";
        let count = 0;
        
        if(isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            g.sectionOrder.forEach(sid => {
                const isBackstory = sid === 'backstory';
                const cust = g.custom_sections ? g.custom_sections.find(cs => cs.id === sid) : null;
                if(!isBackstory && !cust) return;
                const title = isBackstory ? "Group Backstory" : cust.title;
                const content = isBackstory ? (g.backstory || '') : cust.content;
                if(content.trim()) { text += `## ${title}\n${content}\n\n`; count++; }
            });
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            n.sectionOrder.forEach(sid => {
                const def = DEFAULT_SECTIONS.find(d => d.id === sid);
                const cust = n.custom_sections ? n.custom_sections.find(cs => cs.id === sid) : null;
                if (!def && !cust) return;
                const title = def ? def.label : cust.title;
                const val = def ? (n.data[sid] || '') : cust.content;
                if(val && val.trim()) { text += `## ${title}\n${val}\n\n`; count++; }
            });
        }
        if(count > 0) { navigator.clipboard.writeText(text).then(() => this.showToast(`Copied ${count} sections!`)); } else { this.showToast("Nothing to copy!"); }
    }
    
    toggleReorderMode() {
        this.isReordering = !this.isReordering;
        const btnNomi = document.getElementById('btnSortNomi');
        const btnGroup = document.getElementById('btnSortGroup');
        const rstNomi = document.getElementById('btnResetNomi');
        const rstGroup = document.getElementById('btnResetGroup');
        
        if(this.isReordering) {
            if(btnNomi) btnNomi.classList.add('active');
            if(btnGroup) btnGroup.classList.add('active');
            if(rstNomi) rstNomi.style.visibility = 'visible';
            if(rstGroup) rstGroup.style.visibility = 'visible';
        } else {
            if(btnNomi) btnNomi.classList.remove('active');
            if(btnGroup) btnGroup.classList.remove('active');
            if(rstNomi) rstNomi.style.visibility = 'hidden';
            if(rstGroup) rstGroup.style.visibility = 'hidden';
        }
        if(document.getElementById('viewGroup').style.display === 'block') { this.renderGroupSections(); } else { this.renderFormGrid(); }
    }
    
    resetSort() {
        if(!confirm("Reset sections to default order?")) return;
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        if (isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            let newOrder = ['backstory'];
            if(g.custom_sections) { g.custom_sections.forEach(cs => { if(!newOrder.includes(cs.id)) newOrder.push(cs.id); }); }
            g.sectionOrder = newOrder;
            this.saveToDB();
            this.renderGroupSections();
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            let newOrder = DEFAULT_SECTIONS.map(s => s.id);
            if(n.custom_sections) { n.custom_sections.forEach(cs => { if(!newOrder.includes(cs.id)) newOrder.push(cs.id); }); }
            n.sectionOrder = newOrder;
            this.saveToDB();
            this.renderFormGrid();
        }
    }

    toggleBatchMode() {
        this.isBatchMode = !this.isBatchMode;
        this.selectedImages.clear();
        const btn = document.getElementById('btnBatchMode');
        const delBtn = document.getElementById('btnBatchDelete');
        if(this.isBatchMode) { btn.classList.add('active'); delBtn.style.display = 'flex'; } else { btn.classList.remove('active'); delBtn.style.display = 'none'; }
        this.renderPromptGallery();
    }

    toggleGallerySelection(id) {
        if(this.selectedImages.has(id)) { this.selectedImages.delete(id); } else { this.selectedImages.add(id); }
        this.renderPromptGallery();
    }

    deleteBatchImages() {
        if(this.selectedImages.size === 0) return this.showToast("No images selected");
        if(!confirm(`Delete ${this.selectedImages.size} selected images?`)) return;
        const n = this.data.nomis.find(x => x.id === this.currentNomiId);
        n.gallery = n.gallery.filter(g => !this.selectedImages.has(g.id));
        this.saveToDB();
        this.toggleBatchMode();
        this.showToast("Images Deleted!");
    }

    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.glass-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    handleDragStart(e, id, isGroup) { 
        if(!this.isReordering) { e.preventDefault(); return; } 
        this.dragSrcEl = e.target.closest('.glass-card'); 
        this.dragSrcEl.classList.add('dragging'); 
        e.dataTransfer.effectAllowed = 'move'; 
        e.dataTransfer.setData('text/plain', id);
    }

    handleDragOver(e) {
        if(!this.isReordering) return;
        e.preventDefault();
        const container = e.target.closest('.form-column-container') || document.getElementById('groupSectionsContainer');
        if(!container) return;
        const afterElement = this.getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.dragging');
        if(!draggable) return;
        if (afterElement == null) { container.appendChild(draggable); } else { container.insertBefore(draggable, afterElement); }
    }

    handleDragEnd(e) {
        const draggable = document.querySelector('.dragging');
        if(draggable) draggable.classList.remove('dragging');
        this.saveOrderFromDOM();
    }

    handleTouchStart(e) {
        if(!this.isReordering) return;
        if(e.cancelable) e.preventDefault();
        const handle = e.currentTarget;
        const card = handle.closest('.glass-card');
        this.touchDragItem = card;
        card.classList.add('dragging');
    }

    handleTouchMove(e) {
        if(!this.isReordering) return;
        if(e.cancelable) e.preventDefault();
        if (!this.touchDragItem) return;
        const touch = e.touches[0];
        const elementUnderFinger = document.elementFromPoint(touch.clientX, touch.clientY);
        if(!elementUnderFinger) return;
        const container = elementUnderFinger.closest('.form-column-container') || document.getElementById('groupSectionsContainer');
        if(!container) return;
        const afterElement = this.getDragAfterElement(container, touch.clientY);
        if (afterElement == null) { container.appendChild(this.touchDragItem); } else { container.insertBefore(this.touchDragItem, afterElement); }
    }

    handleTouchEnd(e) {
        if (this.touchDragItem) {
            this.touchDragItem.classList.remove('dragging');
            this.touchDragItem = null;
            this.saveOrderFromDOM();
        }
    }

    saveOrderFromDOM() {
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        if (isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            const container = document.getElementById('groupSectionsContainer');
            const newOrder = [];
            Array.from(container.children).forEach(child => {
                 const textArea = child.querySelector('textarea');
                 if(textArea) { const parts = textArea.id.split('group_sec_'); if(parts.length > 1) newOrder.push(parts[1]); }
            });
            if(newOrder.length > 0) { g.sectionOrder = newOrder; this.saveToDB(); }
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            const container = document.getElementById('profileGrid');
            const newOrder = [];
            Array.from(container.children).forEach(child => {
                const textArea = child.querySelector('textarea');
                if(textArea) { const parts = textArea.id.split('field_'); if(parts.length > 1) newOrder.push(parts[1]); }
            });
            if(newOrder.length > 0) { n.sectionOrder = newOrder; this.saveToDB(); }
        }
    }

    renderFormGrid() { 
        const c = document.getElementById('profileGrid'); c.innerHTML = ''; 
        const n = this.data.nomis.find(x => x.id === this.currentNomiId); 
        if(!n) return; 
        if(!n.sectionOrder || n.sectionOrder.length === 0) { n.sectionOrder = DEFAULT_SECTIONS.map(s=>s.id); if(n.custom_sections) n.custom_sections.forEach(cs=>n.sectionOrder.push(cs.id)); } 
        const draggableAttr = this.isReordering ? 'draggable="true"' : 'draggable="false"';
        const handleStyle = this.isReordering ? 'display:block;' : '';
        if(this.isReordering) { c.ondragover = (e) => app.handleDragOver(e); }

        n.sectionOrder.forEach((sid, idx) => { 
            const def = DEFAULT_SECTIONS.find(d => d.id === sid); 
            const cust = n.custom_sections ? n.custom_sections.find(cs => cs.id === sid) : null; 
            if (!def && !cust) return; 
            const label = def ? def.label : cust.title; 
            const val = def ? (n.data[sid] || '') : cust.content; 
            const limit = def ? def.limit : 5000; 
            const isCust = !!cust; 
            const html = ` <div class="glass-card collapsed ${def && val.length > limit ? 'over-limit' : ''}" id="card_${sid}" ${draggableAttr} ondragstart="app.handleDragStart(event, '${sid}', false)" ondragend="app.handleDragEnd(event)"> <div class="card-header" onclick="app.toggleCard(this.parentNode)"> <div class="card-header-left"> <span class="drag-handle" style="${handleStyle}" onmousedown="event.stopPropagation()" ontouchstart="app.handleTouchStart(event)" ontouchmove="app.handleTouchMove(event)" ontouchend="app.handleTouchEnd(event)"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg> </span> ${isCust ? `<input type="text" value="${label}" style="background:transparent;border:none;color:var(--accent);font-weight:700;font-size:0.85rem;width:100%;font-family:inherit;letter-spacing:1px;text-transform:uppercase;padding:0;margin:0;-webkit-user-select:text;user-select:text;" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" oninput="app.updateNomiSectionTitle('${sid}', this.value)">` : `<span>${label}</span>`} </div> <div class="card-controls"> ${isCust ? `<button class="tool-btn del" style="width:20px;height:20px;" onclick="event.stopPropagation(); app.deleteNomiSection('${sid}')">×</button>` : `<span id="count_${sid}" style="font-size:0.7rem; opacity:0.6">${val.length}/${limit}</span>`} <span class="card-arrow">▼</span> </div> </div> <div class="card-body"> <textarea id="field_${sid}" class="ghost-input" oninput="app.handleInput('${sid}', ${limit}, ${isCust})">${val}</textarea> <div class="btn-row"><button class="save-btn" onclick="app.saveCurrentNomi(true)">Save</button><button class="copy-btn" onclick="app.copyText('field_${sid}')">Copy</button></div> </div> </div>`; 
            c.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    
    addNomiSection() { const n = this.data.nomis.find(x => x.id === this.currentNomiId); if(!n.custom_sections) n.custom_sections = []; const newId = 'cs_' + Date.now(); n.custom_sections.push({ id: newId, title: "New Section", content: "" }); n.sectionOrder.push(newId); this.saveToDB(); this.renderFormGrid(); }
    updateNomiSectionTitle(id, val) { const n = this.data.nomis.find(x => x.id === this.currentNomiId); const s = n.custom_sections.find(c => c.id === id); if(s) { s.title = val; this.saveToDB(); } }
    deleteNomiSection(id) { if(!confirm("Delete this section?")) return; const n = this.data.nomis.find(x => x.id === this.currentNomiId); n.custom_sections = n.custom_sections.filter(c => c.id !== id); n.sectionOrder = n.sectionOrder.filter(o => o !== id); this.saveToDB(); this.renderFormGrid(); }
    handleInput(id, limit, isCust) { if(!isCust) { const el = document.getElementById(`field_${id}`); const card = document.getElementById(`card_${id}`); const count = document.getElementById(`count_${id}`); if(count) count.innerText = `${el.value.length}/${limit}`; if(el.value.length > limit) { card.classList.add('over-limit'); count.style.color='#ef4444'; } else { card.classList.remove('over-limit'); count.style.color='inherit'; } } else { const n=this.data.nomis.find(x=>x.id===this.currentNomiId); const s=n.custom_sections.find(c=>c.id===id); if(s) s.content=document.getElementById(`field_${id}`).value; } this.autoSaveNomi(); }
    autoSaveNomi() { this.saveCurrentNomi(false); }
    saveCurrentNomi(toast) { const n = this.data.nomis.find(x => x.id === this.currentNomiId); DEFAULT_SECTIONS.forEach(s => { const el = document.getElementById(`field_${s.id}`); if(el) n.data[s.id] = el.value; }); if(n.custom_sections) { n.custom_sections.forEach(s => { const el = document.getElementById(`field_${s.id}`); if(el) s.content = el.value; }); } this.saveToDB().then(() => { if(toast) this.showToast("Profile Saved!"); }); }
    renderTraits() { const n = this.data.nomis.find(x => x.id === this.currentNomiId); const c = document.getElementById('traitContainer'); c.innerHTML = ''; (n.data.key_traits || []).forEach(t => { const d=document.createElement('div'); d.className='tag'; d.innerText=t+' ×'; d.onclick=()=>{ n.data.key_traits=n.data.key_traits.filter(x=>x!==t); this.saveToDB(); this.renderTraits(); }; c.appendChild(d); }); }
    addTrait(t) { const n=this.data.nomis.find(x=>x.id===this.currentNomiId); if(!n.data.key_traits)n.data.key_traits=[]; if(n.data.key_traits.length>=7)return alert("Max 7 traits"); if(t.trim()){ n.data.key_traits.push(t.trim()); this.saveToDB(); this.renderTraits(); } }
    async addGalleryImages(inpt) { const files=Array.from(inpt.files); if(files.length===0)return; for(const f of files){ await new Promise(r=>{ this.processImage(f,1024,(b64)=>{ const n=this.data.nomis.find(x=>x.id===this.currentNomiId); if(!n.gallery)n.gallery=[]; n.gallery.push({id:Date.now()+Math.random(),img:b64,prompt:""}); r(); }); }); } this.saveToDB().then(()=>this.renderPromptGallery()); }
    
    renderPromptGallery() { 
        const g = document.getElementById('promptGalleryGrid'); g.innerHTML = ''; 
        const n = this.data.nomis.find(x => x.id === this.currentNomiId); 
        (n.gallery || []).forEach(i => { 
            const isSel = this.selectedImages.has(i.id);
            const d = document.createElement('div'); 
            d.className = `prompt-card ${isSel ? 'selected' : ''}`; 
            d.id = `card_${i.id}`; // Add ID for easy selection

            let clickHandler;
            if(this.isBatchMode) {
                clickHandler = `onclick="app.toggleGallerySelection(${i.id})"`;
            } else {
                clickHandler = `onclick="app.openLightbox('${i.img}')"`;
            }

            // In-Place Popup HTML (Hidden by default, shown via CSS on .editing class)
            const inPlacePopup = `
                <div class="prompt-popup-inplace" id="inplace_${i.id}" onclick="event.stopPropagation()">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="color:var(--accent); font-size:0.8rem;">Prompt</strong>
                        <span style="cursor:pointer; font-size:1.1rem;" onclick="app.closeInPlacePopup(${i.id})">✕</span>
                    </div>
                    <textarea id="inplace_input_${i.id}" oninput="app.updatePrompt(${i.id}, this.value)">${i.prompt || ''}</textarea>
                    <div class="btn-row" style="margin-top:0;">
                         <button class="save-btn" onclick="app.savePromptManualInPlace(${i.id})" style="padding:4px 8px; font-size:0.75rem;">Save</button>
                         <button class="copy-btn" onclick="app.copyText('inplace_input_${i.id}')" style="padding:4px 8px; font-size:0.75rem;">Copy</button>
                    </div>
                </div>
            `;

            d.innerHTML = `
                <img src="${i.img}" ${clickHandler}>
                ${inPlacePopup}
                <div class="ghost-overlay" style="${this.isBatchMode ? 'display:none;' : ''}">
                    <button class="tool-btn star" onclick="event.stopPropagation(); app.selectGalleryImageOptions('${i.img}', ${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    </button>
                    <button class="tool-btn" onclick="event.stopPropagation(); app.openPromptPopup(${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="tool-btn del" onclick="event.stopPropagation(); app.deleteGalleryItem(${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>`; 
            g.appendChild(d); 
        }); 
    }
    
    /* Logic to switch between Global (Mobile) and In-Place (PC) Prompt Editors */
    openPromptPopup(imgId) {
        this.currentEditingImageId = imgId;
        const n = this.data.nomis.find(x => x.id === this.currentNomiId);
        const i = n.gallery.find(g => g.id === imgId);
        if(!i) return;

        // Use hover capability to detect PC-like interaction
        const isPC = window.matchMedia("(hover: hover)").matches;

        if (isPC) {
            // PC Logic: Show In-Place
            const card = document.getElementById(`card_${imgId}`);
            if(card) {
                card.classList.add('editing');
                // Optional: Focus for PC
                setTimeout(() => {
                    const el = document.getElementById(`inplace_input_${imgId}`);
                    if(el) el.focus();
                }, 100);
            }
        } else {
            // Mobile Logic: Show Global Popup (NO FOCUS)
            document.getElementById('globalPromptInput').value = i.prompt || '';
            document.getElementById('globalPromptPopup').classList.add('active');
            // Explicitly removed focus() call to prevent keyboard popup
        }
    }
    
    closePromptPopup() {
        document.getElementById('globalPromptPopup').classList.remove('active');
        this.currentEditingImageId = null;
    }

    closeInPlacePopup(imgId) {
        const card = document.getElementById(`card_${imgId}`);
        if(card) card.classList.remove('editing');
        this.currentEditingImageId = null;
    }

    updatePrompt(imgId, text) { 
        const n=this.data.nomis.find(x=>x.id===this.currentNomiId); 
        const i=n.gallery.find(g=>g.id===imgId); 
        if(i){ i.prompt=text; this.saveToDB(); } 
        // Sync if multiple inputs open
        const globalEl = document.getElementById('globalPromptInput');
        const localEl = document.getElementById(`inplace_input_${imgId}`);
        if(globalEl && globalEl.value !== text) globalEl.value = text;
        if(localEl && localEl.value !== text) localEl.value = text;
    }

    savePromptManual() { this.showToast("Prompt Saved!"); this.closePromptPopup(); }
    savePromptManualInPlace(imgId) { this.showToast("Prompt Saved!"); this.closeInPlacePopup(imgId); }

    deleteGalleryItem(id) { if(!confirm("Remove image?")) return; const n=this.data.nomis.find(x=>x.id===this.currentNomiId); n.gallery=n.gallery.filter(g=>g.id!==id); this.saveToDB(); this.renderPromptGallery(); }
    setNomiPhoto(b64) { const n=this.data.nomis.find(x=>x.id===this.currentNomiId); n.photo=b64; this.saveToDB(); document.getElementById('nomiImageDisplay').src=b64; document.getElementById('nomiImageDisplay').style.display='block'; document.getElementById('nomiImagePlaceholder').style.display='none'; }
    setGroupPhoto(b64) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.photo=b64; this.saveToDB(); document.getElementById('groupImageDisplay').src=b64; document.getElementById('groupImageDisplay').style.display='block'; document.getElementById('groupImagePlaceholder').style.display='none'; }

    editGroup(id, pushHistory = true) { 
        this.currentGroupId=id; this.saveState('group', id);
        this.isReordering = false;
        const btnGroup = document.getElementById('btnSortGroup');
        if(btnGroup) btnGroup.classList.remove('active');
        const rstGroup = document.getElementById('btnResetGroup');
        if(rstGroup) rstGroup.style.visibility = 'hidden';

        if(pushHistory) history.pushState({view: 'group', id: id}, '', '#group/'+id);
        
        const g=this.data.groups.find(x=>x.id===id); if(!g.sectionOrder) { g.sectionOrder = ['backstory']; (g.custom_sections||[]).forEach(c=>g.sectionOrder.push(c.id)); } document.getElementById('viewHome').style.display='none'; document.getElementById('viewNomi').style.display='none'; document.getElementById('viewGroup').style.display='block'; document.getElementById('heroBackground').style.backgroundImage='none'; this.toggleNameEdit('group', false); document.getElementById('groupNameDisplay').innerText=g.name; document.getElementById('groupName').value=g.name; const d=document.getElementById('groupImageDisplay'); const p=document.getElementById('groupImagePlaceholder'); if(g.photo){d.src=g.photo;d.style.display='block';p.style.display='none';}else{d.style.display='none';p.style.display='flex';} 
        
        this.renderGroupMembers(); this.renderGroupSections(); 
    }
    createGroup() { const g={ id:Date.now(), name:"New Group", photo:null, members:[], custom_sections:[], sectionOrder:['backstory'] }; this.data.groups.push(g); this.saveToDB().then(()=>this.editGroup(g.id)); }
    renderGroupMembers() { 
        const c = document.getElementById('groupMembers'); 
        c.innerHTML = ''; 
        const g = this.data.groups.find(x => x.id === this.currentGroupId); 
        
        g.members.forEach(mid => { 
            const n = this.data.nomis.find(x => x.id === mid); 
            if(n) { 
                const d = document.createElement('div'); 
                d.className = 'member-chip'; 
                // Make it look clickable
                d.style.cursor = 'pointer';
                // Navigate to profile on click
                d.onclick = () => app.editNomi(n.id);
                
                // Note the event.stopPropagation() on the remove button so it doesn't trigger navigation
                d.innerHTML = `<img src="${n.photo || ''}" onerror="this.style.display='none'">
                               <span>${n.name}</span>
                               <span class="member-remove" onclick="event.stopPropagation(); app.removeMember(${n.id})">×</span>`; 
                c.appendChild(d); 
            } 
        }); 
    }    toggleMemberDropdown() { const d=document.getElementById('memberOptions'); if(d.classList.contains('open')){d.classList.remove('open');return;} d.innerHTML=''; const g=this.data.groups.find(x=>x.id===this.currentGroupId); let h=false; this.data.nomis.forEach(n=>{ if(!g.members.includes(n.id)){ h=true; const dv=document.createElement('div'); dv.className='custom-option'; dv.innerHTML=`<img src="${n.photo||''}" onerror="this.style.display='none'"><span>${n.name}</span>`; dv.onclick=()=>app.addMember(n.id); d.appendChild(dv); } }); if(!h)d.innerHTML='<div style="padding:10px;color:#666;font-size:0.9rem;">No other Nomis available.</div>'; d.classList.add('open'); }
    addMember(id) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.members.push(id); this.saveToDB(); this.renderGroupMembers(); document.getElementById('memberOptions').classList.remove('open'); }
    removeMember(id) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.members=g.members.filter(m=>m!==id); this.saveToDB(); this.renderGroupMembers(); }
    addGroupSection() { const g=this.data.groups.find(x=>x.id===this.currentGroupId); if(!g.custom_sections)g.custom_sections=[]; const nid='cs_g_'+Date.now(); g.custom_sections.push({id:nid,title:"New Section",content:""}); g.sectionOrder.push(nid); this.saveToDB(); this.renderGroupSections(); }
    renderGroupSections() { 
        const c=document.getElementById('groupSectionsContainer'); c.innerHTML=''; 
        const g=this.data.groups.find(x=>x.id===this.currentGroupId); 
        if(!g.sectionOrder) { g.sectionOrder=['backstory']; (g.custom_sections||[]).forEach(cs=>g.sectionOrder.push(cs.id)); } 
        const draggableAttr = this.isReordering ? 'draggable="true"' : 'draggable="false"';
        const handleStyle = this.isReordering ? 'display:block;' : '';
        if(this.isReordering) { c.ondragover = (e) => app.handleDragOver(e); }

        g.sectionOrder.forEach(sid => { 
            const isBackstory = sid === 'backstory'; 
            const cust = g.custom_sections ? g.custom_sections.find(cs => cs.id === sid) : null; 
            if(!isBackstory && !cust) return; 
            const title = isBackstory ? "Group Backstory" : cust.title; 
            const content = isBackstory ? (g.backstory || '') : cust.content; 
            const html = ` <div class="glass-card collapsed" id="card_group_${sid}" draggable="${this.isReordering}" ondragstart="app.handleDragStart(event, '${sid}', true)" ondragend="app.handleDragEnd(event)"> <div class="card-header" onclick="app.toggleCard(this.parentNode)"> <div class="card-header-left"> <span class="drag-handle" style="${handleStyle}" onmousedown="event.stopPropagation()" ontouchstart="app.handleTouchStart(event)" ontouchmove="app.handleTouchMove(event)" ontouchend="app.handleTouchEnd(event)"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg> </span> ${isBackstory ? `<span>${title}</span>` : `<input type="text" value="${title}" style="background:transparent;border:none;color:var(--accent);font-weight:700;font-size:0.85rem;width:100%;font-family:inherit;letter-spacing:1px;text-transform:uppercase;padding:0;margin:0;-webkit-user-select:text;user-select:text;" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" oninput="app.updateGroupSectionTitle('${sid}', this.value)">`} </div> <div class="card-controls"> ${isBackstory ? `<span id="groupCount" style="margin-right:10px;opacity:0.6">${content.length}/1000</span>` : `<button class="tool-btn del" style="width:20px;height:20px;" onclick="event.stopPropagation(); app.deleteGroupSection('${sid}')">×</button>`} <span class="card-arrow">▼</span> </div> </div> <div class="card-body"> <textarea id="group_sec_${sid}" class="ghost-input" oninput="app.updateGroupSectionContent('${sid}', this.value)">${content}</textarea> <div class="btn-row"><button class="save-btn" onclick="app.saveCurrentGroup(true)">Save</button><button class="copy-btn" onclick="app.copyText('group_sec_${sid}')">Copy</button></div> </div> </div>`; 
            c.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    updateGroupSectionTitle(id, val) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); const s=g.custom_sections.find(x=>x.id===id); if(s){ s.title=val; this.saveToDB(); } }
    updateGroupSectionContent(id, val) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); if(id==='backstory') { g.backstory=val; document.getElementById('groupCount').innerText=`${val.length}/1000`; } else { const s=g.custom_sections.find(x=>x.id===id); if(s) s.content=val; } this.autoSaveGroup(); }
    deleteGroupSection(id) { if(!confirm("Delete?"))return; const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.custom_sections=g.custom_sections.filter(x=>x.id!==id); g.sectionOrder=g.sectionOrder.filter(x=>x!==id); this.saveToDB(); this.renderGroupSections(); }
    autoSaveGroup() { this.saveCurrentGroup(false); }
    saveCurrentGroup(t) { this.saveToDB().then(()=>{ if(t)this.showToast("Group Saved!"); }); }
    toggleCard(c) { c.classList.toggle('collapsed'); }
    deleteNomi() { if(confirm("Delete permanently?")) { this.data.nomis=this.data.nomis.filter(n=>n.id!==this.currentNomiId); this.saveToDB(); this.goHome(); } }
    deleteGroup() { if(confirm("Delete Group?")) { this.data.groups=this.data.groups.filter(g=>g.id!==this.currentGroupId); this.saveToDB(); this.goHome(); } }

    exportData() { const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this.data)); const a=document.createElement('a'); a.href=s; a.download="nomi_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
    importData(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ try{const j=JSON.parse(e.target.result); if(confirm("Overwrite data?")){this.data=j;this.saveToDB().then(()=>{alert("Done!");location.reload();});}}catch(e){alert("Invalid JSON");} }; r.readAsText(f); }
    processImage(f,mw,cb) { if(!f)return; const r=new FileReader(); r.onload=(e)=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); const s=mw/i.width; c.width=mw; c.height=i.height*s; const x=c.getContext('2d'); x.drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/jpeg',0.85)); }; }; r.readAsDataURL(f); }
    copyText(id) { navigator.clipboard.writeText(document.getElementById(id).value).then(()=>this.showToast("Copied!")); }
    showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    openLightbox(s) { if(!s)return; document.getElementById('lightboxImg').src=s; document.getElementById('lightbox').classList.add('active'); }
    closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }
}

const app = new NomiApp(); window.onload = () => app.init();
</script>
</body>
</html>













