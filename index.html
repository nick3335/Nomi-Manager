<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nomi Manager</title>
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nomi Manager">
    <link rel="apple-touch-icon" href="logo.svg">
    <meta name="theme-color" content="#0f0f13">

    <style>
        :root {
            --bg-body: #0f0f13;
            --bg-card: #222226;
            --glass-bg: rgba(30, 30, 35, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --bg-input: #121214;
            --accent: #d946ef;
            --accent-dim: rgba(217, 70, 239, 0.05);
            --accent-hover: #c026d3;
            --success: #10b981;
            --error: #ef4444;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --border: #3f3f46;
            --app-font: 'Inter', system-ui, -apple-system, sans-serif;
            --fixed-font: 'Inter', system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html { overflow-y: scroll; }

        body {
            font-family: var(--app-font);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            opacity: 0; 
            transition: opacity 0.4s ease;
        }

        /* --- BACKGROUND --- */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body);
            z-index: 0; pointer-events: none;
            transition: background 0.3s ease;
        }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        
        @keyframes popInCenter { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.95); } 
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 
        }
        
        @keyframes slideUpFade { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }

        /* --- MAIN CONTENT --- */
        .main-content { flex-grow: 1; padding: 40px; position: relative; z-index: 10; width: 100%; display: flex; flex-direction: column; padding-bottom: 120px; max-width: 1600px; margin: 0 auto; }
        
        .hero-bg {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; background-position: center;
            filter: blur(25px) brightness(0.25);
            z-index: 0; pointer-events: none;
            transition: background-image 0.5s ease-in-out;
        }

        /* TOP BAR */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; height: 50px; position: relative; z-index: 10; }
        .top-bar h2 { margin: 0; font-size: 1.8rem; font-family: var(--fixed-font); font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 10px; }
        
        .search-wrapper { position: relative; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .search-icon-btn { background: var(--bg-card); border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: 0.2s; z-index: 2; backdrop-filter: blur(5px); }
        
        /* DASHBOARD VIEW TOGGLES */
        .view-toggles { display: flex; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 2px; height: 40px; align-items: center; }
        .view-btn { 
            background: transparent; border: none; color: var(--text-muted); 
            width: 36px; height: 34px; border-radius: 18px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            transition: 0.2s; 
        }
        .view-btn:hover { color: var(--text-main); }
        .view-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        @media (hover: hover) {
            .search-icon-btn:hover { border-color: var(--accent); color: var(--accent); }
            .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }
            .fab-btn:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }
            .sync-pill:hover { border-color: var(--accent); color: var(--accent); }
            .nomi-card:hover { transform: translateY(-5px) scale(1.02); border-color: var(--accent); box-shadow: 0 10px 25px var(--accent-dim); }
            .nomi-card:hover .fav-btn { opacity: 1; }
            .fav-btn.active:hover { color: #ef4444; }
            .fav-btn:hover { transform: scale(1.1); color: white; }
            .profile-avatar-wrapper:hover { transform: scale(1.05); border-color: var(--accent); }
            .prompt-card:hover { border: 2px solid var(--accent); }
            .prompt-card:hover .ghost-overlay { opacity: 1; pointer-events: auto; }
            .tool-btn:hover { background: rgba(255,255,255,0.2); color: white; border-color: rgba(255,255,255,0.3); }
            .tool-btn.star:hover { color: #fbbf24; }
            .tool-btn.del:hover { color: #ef4444; }
            .back-btn:hover { color: var(--accent); border-color: var(--accent); }
            .icon-btn:hover { color: var(--accent); transform: scale(1.1); }
            .btn-upload:hover { filter: brightness(1.1); }
            .copy-btn:hover { background: var(--accent); border-color: var(--accent); color: var(--bg-card); }
            .save-btn:hover { background: var(--success); color: var(--bg-card); }
            .btn-secondary:hover { background-color: var(--bg-card); color: var(--text-main); }
            .btn-add-section:hover { background-color: rgba(16, 185, 129, 0.1); border-color: #34d399; color: #34d399; transform: translateY(-2px); }
            .delete-btn:hover { background: rgba(239, 68, 68, 0.1); }
            .tool-text-btn:hover { color: var(--text-main); border-color: var(--text-muted); }
            .glass-card:hover { border-color: var(--text-muted); }
            .add-trait-btn:hover { background: var(--accent); }
            .custom-option:hover { background: var(--bg-input); color: var(--accent); }
            .member-remove:hover { color: var(--error); background: rgba(239, 68, 68, 0.1); border-color:var(--error); }
            .lightbox-close:hover { color: var(--accent); }
            .settings-close:hover { color: var(--accent); }
            .theme-opt:hover { transform: scale(1.05); }
            .image-option-btn:hover { background: var(--accent); border-color: var(--accent); }
            .context-item:hover { background: var(--bg-input); color: var(--text-main); }
        }

        .search-input { width: 0; padding: 0; border: none; background: var(--glass-bg); backdrop-filter: blur(10px); color: var(--text-main); border-radius: 20px; transition: 0.3s ease-in-out; opacity: 0; position: absolute; right: 20px; height: 40px; }
        .search-input.active { width: 300px; padding: 0 15px; border: 1px solid var(--border); opacity: 1; right: 50px; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        
        .gallery-toolbar {
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px;
            margin-bottom: 20px; background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border); border-radius: 12px; padding: 5px 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; z-index: 20; 
        }
        .gallery-search {
            background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border);
            padding: 6px 12px; border-radius: 8px; font-family: inherit; font-size: 0.85rem;
            width: 250px; transition: border-color 0.2s;
        }
        .gallery-search:focus { outline: none; border-color: var(--accent); }
        .gallery-tools-right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        .grid-menu {
            position: absolute; top: 110%; right: 0;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px; width: 220px;
            display: none; flex-direction: column; gap: 8px; z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: fadeIn 0.2s;
        }
        .grid-menu.active { display: flex; }
        
        .grid-slider-row { display: flex; justify-content: space-between; padding: 0px; margin-bottom: 5px; color: var(--text-muted); }
        .grid-slider-row svg { width: 16px; height: 16px; transition: 0.2s; }
        .grid-slider-row svg.selected { color: var(--accent); transform: scale(1.2); }

        input[type=range].custom-slider { 
            -webkit-appearance: none; width: 100%; background: transparent; 
            cursor: pointer; margin: 0; padding: 0; display: block; 
        }
        input[type=range].custom-slider:focus { outline: none; }
        input[type=range].custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: var(--accent); margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        input[type=range].custom-slider::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px;
        }
        
        @media (max-width: 768px) { .hide-mobile { display: none !important; } }
        .section-divider { display: flex; align-items: center; gap: 15px; margin: 40px 0 20px 0; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .section-divider::after { content: ''; flex-grow: 1; height: 1px; background: var(--border); }
        .btn-action { background-color: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        
        .fab-group { position: fixed; bottom: 30px; right: 30px; z-index: 9000; display: flex; gap: 15px; align-items: flex-end; }
        
        .fab-btn {
            width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7); backdrop-filter: blur(10px); cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .fab-btn:active { transform: scale(0.95); }

        .sync-pill {
            height: 50px; border-radius: 25px; background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-main); display: flex; align-items: center; justify-content: flex-end;
            padding: 0 13px; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            cursor: pointer; overflow: hidden; width: 50px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .sync-pill.expanded { width: auto; padding-left: 20px; padding-right: 15px; }
        .sync-pill.success { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.1); }
        
        .sync-text { white-space: nowrap; font-size: 0.9rem; font-weight: bold; opacity: 0; transition: opacity 0.2s; display: none; }
        .sync-pill.expanded .sync-text { opacity: 1; display: block; }
        .sync-pill svg.spin { animation: spin 1s linear infinite; }

        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding-bottom: 20px; position: relative; z-index: 10; }
        
        .masonry-grid { 
            display: grid; 
            --grid-min: 160px;
            grid-template-columns: repeat(auto-fill, minmax(var(--grid-min), 1fr)); 
            gap: 15px; 
            position: relative; z-index: 10; align-items: start; animation: slideUpFade 0.6s ease-out; 
        }

        .nomi-card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; 
            overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; 
            display: flex; flex-direction: column; cursor: pointer; position: relative; 
            aspect-ratio: 1 / 1;
        }
        .nomi-card img { 
            width: 100%; height: 100%; object-fit: cover; display: block; background: #000; 
            position: absolute; top: 0; left: 0;
        }
        .nomi-card-info { 
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.65); backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
            color: #fff; padding: 6px 14px; 
            text-align: center; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            font-size: 0.85rem; max-width: 90%; z-index: 2;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .fav-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); cursor: pointer; backdrop-filter: blur(4px); opacity: 0; transition: 0.2s; z-index: 3;}
        @media (hover: none) { .fav-btn { opacity: 1; } }
        .fav-btn.active { color: #ef4444; opacity: 1; }

        .card-placeholder {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; 
            background: var(--bg-input); color: var(--text-muted); 
            font-size: 4rem; font-weight: 900;
            user-select: none; text-transform: uppercase;
        }
        
        .nomi-card.pop-in { animation: popIn 0.4s ease-out forwards; }
        
        .gallery-grid.list-mode {
            grid-template-columns: repeat(2, 1fr); gap: 10px;
        }
        .gallery-grid.list-mode .nomi-card {
            aspect-ratio: auto; flex-direction: row; align-items: center; padding: 4px; height: auto; border-radius: 50px;
        }
        .gallery-grid.list-mode .nomi-card img {
            position: static; width: 48px; height: 48px; border-radius: 50%; margin-right: 10px; display: block;
        }
        .gallery-grid.list-mode .card-placeholder {
            width: 48px; height: 48px; border-radius: 50%; margin-right: 10px; font-size: 1.2rem; flex-shrink: 0; aspect-ratio: 1/1; background: var(--bg-input);
        }
        .gallery-grid.list-mode .nomi-card-info {
            position: static; transform: none; background: none; border: none; backdrop-filter: none; box-shadow: none;
            display: flex; align-items: center; height: 100%; padding: 0 0 0 4px; margin: 0;
            text-align: left; font-size: 1rem; line-height: 1; color: var(--text-main); flex-grow: 1;
        }
        .gallery-grid.list-mode .fav-btn {
            position: static; opacity: 1; color: var(--text-muted); background: transparent; backdrop-filter: none;
            align-self: center; margin-left: auto; margin-right: 10px; margin-top: 0; margin-bottom: 0;
        }
        .gallery-grid.list-mode .fav-btn.active { color: var(--error); }

        .profile-header-card {
            margin-bottom: 30px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 16px; padding: 30px; display: flex; align-items: center; gap: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideUpFade 0.5s ease-out; position: relative; z-index: 30; 
        }

        .profile-avatar-wrapper {
            position: relative; width: 140px; height: 140px; flex-shrink: 0; border-radius: 50%; border: 2px solid var(--border);
            background: var(--bg-input); cursor: pointer; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.2s, border-color 0.2s;
        }
        .profile-avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .profile-avatar-wrapper .placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--text-muted); font-weight: bold; background: var(--bg-input); }

        .profile-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; min-height: 140px; padding-top:0; }
        .profile-name-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; min-height: 50px; }
        .profile-name { font-size: 2.5rem; font-weight: 900; color: var(--text-main); letter-spacing: -1px; line-height: 1.1; overflow-wrap: anywhere; white-space: normal; }        
        .profile-name-input { background: transparent; border: none; border-bottom: 2px solid var(--accent); color: var(--text-main); border-bottom-color: var(--text-main); font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 900; flex: 1; width: auto; min-width: 0; padding: 0; outline:none; font-family: inherit; }        .name-edit-container { display: none; flex: 1; width: auto; align-items: center; gap: 8px; }
        .name-edit-container.active { display: flex; }

        .prompt-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative; transition: border-color 0.2s; width: 100%; cursor: pointer; }
        .prompt-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; display: block; }
        .prompt-card.selected { border: 3px solid var(--accent); }
        .prompt-card.selected::after { content: 'âœ“'; position: absolute; top: 10px; left: 10px; width: 30px; height: 30px; background: var(--accent); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        .prompt-preview-text {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            color: var(--text-main); font-size: 0.75rem; padding: 6px 8px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            pointer-events: none; z-index: 2; border-top: 1px solid var(--border);
        }

        .ghost-overlay { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); padding: 5px; border-radius: 8px; border: 1px solid var(--border); opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 5; }
        
        .global-prompt-popup { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90vw; max-width: 400px; height: auto; min-height: 300px; max-height: 80vh; 
            background: var(--bg-card); backdrop-filter: blur(15px); 
            display: none; flex-direction: column; padding: 20px; justify-content: center; 
            z-index: 100000; border: 1px solid var(--accent); 
            box-shadow: 0 10px 50px rgba(0,0,0,0.9); border-radius: 12px;
            animation: popInCenter 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
        }
        .global-prompt-popup.active { display: flex; }
        .global-prompt-popup textarea { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); flex-grow: 1; max-height: 60%; margin-bottom: 10px; padding: 10px; font-family: inherit; border-radius: 8px; resize: none; }
        .global-prompt-popup textarea:focus { border-color: var(--accent); outline: none; }
        
        .context-menu {
            position: fixed; z-index: 100000;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 5px;
            display: none; flex-direction: column; min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            animation: popIn 0.1s ease-out;
        }
        .context-menu.active { display: flex; }
        .context-item {
            padding: 10px 15px; cursor: pointer;
            display: flex; align-items: center; gap: 10px;
            border-radius: 4px; font-size: 0.9rem; font-weight: 500;
            color: var(--text-muted); transition: 0.2s;
        }
        .context-item svg { width: 16px; height: 16px; }
        .context-item.danger { color: var(--error); }
        .context-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
        
        .global-input-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: var(--bg-card); border: 1px solid var(--accent);
            border-radius: 12px; padding: 20px; z-index: 200000;
            display: none; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .global-input-popup.active { display: flex; }
        
        .tool-btn { 
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            width: 34px; height: 34px; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .tool-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .tool-btn.active { background: var(--accent); color: var(--bg-card); border-color: var(--accent); }
        
        .back-btn { 
            display: inline-flex; align-items: center; justify-content: center; 
            width: 40px; height: 40px; border-radius: 12px; 
            color: var(--text-muted); cursor: pointer; margin-bottom: 20px; 
            position: relative; z-index: 10; font-weight: bold; 
            background: transparent; border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .icon-btn { background: transparent; border: none; width: 32px; height: 32px; cursor: pointer; color: var(--text-muted); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transition: 0.2s; padding:0; flex-shrink: 0;}
        .icon-btn.save { color: var(--success); }
        .btn-upload { background-color: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; transition: 0.2s; white-space: nowrap; }
        
        .btn-row { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; padding-top:5px; padding-bottom:5px; }
        
        .copy-btn { 
            background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border); 
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; font-family: inherit;
        }
        .save-btn { 
            background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid var(--success); 
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; font-family: inherit;
        }
        .btn-secondary { 
            background-color: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); 
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; 
            width:100%; text-align:center; font-family: inherit; margin-top: 20px;
        }

        .btn-add-section { background-color: transparent; color: #10b981; border: 1px solid #10b981; font-weight: 800; padding: 15px; width: 100%; margin-top: 25px; cursor: pointer; border-radius: 8px; font-family: inherit; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; position: relative; z-index: 20; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .delete-btn { color: var(--error); background: transparent; border: 1px solid var(--error); padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 40px; margin-bottom: 40px; position:relative; z-index:10; font-family: inherit; font-weight: bold; display: block; text-align: center; font-size: 1rem; }
        
        .global-tools { display: flex; gap: 10px; justify-content: flex-end; margin-bottom: 0px; flex-wrap: wrap; align-items: center; }
        .tools-left { display: flex; gap: 10px; }
        .tools-right { display: flex; gap: 10px; }
        .tool-text-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 4px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}

        .form-column-container { display: flex; flex-direction: column; gap: 20px; width: 100%; margin: 0 auto; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; padding: 0; display: flex; flex-direction: column; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-bottom:0; overflow:hidden;}
        .glass-card.collapsed .card-body { display: none; }
        .glass-card.collapsed { opacity: 0.8; }
        .glass-card.over-limit { border-color: var(--error); }
        .glass-card.dragging { opacity: 0.4; border: 2px dashed var(--accent); transform: scale(0.98); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; cursor: pointer; padding: 20px; user-select: none; }
        .card-header-left { display: flex; align-items: center; gap: 10px; flex-grow: 1; pointer-events: none; }
        .card-header-left * { pointer-events: auto; }
        .card-controls { display: flex; align-items: center; gap: 8px; }
        
        .drag-handle { cursor: grab; opacity: 0.5; padding: 5px; transition: 0.2s; touch-action: none; display: none; }
        @media (hover: hover) { .drag-handle:hover { opacity: 1; color: var(--text-main); } }
        .drag-handle:active { cursor: grabbing; }
        
        .card-arrow { transition: 0.3s; }
        .collapsed .card-arrow { transform: rotate(-90deg); }
        .card-body { display: block; border-top: 1px solid var(--border); padding: 20px; padding-top: 10px; margin-top: 0;}
        textarea.ghost-input { 
            background: transparent; border: none; border-bottom: 1px solid var(--border); 
            color: var(--text-main); padding: 10px 0; width: 100%; resize: none; 
            font-family: inherit; font-size: 0.95rem; line-height: 1.6; 
            transition: border-bottom-color 0.2s; border-radius: 0; height: auto;
            min-height: 60px; max-height: 300px; overflow-y: hidden; display: block;
        }
        textarea.ghost-input:focus { outline: none; border-bottom-color: var(--accent); background: var(--bg-input); }
        
        .tab-nav { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; justify-content: space-between; align-items: center; position: relative; z-index: 10; min-height: 42px; }
        .tab-left { display: flex; gap: 20px; }
        .tab-btn { background: none; border: none; color: var(--text-muted); font-size: 1.1rem; font-weight: bold; cursor: pointer; padding: 5px 10px; font-family: inherit; }
        .tab-btn.active { color: var(--text-main); border-bottom: 2px solid var(--accent); }
        
        .traits-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; min-height:36px; }
        .traits-header { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--text-muted); }
        .add-trait-btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.7rem; }
        
        #traitInput { display: none; background:transparent; border:none; color: var(--text-main); border-bottom: 1px solid var(--text-main); width:100%; padding:5px; margin-top:0; font-family: inherit;}
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag { background: var(--accent); color: #000; font-weight:600; padding: 2px 10px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; }

        .custom-select-wrapper { position: relative; display: inline-block; margin-top: 0; z-index: 9999; width: 100%; }
        .custom-select-trigger { background: var(--accent); color: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; transition: 0.2s; }
        .custom-select-trigger:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .custom-options { position: absolute; top: 100%; left: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; display: none; z-index: 10000; max-height: 300px; overflow-y: auto; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.9); }
        .custom-options.open { display: block; }
        .custom-option { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid var(--border); }
        .custom-option img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        
        /* UPDATED: Standard Grid (Left-to-Right) */
        .member-grid { 
            display: grid; 
            /* This automatically calculates columns based on available width */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 15px; 
            margin-top: 20px;
            align-items: start; /* Critical: Keeps neighbors top-aligned when one expands */
        }

        .member-card { 
            background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; text-align: center;
            transition: border-color 0.2s;
            width: 100%;
        }

        .member-card:hover { border-color: var(--accent); }
        .member-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); cursor: pointer; }
        .member-name { font-weight: 700; font-size: 1.1rem; cursor: pointer; }

        /* Keep the rest of your new styles (.member-role-input, etc) below this... */
        .member-role-input { 
            width: 100%; background: var(--bg-card); border: 1px solid var(--border); 
            border-radius: 6px; padding: 8px; color: var(--text-main); font-size: 0.85rem; 
            text-align: left; font-family: inherit; transition: 0.2s;
            resize: vertical; min-height: 80px; /* Make it tall enough to read! */
        }
        .member-role-input:focus { outline: none; border-color: var(--accent); background: var(--bg-input); }
        .member-remove { 
            position: absolute; top: 8px; right: 8px; color: var(--text-muted); 
            cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: 0.2s; 
        }
                /* Member Role Edit Styles */
                /* UPDATED: Handles long text gracefully */
        .member-role-display {
            width: 100%; min-height: 35px; padding: 6px; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
            border: 1px solid transparent; border-radius: 6px; cursor: pointer;
            font-size: 0.85rem; color: var(--text-muted); transition: 0.2s;
            max-width: 100%; /* Force it to stay within the card */
        }

        /* NEW: Styles specifically for the text inside the role box */
        .member-role-display span {
            white-space: nowrap;      /* Force text to one line */
            overflow: hidden;         /* Hide spillover */
            text-overflow: ellipsis;  /* Add "..." at the end */
            min-width: 0;             /* Critical flexbox fix to allow shrinking */
        }

        .member-role-display:hover { background: var(--bg-card); border-color: var(--border); color: var(--text-main); }

        .member-role-edit { display: none; width: 100%; gap: 5px; align-items: center; }
        .member-role-edit.active { display: flex; }

        .role-btn { 
            width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; border: 1px solid var(--border); background: var(--bg-card); flex-shrink: 0; font-weight:bold;
        }
        .role-btn.save { color: var(--success); border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .role-btn.cancel { color: var(--error); border-color: var(--error); background: rgba(239, 68, 68, 0.1); }
        .lightbox { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .lightbox.active { display: flex; }
        .lightbox-content { max-width: 95%; max-height: 95%; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid var(--border); animation: popIn 0.3s ease; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 9000; font-weight: bold; }
        .toast.show { opacity: 1; }
        
        .settings-modal { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn 0.2s ease-out; }
        .settings-modal.active { display: flex; }
        .settings-panel { 
            background: var(--bg-card); border: 1px solid var(--border); width: 600px; max-width: 95%; 
            border-radius: 16px; padding: 0; box-shadow: 0 15px 40px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; max-height: 85vh; overflow-y: auto; 
            animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
        }
        .settings-header { 
            padding: 20px 25px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; background: var(--bg-card); z-index: 5;
        }
        .settings-header h2 { margin: 0; color: var(--accent); font-size: 1.4rem; }
        .settings-close { font-size: 1.8rem; cursor: pointer; color: var(--text-muted); transition: color 0.2s; line-height: 1; }
        .settings-close:hover { color: var(--text-main); }
        
        .settings-body { padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .settings-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .settings-card h3 { margin: 0 0 15px 0; font-size: 0.95rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        
        .settings-input-group { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
        .settings-input-group input {
            width: 100%; background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text-main); padding: 12px; padding-right: 45px;
            border-radius: 8px; font-family: monospace; font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .settings-input-group input:focus { outline: none; border-color: var(--accent); }
        .settings-input-group input[readonly] { opacity: 0.7; cursor: default; }
        
        .input-edit-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: transparent; border: none; color: var(--text-muted);
            cursor: pointer; padding: 5px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .input-edit-btn.active { color: var(--success); }
        .input-edit-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.1); }
        
        .settings-row { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 15px; }
        .settings-row-label { font-size: 0.9rem; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 100%; }
        .theme-opt { height: 36px; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .theme-opt:hover { transform: scale(1.05); }
        
        /* STORAGE DASHBOARD STYLES */
        .storage-viz-container { margin-bottom: 20px; }
        .storage-bar-header { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; font-weight: bold; }
        .storage-bar-legend { display: flex; gap: 15px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        .legend-dot.nomi { background: var(--accent); }
        .legend-dot.group { background: var(--success); }
        
        .storage-bar {
            width: 100%; height: 12px; background: var(--border); border-radius: 6px; overflow: hidden; display: flex;
        }
        .storage-bar-seg { height: 100%; transition: width 0.5s ease-out; }
        .storage-bar-seg.nomi { background: var(--accent); }
        .storage-bar-seg.group { background: var(--success); }
        
        .storage-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .storage-stat-box { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border); 
            border-radius: 8px; padding: 12px; text-align: center; display: flex; flex-direction: column; 
        }
        .stat-val { font-size: 1.2rem; font-weight: 900; color: var(--text-main); line-height: 1.2; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; font-weight: 600; }
        
        .storage-list { display: flex; flex-direction: column; gap: 6px; max-height: 150px; overflow-y: auto; }
        .storage-list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.9rem; padding: 8px; border-bottom: 1px solid var(--border); 
        }
        .storage-list-item:last-child { border-bottom: none; }
        .list-name { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .list-size { font-family: monospace; color: var(--text-muted); }
        
        .image-option-modal { display: none; position: fixed; z-index: 6000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .image-option-modal.active { display: flex; }
        .image-option-panel { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--accent); text-align: center; gap: 15px; display: flex; flex-direction: column; width: 300px; animation: popIn 0.3s; }
        .image-option-btn { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }

        .crop-modal { display: none; position: fixed; z-index: 7000; top: 0; left: 0; width: 100%; height: 100%; background: #000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-modal.active { display: flex; }
        .crop-container { width: 400px; height: 400px; border: 2px solid var(--border); position: relative; overflow: hidden; background: #111; cursor: grab; max-width: 100%; }
        .crop-container:active { cursor: grabbing; }
        .crop-image { position: absolute; top:0; left:0; transform-origin: 0 0; }
        .circle-guide { 
            pointer-events: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: 2px solid var(--accent); border-radius: 50%; box-shadow: 0 0 0 200px rgba(0,0,0,0.7); 
        }

        .crop-controls { margin-top: 20px; display: flex; gap: 20px; align-items: center; width: 400px; max-width: 90%; }
        .crop-slider { flex-grow: 1; }
        .crop-btns { margin-top: 20px; display: flex; gap: 10px; }
        
        select.select-input {
            appearance: none; -webkit-appearance: none; background-color: var(--bg-input);
            color: var(--text-main); border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 12px; padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");            background-repeat: no-repeat;
            background-position: right 10px center; background-size: 14px; cursor: pointer;
        }
        select.select-input:focus { outline: none; border-color: var(--accent); }

        /* --- RESPONSIVE --- */
       @media (max-width: 768px) {
        .main-content { padding: 15px; width: 100%; padding-bottom: 50px; }
        .hero-bg { left: 0; }
        .profile-header-card { flex-direction: column; text-align: center; padding: 15px; align-items: center; }
        .profile-avatar-wrapper { width: 100px; height: 100px; }
        .profile-info { width: 100%; min-height: auto; padding-top: 5px; }
        .profile-name { font-size: 2rem; flex-grow: 1; text-align: center; margin: 0; padding: 0 5px; white-space: normal; overflow: visible; text-overflow: clip; word-break: break-word; }
        .profile-name-row { display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative; margin-bottom: 10px; }
        .profile-name-row::before { content: ''; width: 32px; flex-shrink: 0; display: block; }
        .profile-name-row .icon-btn { position: static; transform: none; flex-shrink: 0; }
        .name-edit-container.active { position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 10; padding: 0 5px; }
        .traits-header { justify-content: center; }
        .traits-row { justify-content: center; }
        .tag-container { justify-content: center; }
        .custom-select-wrapper { display: flex; justify-content: center; width: 100%; }
        .search-input.active { width: 200px; right: 50px; }
        .gallery-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .gallery-grid.list-mode { grid-template-columns: 1fr; }
        .tab-nav { flex-direction: column; align-items: stretch; gap: 15px; margin-bottom: 25px; }
        .tab-left { width: 100%; justify-content: flex-start; }
        .settings-panel, .chat-panel { width: 100%; height: 100%; border-radius: 0; max-width: 100%;}
        .crop-container { width: 90vw; height: 90vw; max-width: 400px; max-height: 400px; }
        .circle-guide { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7); }
        .crop-controls { width: 90vw; }
        .delete-btn { width: 100%; float: none; margin-top: 20px; padding: 15px; font-size: 1.1rem; }
        .fab-group { bottom: 20px; right: 20px; }
        .global-tools { width: 100%; justify-content: space-between; }
        
        .gallery-toolbar { flex-direction: column; align-items: stretch; gap: 10px; }
        .gallery-search { width: 100%; }
        .gallery-tools-right { justify-content: space-between; width: 100%; }
        .gallery-tools-right .btn-upload, 
        .gallery-tools-right .tool-btn { flex-grow: 1; justify-content: center; }
    }
        
        @media (max-width: 480px) {
            .masonry-grid { grid-template-columns: repeat(2, 1fr); }
            .ghost-overlay { opacity: 1 !important; pointer-events: auto !important; background: rgba(0,0,0,0.4); bottom: 0; top: auto; right: 0; left: 0; justify-content: center; padding: 5px 0; border-radius: 0; border: none; }
            .tool-btn { width: 24px; height: 24px; }
            .tool-btn svg { width: 14px; height: 14px; }
            .prompt-preview-text { bottom: 34px !important; border-bottom: 1px solid var(--border); }
        }
        @media (min-width: 1024px) {
            .form-column-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
            #card_backstory, #card_group_backstory { grid-column: 1 / -1; }
        }
        @media (min-width: 769px) {
            .profile-header-card { padding-top: 15px; padding-bottom: 15px; }
            .profile-info { position: relative; height: 140px; justify-content: center; }
            .profile-name-row { margin-bottom: 0; width: 100%; }
            #viewGroup .profile-info { justify-content: center; }
            #viewGroup .profile-name-row { position: relative; top: 0; }
            .traits-row { position: absolute; bottom: 5px; left: 0; width: 100%; }
        }
    </style>
    <script> 
        const THEMES = {
            midnight: {
                '--bg-body': '#0f1115', '--bg-card': '#181b21',
                '--glass-bg': 'rgba(24, 27, 33, 0.75)', '--glass-border': 'rgba(255, 255, 255, 0.08)',
                '--bg-input': '#090a0c', '--accent': '#c084fc', '--accent-dim': 'rgba(192, 132, 252, 0.1)',
                '--accent-hover': '#a855f7', '--text-main': '#e4e4e7', '--text-muted': '#a1a1aa',
                '--border': '#27272a', '--success': '#10b981', '--error': '#ef4444'
            },
            paper: {
                '--bg-body': '#f3f4f6', '--bg-card': '#ffffff',
                '--glass-bg': 'rgba(255, 255, 255, 0.9)', '--glass-border': 'rgba(0, 0, 0, 0.12)',
                '--bg-input': '#ffffff', '--accent': '#4f46e5', '--accent-dim': 'rgba(79, 70, 229, 0.1)',
                '--accent-hover': '#4338ca', '--text-main': '#1f2937', '--text-muted': '#6b7280',
                '--border': '#d1d5db', '--success': '#059669', '--error': '#dc2626'
            },
            oled: {
                '--bg-body': '#000000', '--bg-card': '#000000',
                '--glass-bg': 'rgba(0, 0, 0, 0.85)', '--glass-border': 'rgba(255, 255, 255, 0.2)',
                '--bg-input': '#000000', '--accent': '#e879f9', '--accent-dim': 'rgba(232, 121, 249, 0.1)',
                '--accent-hover': '#d946ef', '--text-main': '#ffffff', '--text-muted': '#a3a3a3',
                '--border': '#333333', '--success': '#22c55e', '--error': '#ef4444'
            },
            terminal: {
                '--bg-body': '#050505', '--bg-card': '#0a0a0a',
                '--glass-bg': 'rgba(10, 10, 10, 0.9)', '--glass-border': 'rgba(0, 255, 65, 0.3)',
                '--bg-input': '#000000', '--accent': '#00ff41', '--accent-dim': 'rgba(0, 255, 65, 0.1)',
                '--accent-hover': '#008f11', '--text-main': '#00ff41', '--text-muted': '#008f11',
                '--border': '#003b00', '--success': '#00ff41', '--error': '#f87171'
            }
        };

        (function() {
            try {
                const saved = localStorage.getItem('nomi_theme') || 'midnight';
                const t = THEMES[saved] || THEMES['midnight'];
                for (const [key, value] of Object.entries(t)) {
                    document.documentElement.style.setProperty(key, value);
                }
            } catch(e) {}
        })();
    </script>
</head>
<body>

<div id="lightbox" class="lightbox" onclick="app.closeLightbox()">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightboxImg">
</div>

<div class="global-prompt-popup" id="globalPromptPopup" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <strong style="color:var(--accent);">Edit Prompt</strong>
        <span style="cursor:pointer; font-size:1.2rem;" onclick="app.closePromptPopup()">âœ•</span>
    </div>
    <textarea id="globalPromptInput" placeholder="Enter prompt here..."></textarea>
    <div class="btn-row" style="margin-top:0;">
        <div style="display:flex; gap:10px;">
            <button class="save-btn" onclick="app.savePromptManual()">Save</button>
            <button class="copy-btn" style="color:var(--error); border-color:var(--error); background: transparent;" onclick="app.closePromptPopup()">Cancel</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="copy-btn" onclick="app.pasteText('globalPromptInput')">Paste</button>
            <button class="copy-btn" onclick="app.copyText('globalPromptInput')">Copy</button>
        </div>
    </div>
</div>

<div id="contextMenu" class="context-menu" onclick="event.stopPropagation()"></div>

<div id="globalInputPopup" class="global-input-popup" onclick="event.stopPropagation()">
    <h3 style="margin:0; color:var(--accent);">Rename</h3>
    <input type="text" id="globalRenameInput" class="settings-input-group" style="width:100%; margin:0; padding:10px; background:var(--bg-input); border:1px solid var(--border); color:var(--text-main); border-radius:6px;" onkeydown="if(event.key==='Enter') app.confirmRename()">
    <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn-secondary" style="margin:0; width:auto;" onclick="document.getElementById('globalInputPopup').classList.remove('active')">Cancel</button>
        <button class="save-btn" onclick="app.confirmRename()">Save</button>
    </div>
</div>

<input type="file" id="contextUpload" style="display:none;" accept="image/*" onchange="cropper.init(this, 'context')">

<div id="cropModal" class="crop-modal">
    <div class="crop-container" id="cropContainer" 
         onmousedown="cropper.startDrag(event)" 
         ontouchstart="cropper.startDrag(event)"
         onwheel="cropper.handleWheel(event)">
        
        <img id="cropTarget" class="crop-image" draggable="false">
        <div id="cropGuide" class="circle-guide"></div>
    </div>
    <div class="crop-controls">
        <span>Zoom:</span>
        <input type="range" min="0.1" max="1.5" step="0.01" value="1" class="crop-slider" id="cropZoom" oninput="cropper.setZoom(this.value)">
    </div>
    <div class="crop-btns">
        <button class="btn-secondary" style="margin:0;" onclick="cropper.cancel()">Cancel</button>
        <button class="save-btn" onclick="cropper.save()">Set</button>
    </div>
</div>

<div id="imageOptionModal" class="image-option-modal" onclick="if(event.target===this) this.classList.remove('active')">
    <div class="image-option-panel">
        <h3 style="margin:0;color:var(--accent)">Set Image As...</h3>
        <button class="image-option-btn" onclick="app.confirmImageSet('profile')">Profile Picture</button>
        <button class="btn-secondary" onclick="document.getElementById('imageOptionModal').classList.remove('active')">Cancel</button>
    </div>
</div>

<div id="settingsModal" class="settings-modal" onclick="if(event.target === this) app.toggleSettings()">
    <div class="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <span class="settings-close" onclick="app.toggleSettings()">Ã—</span>
        </div>
        
        <div class="settings-body">
            <div class="settings-card">
                <h3>Integrations</h3>
                <span class="settings-label">Nomi.ai API Key</span>
                <div class="settings-input-group">
                    <input type="password" id="apiKeyInput" readonly placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    <button class="input-edit-btn" onclick="app.toggleEdit('apiKeyInput', this, 'apiKey')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </button>
                </div>
                <button class="btn-secondary" style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px;" onclick="app.syncFromApi()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Import from Nomi.ai
                </button>
            </div>

            <div class="settings-card">
                <h3>
                    Cloud Sync (GitHub Gist) 
                    <button class="icon-btn" onclick="app.toggleCloudHelp()" title="Help" style="width:24px; height:24px; font-size:0.8rem; background:transparent;">?</button>
                </h3>
                
                <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="cloudSyncCheck" style="width:18px; height:18px; accent-color:var(--accent);" onchange="app.toggleCloudSync(this.checked)">
                    <label for="cloudSyncCheck" style="cursor:pointer; font-size:0.9rem;">Enable Auto-Sync</label>
                </div>

                <span class="settings-label">GitHub Token</span>
                <div class="settings-input-group">
                    <input type="password" id="ghTokenInput" readonly placeholder="ghp_xxxxxxxxxxxx...">
                    <button class="input-edit-btn" onclick="app.toggleEdit('ghTokenInput', this, 'ghToken')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </button>
                </div>

                <span class="settings-label">Gist ID (nomi-data.json)</span>
                <div class="settings-input-group">
                    <input type="password" id="gistIdInput" readonly placeholder="e.g. 8f7d...">
                    <button class="input-edit-btn" onclick="app.toggleEdit('gistIdInput', this, 'gistId')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    </button>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center;">
                    <button class="tool-text-btn" onclick="app.exportCloudCreds()">Export Keys</button>
                    <button class="tool-text-btn" onclick="document.getElementById('importKeysFile').click()">Import Keys</button>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" onclick="app.cloudUpload()" style="flex:1;">Upload</button>
                    <button class="btn-secondary" onclick="app.cloudDownload()" style="flex:1;">Download</button>
                </div>
            </div>

            <div class="settings-card">
                <h3>Appearance</h3>
                <div class="settings-row">
                    <span class="settings-row-label">App Theme</span>
                    <select id="themeSelect" class="select-input" style="width:60%;" onchange="app.setTheme(this.value)">
                        <option value="midnight">Midnight (Default)</option>
                        <option value="paper">Paper (Light)</option>
                        <option value="oled">OLED (True Black)</option>
                        <option value="terminal">Terminal</option>
                    </select>
                </div>
                <div class="settings-row">
                    <span class="settings-row-label">Start-Up View</span>
                    <select id="startUpSelect" class="select-input" style="width:60%;" onchange="app.saveSetting('startView', this.value)">
                        <option value="home">Dashboard</option>
                        <option value="last">Last Visited Page</option>
                    </select>
                </div>
            </div>

            <div class="settings-card">
                <h3>Local Data</h3>
                
                <div class="storage-viz-container">
                    <div class="storage-bar-header">
                        <span>Storage Usage</span>
                        <div class="storage-bar-legend">
                            <div class="legend-item"><div class="legend-dot nomi"></div>Nomis</div>
                            <div class="legend-item"><div class="legend-dot group"></div>Groups</div>
                        </div>
                    </div>
                    <div class="storage-bar">
                        <div id="barNomis" class="storage-bar-seg nomi" style="width:0%"></div>
                        <div id="barGroups" class="storage-bar-seg group" style="width:0%"></div>
                    </div>
                </div>

                <div class="storage-grid">
                    <div class="storage-stat-box">
                        <span class="stat-val" id="statTotalImages">0</span>
                        <span class="stat-lbl">Total Images</span>
                    </div>
                    <div class="storage-stat-box">
                        <span class="stat-val" id="statTotalNomis">0</span>
                        <span class="stat-lbl">Total Nomis</span>
                    </div>
                    <div class="storage-stat-box">
                        <span class="stat-val" id="statStorageUsed">0 MB</span>
                        <span class="stat-lbl">Storage Used</span>
                    </div>
                </div>

                <div class="storage-list">
                    <div style="font-size:0.8rem; font-weight:bold; color:var(--text-muted); margin-bottom:5px;">TOP 3 LARGEST PROFILES</div>
                    <div id="storageTopList"></div>
                </div>

                <div style="height:1px; background:var(--border); margin:20px 0;"></div>

                <button class="btn-secondary" id="btnOptimize" onclick="app.optimizeStorage()" style="width:100%; margin-top:0; margin-bottom:10px; border-color:var(--accent); color:var(--accent);">
                    Optimize Storage (Compress Images)
                </button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" onclick="app.exportData()" style="flex:1;">Backup (File)</button>
                    <button class="btn-secondary" onclick="document.getElementById('importFile').click()" style="flex:1;">Restore (File)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="cloudHelpModal" class="settings-modal" onclick="if(event.target === this) app.toggleCloudHelp()">
    <div class="settings-panel" style="max-width:500px; width:90%; max-height:85vh; display:flex; flex-direction:column;">
        
        <div class="settings-header" style="flex-shrink:0;">
            <h2>Cloud Sync Setup</h2>
            <span class="settings-close" onclick="app.toggleCloudHelp()">Ã—</span>
        </div>
        
        <div style="padding:20px; line-height:1.5; color:var(--text-muted); font-size:0.9rem; overflow-y:auto;">
            <p style="margin-top:0;">To sync data between devices, Nomi Manager uses a free <strong>GitHub Gist</strong> as your private cloud storage.</p>
            
            <h3 style="color:var(--text-main); margin:15px 0 10px 0; font-size:1rem;">Step 1: Get a Token</h3>
            <ol style="padding-left:20px; margin:0;">
                <li>Log in to GitHub.</li>
                <li>Go to <strong>Settings > Developer Settings > Personal Access Tokens (Classic)</strong>.</li>
                <li>Click <strong>Generate New Token (Classic)</strong>.</li>
                <li>Note: "Nomi App".</li>
                <li><strong>Scopes:</strong> Check the box for <strong>gist</strong>.</li>
                <li>Generate and Copy the token (starts with <code style="word-break:break-all;">ghp_...</code>).</li>
            </ol>

            <h3 style="color:var(--text-main); margin:15px 0 10px 0; font-size:1rem;">Step 2: Create the File</h3>
            <ol style="padding-left:20px; margin:0;">
                <li>Go to <strong>gist.github.com</strong>.</li>
                <li>Description: "Nomi Data".</li>
                <li>Filename: <strong>nomi-data.json</strong>.</li>
                <li>Content: Type <code>{}</code> (curly braces).</li>
                <li>Click <strong>Create Secret Gist</strong>.</li>
                <li>Copy the <strong>Gist ID</strong> from the URL.</li>
            </ol>
            
            <div style="margin-top:20px; padding:12px; background:var(--bg-input); border-radius:8px; font-size:0.85rem;">
                <strong>Tip:</strong> Once setup, use <strong>"Export Keys"</strong> to save a file to easily import on other devices!
            </div>
        </div>
        
        <div style="padding:15px; border-top:1px solid var(--border); flex-shrink:0;">
            <button class="btn-secondary" style="width:100%; margin:0;" onclick="app.toggleCloudHelp()">Close</button>
        </div>
    </div>
</div>

<div class="fab-group">
    <div class="sync-pill" id="syncBtn" onclick="app.cloudUpload()">
        <span id="syncText" class="sync-text">Syncing...</span>
        <svg id="syncIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
    </div>
    <div class="fab-btn" onclick="app.toggleSettings()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </div>
</div>

<div class="main-content">
    <div id="heroBackground" class="hero-bg"></div>

    <div id="viewHome">
        <div class="top-bar">
            <h2>
                <img src="logo.svg" class="app-logo" style="width:32px; height:32px;">
                Nomi Manager
            </h2>
            <div class="search-wrapper">
                <div class="view-toggles">
                    <button class="view-btn active" id="btnViewGrid" onclick="app.setDashboardView('grid')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    </button>
                    <button class="view-btn" id="btnViewList" onclick="app.setDashboardView('list')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                    </button>
                </div>
                <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="app.renderGallery()">
                <button class="search-icon-btn" onclick="document.getElementById('searchInput').classList.toggle('active'); document.getElementById('searchInput').focus();">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </div>
        </div>

        <div class="section-divider">
            <span>My Nomis</span>
            <button class="btn-action" style="font-size:0.8rem; padding: 5px 10px;" onclick="app.createNomi()">+ Create</button>
        </div>
        <div class="gallery-grid" id="nomiGallery"></div>
        
        <div class="section-divider">
            <span>Groups</span>
            <button class="btn-action" style="font-size:0.8rem; padding: 5px 10px;" onclick="app.createGroup()">+ Create</button>
        </div>
        <div class="gallery-grid" id="groupGallery"></div>
    </div>

    <div id="viewNomi" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:relative; z-index:20;">
            <button class="back-btn" onclick="app.goHome()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </button>
        </div>
        
        <div class="profile-header-card">
            <div class="profile-avatar-wrapper clickable" onclick="document.getElementById('nomiPhotoInput').click()">
                <img id="nomiImageDisplay" src="" style="display:none;">
                <div id="nomiImagePlaceholder" class="placeholder">?</div>
                <input type="file" id="nomiPhotoInput" accept="image/*" style="display:none;" onchange="cropper.init(this, 'nomi')">
            </div>
            <div class="profile-info">
                <div class="profile-name-row">
                    <div id="nomiNameDisplay" class="profile-name">Name</div>
                    <button id="nomiEditBtn" class="icon-btn" onclick="app.toggleNameEdit('nomi', true)" style="color:rgba(255,255,255,0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                        <div id="nomiNameEdit" class="name-edit-container">
                            <input type="text" class="profile-name-input" id="nomiName" placeholder="Name" maxlength="30" onkeydown="if(event.key==='Enter') app.saveName('nomi')">
                            <button class="icon-btn save" onclick="app.saveName('nomi')"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                            <button class="icon-btn" onclick="app.cancelNameEdit('nomi')" style="color:#ef4444;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        </div>
                    </div>
                <div class="traits-row">
                    <span class="traits-header">Traits <button class="add-trait-btn" onclick="document.getElementById('traitInput').style.display='block';document.getElementById('traitInput').focus()">+</button></span>
                    <input type="text" id="traitInput" placeholder="Add..." maxlength="20" style="width:80px; display:none;">
                    <div class="tag-container" id="traitContainer" style="margin:0;"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-nav">
            <div class="tab-left">
                <button class="tab-btn active" id="tabProfile" onclick="app.switchTab('profile')">Profile Data</button>
                <button class="tab-btn" id="tabGallery" onclick="app.switchTab('gallery')">Gallery</button>
            </div>
        </div>

        <div id="contentProfile">
            <div class="gallery-toolbar" id="expandTools">
            <div class="tools-left">
                <button class="tool-btn" onclick="app.copyAllSections(false)" title="Copy All Sections"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></button>
                <button class="tool-btn" id="btnSortNomi" onclick="app.toggleReorderMode()" title="Sort / Reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></button>
                <button class="tool-btn" id="btnResetNomi" onclick="app.resetSort()" title="Reset Order" style="visibility:hidden;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
            </div>
            <div class="tools-right">
                <button class="tool-text-btn" onclick="app.setAllSections(false)">â–¼ Expand</button>
                <button class="tool-text-btn" onclick="app.setAllSections(true)">â–² Collapse</button>
            </div>
        </div>
            <div class="form-column-container" id="profileGrid"></div>
            <button class="btn-add-section" onclick="app.addNomiSection()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Custom Section
            </button>
            <button class="delete-btn" onclick="app.deleteNomi()">Delete Nomi</button>
        </div>
        
        <div id="contentGallery" style="display:none;">
            <div class="gallery-toolbar">
                <input type="text" class="gallery-search" id="nomiGallerySearch" placeholder="Search prompts..." oninput="app.filterGallery(this.value)">
                
                <div class="gallery-tools-right">
                    <button class="tool-btn" title="Sort Order" onclick="app.toggleGallerySort()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18H3M21 6H3M17 12H3"/></svg>
                    </button>
                    <div style="position:relative;">
                        <button class="tool-btn hide-mobile" title="Grid Size" onclick="app.toggleGridMenu(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        </button>
                        <div class="grid-menu" onclick="event.stopPropagation()">
                            <div class="grid-slider-row">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h4v4H4zM10 4h4v4h-4zM16 4h4v4h-4zM4 10h4v4H4zM10 10h4v4h-4zM16 10h4v4h-4zM4 16h4v4H4zM10 16h4v4h-4zM16 16h4v4h-4zM4 16h4v4h-4z"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h7v7H4zM13 4h7v7h-7zM13 13h7v7h-7zM4 13h7v7H4z"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 2h20v20H2z"/></svg>
                            </div>
                            <input type="range" class="custom-slider" min="0" max="3" step="1" value="1" oninput="app.setGallerySize(this.value)">
                        </div>
                    </div>
                    <button class="tool-btn" title="Show/Hide Prompts" onclick="app.toggleShowPrompts()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    
                    <button class="tool-btn" id="btnBatchMode" title="Batch Select Mode" onclick="app.toggleBatchMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                    <button class="tool-btn del" id="btnBatchDelete" title="Delete Selected" style="display:none;" onclick="app.deleteBatchImages()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <button class="btn-upload" style="background:var(--bg-card); border:1px solid var(--border); color:var(--text-main);" onclick="app.pasteGalleryImage()">Paste from Clipboard</button>
                    <button class="btn-upload" onclick="document.getElementById('galleryUpload').click()">Upload</button>
                    <input type="file" id="galleryUpload" accept="image/*" multiple style="display:none" onchange="app.addGalleryImages(this)">
                </div>
            </div>
            <div class="masonry-grid" id="promptGalleryGrid"></div>
        </div>
    </div>

    <div id="viewGroup" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:relative; z-index:20;">
            <button class="back-btn" onclick="app.goHome()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </button>
        </div>
        
        <div class="profile-header-card">
            <div class="profile-avatar-wrapper clickable" onclick="document.getElementById('groupPhotoInput').click()">
                <img id="groupImageDisplay" src="" style="display:none;">
                <div id="groupImagePlaceholder" class="placeholder">G</div>
                <input type="file" id="groupPhotoInput" accept="image/*" style="display:none;" onchange="cropper.init(this, 'group')">
            </div>
            <div class="profile-info">
                <div class="profile-name-row">
                    <div id="groupNameDisplay" class="profile-name">Group Name</div>
                    <button id="groupEditBtn" class="icon-btn" onclick="app.toggleNameEdit('group', true)" style="color:rgba(255,255,255,0.7);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                        <div id="groupNameEdit" class="name-edit-container">
                            <input type="text" class="profile-name-input" id="groupName" placeholder="Group Name" maxlength="50" onkeydown="if(event.key==='Enter') app.saveName('group')">
                            <button class="icon-btn save" onclick="app.saveName('group')"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
                            <button class="icon-btn" onclick="app.cancelNameEdit('group')" style="color:#ef4444;"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                        </div>
                    </div>
            </div>
        </div>
        
        <div class="tab-nav">
             <div class="tab-left">
                <button class="tab-btn active" id="tabGroupProfile" onclick="app.switchGroupTab('profile')">Group Data</button>
                <button class="tab-btn" id="tabGroupMembers" onclick="app.switchGroupTab('members')">Members</button>
                <button class="tab-btn" id="tabGroupGallery" onclick="app.switchGroupTab('gallery')">Gallery</button>
            </div>
        </div>
        
        <div id="contentGroupProfile">
            <div class="gallery-toolbar" id="groupExpandTools">
             <div class="tools-left">
                <button class="tool-btn" onclick="app.copyAllSections(true)" title="Copy All Sections"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></button>
                <button class="tool-btn" id="btnSortGroup" onclick="app.toggleReorderMode()" title="Sort / Reorder"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15l5 5 5-5"/><path d="M7 9l5-5 5 5"/></svg></button>
                <button class="tool-btn" id="btnResetGroup" onclick="app.resetSort()" title="Reset Order" style="visibility:hidden;"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
             </div>
             <div class="tools-right">
                <button class="tool-text-btn" onclick="app.setAllSections(false)">â–¼ Expand</button>
                <button class="tool-text-btn" onclick="app.setAllSections(true)">â–² Collapse</button>
             </div>
        </div>
            <div id="groupSectionsContainer" class="form-column-container"></div>
            
            <button class="btn-add-section" onclick="app.addGroupSection()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Add Custom Section
            </button>
            <button class="delete-btn" onclick="app.deleteGroup()">Delete Group</button>
        </div>

        <div id="contentGroupMembers" style="display:none;">
             <div class="custom-select-wrapper" id="memberDropdownWrapper">
                <div class="custom-select-trigger" onclick="app.toggleMemberDropdown()">+ Add Member</div>
                <div class="custom-options" id="memberOptions"></div>
            </div>
            <div id="groupMembersGrid" class="member-grid"></div>
        </div>

        <div id="contentGroupGallery" style="display:none;">
            <div class="gallery-toolbar">
                <input type="text" class="gallery-search" id="groupGallerySearch" placeholder="Search prompts..." oninput="app.filterGallery(this.value)">
                
                <div class="gallery-tools-right">
                    <button class="tool-btn" title="Sort Order" onclick="app.toggleGallerySort()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18H3M21 6H3M17 12H3"/></svg>
                    </button>
                    <div style="position:relative;">
                        <button class="tool-btn hide-mobile" title="Grid Size" onclick="app.toggleGridMenu(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        </button>
                        <div class="grid-menu" onclick="event.stopPropagation()">
                            <div class="grid-slider-row">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h4v4H4zM10 4h4v4h-4zM16 4h4v4h-4zM4 10h4v4H4zM10 10h4v4h-4zM16 10h4v4h-4zM4 16h4v4H4zM10 16h4v4h-4zM16 16h4v4h-4zM4 16h4v4h-4z"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h7v7H4zM13 4h7v7h-7zM13 13h7v7h-7zM4 13h7v7H4z"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2 2h20v20H2z"/></svg>
                            </div>
                            <input type="range" class="custom-slider" min="0" max="3" step="1" value="1" oninput="app.setGallerySize(this.value)">
                        </div>
                    </div>
                    <button class="tool-btn" title="Show/Hide Prompts" onclick="app.toggleShowPrompts()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    
                    <button class="tool-btn" id="btnBatchMode" title="Batch Select Mode" onclick="app.toggleBatchMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                    <button class="tool-btn del" id="btnBatchDelete" title="Delete Selected" style="display:none;" onclick="app.deleteBatchImages()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <button class="btn-upload" style="background:var(--bg-card); border:1px solid var(--border); color:var(--text-main);" onclick="app.pasteGalleryImage()">Paste from Clipboard</button>
                    <button class="btn-upload" onclick="document.getElementById('groupGalleryUpload').click()">Upload</button>
                    <input type="file" id="groupGalleryUpload" accept="image/*" multiple style="display:none" onchange="app.addGalleryImages(this)">
                </div>
            </div>
            <div class="masonry-grid" id="groupPromptGalleryGrid"></div>
        </div>
    </div>

</div>

<input type="file" id="importFile" style="display:none" onchange="app.importData(this)">
<input type="file" id="importKeysFile" style="display:none" onchange="app.importCloudCreds(this)">
<input type="file" id="bannerUpload" style="display:none" accept="image/*" onchange="cropper.init(this, 'banner')">

<div class="toast" id="toast">Saved Successfully!</div>

<script>
// REGISTER SERVICE WORKER
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker failed', err));
    });
}

/** NOMI MANAGER v3.8 - SPLIT SYNC **/

const DB_NAME = 'NomiArchDB_v22';
const DB_VERSION = 1;

const DEFAULT_SECTIONS = [
    { id: 'backstory', label: 'Backstory', limit: 2000 },
    { id: 'inclination', label: 'Inclination', limit: 150 },
    { id: 'current_roleplay', label: 'Current Roleplay', limit: 750 },
    { id: 'your_appearance', label: 'Your Appearance', limit: 200 },
    { id: 'nomi_appearance', label: 'Nomi\'s Appearance', limit: 500 },
    { id: 'appearance_tendencies', label: 'Appearance Tendencies', limit: 200 },
    { id: 'nicknames', label: 'Nicknames', limit: 250 },
    { id: 'preferences', label: 'Preferences', limit: 500 },
    { id: 'desires', label: 'Desires', limit: 500 },
    { id: 'boundaries', label: 'Boundaries', limit: 500 }
];

const cropper = {
    active: false, img: null, scale: 1, posX: 0, posY: 0, isDragging: false, startX: 0, startY: 0, targetType: null, contextId: null,
    
    init(input, type) { 
        if(!input.files[0]) return; 
        this.targetType = type; 
        const reader = new FileReader(); 
        reader.onload = (e) => { this.openCropModal(e.target.result); }; 
        reader.readAsDataURL(input.files[0]); 
    },
    
    setContextId(id) { this.contextId = id; },

    initFromUrl(url, type) { this.targetType = type; this.openCropModal(url); },

    openCropModal(src) { 
        document.getElementById('cropModal').classList.add('active'); 
        const img = document.getElementById('cropTarget'); 
        img.src = src; 
        
        img.onload = () => { 
            const container = document.getElementById('cropContainer');
            const cw = container.offsetWidth;
            const ch = container.offsetHeight;
            const iw = img.naturalWidth;
            const ih = img.naturalHeight;
            this.scale = Math.max(cw / iw, ch / ih);
            this.posX = (cw - (iw * this.scale)) / 2;
            this.posY = (ch - (ih * this.scale)) / 2;
            this.updateTransform(); 
            document.getElementById('cropZoom').value = this.scale; 
        } 
    },

    setZoom(val) { 
        const oldScale = this.scale;
        this.scale = parseFloat(val); 
        const container = document.getElementById('cropContainer');
        const cx = container.offsetWidth / 2;
        const cy = container.offsetHeight / 2;
        const centerX = (cx - this.posX) / oldScale;
        const centerY = (cy - this.posY) / oldScale;
        this.posX = cx - (centerX * this.scale);
        this.posY = cy - (centerY * this.scale);
        this.updateTransform(); 
    },

    handleWheel(e) {
        e.preventDefault();
        const slider = document.getElementById('cropZoom');
        const delta = -Math.sign(e.deltaY) * 0.02; 
        let newScale = this.scale + delta;
        const min = parseFloat(slider.min);
        const max = parseFloat(slider.max);
        newScale = Math.max(min, Math.min(newScale, max));
        slider.value = newScale;
        this.setZoom(newScale);
    },

    startDrag(e) { 
        e.preventDefault(); 
        this.isDragging = true; 
        const clientX = e.touches ? e.touches[0].clientX : e.clientX; 
        const clientY = e.touches ? e.touches[0].clientY : e.clientY; 
        this.startX = clientX - this.posX; 
        this.startY = clientY - this.posY; 
        
        const moveHandler = (ev) => { 
            if(!this.isDragging) return; 
            const cx = ev.touches ? ev.touches[0].clientX : ev.clientX; 
            const cy = ev.touches ? ev.touches[0].clientY : ev.clientY; 
            this.posX = cx - this.startX; 
            this.posY = cy - this.startY; 
            this.updateTransform(); 
        }; 
        
        const endHandler = () => { 
            this.isDragging = false; 
            document.removeEventListener('mousemove', moveHandler); 
            document.removeEventListener('mouseup', endHandler); 
            document.removeEventListener('touchmove', moveHandler); 
            document.removeEventListener('touchend', endHandler); 
        }; 
        
        document.addEventListener('mousemove', moveHandler); 
        document.addEventListener('mouseup', endHandler); 
        document.addEventListener('touchmove', moveHandler); 
        document.addEventListener('touchend', endHandler); 
    },

    updateTransform() { 
        document.getElementById('cropTarget').style.transform = `translate(${this.posX}px, ${this.posY}px) scale(${this.scale})`; 
    },

    save() {
        const guide = document.getElementById('cropGuide');
        const img = document.getElementById('cropTarget');
        const container = document.getElementById('cropContainer');
        const guideRect = guide.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        const offsetLeft = guideRect.left - containerRect.left;
        const offsetTop = guideRect.top - containerRect.top;
        const width = guideRect.width;
        const height = guideRect.height;
        
        const canvas = document.createElement('canvas'); 
        canvas.width = width; canvas.height = height; 
        const ctx = canvas.getContext('2d'); 
        
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,width,height);
        ctx.translate(-offsetLeft, -offsetTop);
        ctx.translate(this.posX, this.posY);
        ctx.scale(this.scale, this.scale);
        ctx.drawImage(img, 0, 0); 
        
        const dataUrl = canvas.toDataURL('image/webp', 0.8);
        
        if(this.targetType === 'nomi') {
            app.setNomiPhoto(dataUrl, this.contextId);
        }
        else if(this.targetType === 'group') {
            app.setGroupPhoto(dataUrl, this.contextId);
        }
        else if (this.targetType === 'context') {
             const isGroup = app.data.groups.find(g => g.id === this.contextId);
             if(isGroup) app.setGroupPhoto(dataUrl, this.contextId);
             else app.setNomiPhoto(dataUrl, this.contextId);
        }
        
        this.cancel();
    },

    cancel() { 
        document.getElementById('cropModal').classList.remove('active'); 
        const n = document.getElementById('nomiPhotoInput'); if(n) n.value=''; 
        const g = document.getElementById('groupPhotoInput'); if(g) g.value='';
        const c = document.getElementById('contextUpload'); if(c) c.value='';
        this.contextId = null;
    }
};

class NomiApp {
    constructor() {
        this.db = null;
        this.data = { nomis: [], groups: [], settings: { theme: 'cyber', startView: 'home', lastNomi: null, apiKey: '', lastState: null } };
        this.currentNomiId = null;
        this.currentGroupId = null;
        this.contextMenuTarget = null;
        this.contextMenuType = null;
        this.isSyncing = false;
        this.isReordering = false;
        this.touchDragItem = null;
        this.resizeDebounce = null;
        this.dragSrcEl = null;
        this.isBatchMode = false;
        this.selectedImages = new Set();
        this.currentEditingImageId = null; 
        this.gallerySort = 'newest';
        this.gallerySize = 'medium';
        this.galleryShowPrompts = false;
        this.dashboardView = 'grid'; 
    }

    async init() {
        await this.openDB();
        await this.loadData();
        this.migrateData();
        
        if(this.data.settings.theme) localStorage.setItem('nomi_theme', this.data.settings.theme);
        this.applyTheme(this.data.settings?.theme || 'midnight');
        
        this.initStartView();
        
        const savedSize = localStorage.getItem('nomi_gallery_size') || 'medium';
        const sizes = ['small', 'medium', 'large', 'xlarge'];
        let sizeIdx = sizes.indexOf(savedSize);
        if(sizeIdx === -1) sizeIdx = 1;
        this.setGallerySize(sizeIdx);

        const savedDash = localStorage.getItem('nomi_dashboard_view') || 'grid';
        this.setDashboardView(savedDash, false); 

        this.renderGallery();
        
        document.getElementById('traitInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { this.addTrait(e.target.value); e.target.value = ''; document.getElementById('traitInput').style.display='none'; } });
        document.addEventListener('click', (e) => { 
            if(!e.target.closest('#memberDropdownWrapper')) document.getElementById('memberOptions').classList.remove('open'); 
            this.hideContextMenu();
        });
        document.addEventListener('paste', (e) => this.handleGlobalPaste(e));
        
        window.addEventListener('popstate', (event) => {
            document.getElementById('lightbox').classList.remove('active');
            if(event.state) {
                if(event.state.view === 'home') this.goHome(false);
                else if(event.state.view === 'nomi') this.editNomi(event.state.id, false, event.state.tab || 'profile');
                else if(event.state.view === 'group') this.editGroup(event.state.id, false, event.state.tab || 'profile');
            }
        });
        history.replaceState({view: 'home'}, '', '');
        
        setTimeout(() => document.body.style.opacity = '1', 50);

        if(this.data.settings.autoDownload) {
             const t = localStorage.getItem('nomi_gh_token');
             const g = localStorage.getItem('nomi_gist_id');
             if(t && g) this.cloudDownload(true);
        }
    }
    
    showContextMenu(e, id, type) {
        e.preventDefault();
        e.stopPropagation();
        this.contextMenuTarget = id;
        this.contextMenuType = type;
        const menu = document.getElementById('contextMenu');
        const targetObj = type === 'nomi' ? this.data.nomis.find(n => n.id === id) : this.data.groups.find(g => g.id === id);
        const name = targetObj.name;
        const close = "app.hideContextMenu()";

        let html = `<div style="padding:10px 15px; border-bottom:1px solid var(--border); font-size:0.85rem; color:var(--accent); font-weight:bold; opacity:0.8;">${name}</div>`;
        html += `<div class="context-item" onclick="${close}; app.openRenamePopup()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>Rename</div>`;
        html += `<div class="context-item" onclick="${close}; app.triggerContextUpload()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Change Photo</div>`;
        html += `<div class="context-item" onclick="${close}; app.copyProfilePicture()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>Copy PFP</div>`;

        if(type === 'nomi') {
            html += `<div class="context-item" onclick="${close}; app.duplicateNomi(${id})"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>Duplicate</div>`;
        }
        html += `<div class="context-item danger" onclick="${close}; app.deleteFromContext()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Delete</div>`;
        
        menu.innerHTML = html;
        menu.classList.add('active');
        
        let x = e.clientX; let y = e.clientY;
        const rect = menu.getBoundingClientRect();
        if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 10;
        if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 10;
        menu.style.left = x + 'px'; menu.style.top = y + 'px';
    }
    
    hideContextMenu() { document.getElementById('contextMenu').classList.remove('active'); }

    async copyProfilePicture() {
        this.hideContextMenu();
        const id = this.contextMenuTarget;
        const type = this.contextMenuType;
        const target = type === 'nomi' ? this.data.nomis.find(n => n.id === id) : this.data.groups.find(g => g.id === id);
        if (!target || !target.photo) return this.showToast("No photo available");

        try {
            this.showToast("Copying...");
            const img = new Image();
            img.src = target.photo;
            await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    this.showToast("Profile Picture Copied!");
                } catch (err) { this.showToast("Clipboard Write Failed (HTTPS required)"); }
            }, 'image/png');
        } catch (err) { this.showToast("Failed to process image"); }
    }
    
    triggerContextUpload() { cropper.setContextId(this.contextMenuTarget); document.getElementById('contextUpload').click(); }
    openRenamePopup() {
        const id = this.contextMenuTarget; const type = this.contextMenuType;
        const target = type === 'nomi' ? this.data.nomis.find(n => n.id === id) : this.data.groups.find(g => g.id === id);
        document.getElementById('globalRenameInput').value = target.name;
        document.getElementById('globalInputPopup').classList.add('active');
        setTimeout(() => document.getElementById('globalRenameInput').focus(), 50);
    }
    confirmRename() {
        const val = document.getElementById('globalRenameInput').value; if(!val.trim()) return;
        const id = this.contextMenuTarget; const type = this.contextMenuType;
        const target = type === 'nomi' ? this.data.nomis.find(n => n.id === id) : this.data.groups.find(g => g.id === id);
        target.name = val; this.saveToDB(); this.renderGallery();
        document.getElementById('globalInputPopup').classList.remove('active'); this.showToast("Renamed!");
    }
    duplicateNomi(id) {
        if(!confirm("Duplicate this Nomi?")) return;
        const original = this.data.nomis.find(n => n.id === id); if(!original) return;
        const clone = JSON.parse(JSON.stringify(original));
        clone.id = Date.now(); clone.name = clone.name + " (Copy)"; clone.uuid = null;
        if(clone.gallery) { clone.gallery.forEach(img => img.id = Date.now() + Math.random()); }
        this.data.nomis.push(clone); this.saveToDB(); this.renderGallery(); this.showToast("Nomi Duplicated!");
    }
    deleteFromContext() {
        const id = this.contextMenuTarget; const type = this.contextMenuType;
        if(type === 'nomi') {
             if(confirm("Delete this Nomi permanently?")) {
                 this.data.nomis = this.data.nomis.filter(n => n.id !== id);
                 this.saveToDB(); this.renderGallery(); this.showToast("Deleted");
             }
        } else {
             if(confirm("Delete this Group?")) {
                 this.data.groups = this.data.groups.filter(g => g.id !== id);
                 this.saveToDB(); this.renderGallery(); this.showToast("Deleted");
             }
        }
    }

    setDashboardView(mode, render = true) {
        this.dashboardView = mode; localStorage.setItem('nomi_dashboard_view', mode);
        const btnGrid = document.getElementById('btnViewGrid'); const btnList = document.getElementById('btnViewList');
        if(btnGrid && btnList) {
            if(mode === 'grid') { btnGrid.classList.add('active'); btnList.classList.remove('active'); }
            else { btnList.classList.add('active'); btnGrid.classList.remove('active'); }
        }
        if(render) this.renderGallery();
    }
    
    toggleGallerySort() {
        this.gallerySort = this.gallerySort === 'newest' ? 'oldest' : 'newest';
        this.showToast(`Sorting: ${this.gallerySort === 'newest' ? 'Newest First' : 'Oldest First'}`);
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        const searchInputId = isGroup ? 'groupGallerySearch' : 'nomiGallerySearch';
        this.filterGallery(document.getElementById(searchInputId).value);
    }
    toggleGridMenu(btn) {
        document.querySelectorAll('.grid-menu').forEach(el => { if (el !== btn.nextElementSibling) el.classList.remove('active'); });
        const menu = btn.nextElementSibling; menu.classList.toggle('active');
        const val = ['small', 'medium', 'large', 'xlarge'].indexOf(this.gallerySize);
        const currentVal = val === -1 ? 1 : val; 
        const slider = menu.querySelector('input'); if(slider) slider.value = currentVal;
        this.updateGridIcons(menu, currentVal);
        if(menu.classList.contains('active')) {
            const closeFn = (e) => { if(!menu.contains(e.target) && e.target !== btn && !btn.contains(e.target)) { menu.classList.remove('active'); document.removeEventListener('click', closeFn); } };
            setTimeout(() => document.addEventListener('click', closeFn), 0);
        }
    }
    setGallerySize(val) {
        const sizes = ['small', 'medium', 'large', 'xlarge'];
        this.gallerySize = sizes[val]; localStorage.setItem('nomi_gallery_size', this.gallerySize);
        const sizeMap = { small: '100px', medium: '160px', large: '260px', xlarge: '360px' };
        ['promptGalleryGrid', 'groupPromptGalleryGrid'].forEach(id => {
            const el = document.getElementById(id); if(el) el.style.setProperty('--grid-min', sizeMap[this.gallerySize]);
        });
        document.querySelectorAll('.custom-slider').forEach(el => el.value = val);
        document.querySelectorAll('.grid-menu').forEach(menu => this.updateGridIcons(menu, val));
    }
    updateGridIcons(menu, val) {
        menu.querySelectorAll('.grid-slider-row svg').forEach((svg, i) => { if(i == val) svg.classList.add('selected'); else svg.classList.remove('selected'); });
    }
    toggleShowPrompts() {
        this.galleryShowPrompts = !this.galleryShowPrompts;
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        const searchInputId = isGroup ? 'groupGallerySearch' : 'nomiGallerySearch';
        this.filterGallery(document.getElementById(searchInputId).value);
    }
    handleGlobalPaste(e) {
        const isNomiGallery = document.getElementById('viewNomi').style.display === 'block' && document.getElementById('tabGallery').classList.contains('active');
        const isGroupGallery = document.getElementById('viewGroup').style.display === 'block' && document.getElementById('tabGroupGallery').classList.contains('active');
        if(isNomiGallery || isGroupGallery) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let found = false;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const blob = items[i].getAsFile(); this.addBlobToGallery(blob); found = true;
                }
            }
            if(found) { e.preventDefault(); this.showToast("Pasted from clipboard!"); }
        }
    }
    async pasteGalleryImage() {
        try {
            const items = await navigator.clipboard.read();
            let found = false;
            for (const item of items) {
                const type = item.types.find(t => t.startsWith('image/'));
                if (type) {
                    const blob = await item.getType(type); this.addBlobToGallery(blob); found = true;
                }
            }
            if(found) this.showToast("Pasted from clipboard!"); else this.showToast("No image found on clipboard");
        } catch (err) { console.error(err); alert("Clipboard access blocked. Please use Ctrl+V (Cmd+V) to paste directly."); }
    }
    async pasteText(id) {
        try {
            const text = await navigator.clipboard.readText();
            const el = document.getElementById(id);
            if(el) {
                if (typeof el.selectionStart === "number" && typeof el.selectionEnd === "number") {
                    const start = el.selectionStart; const end = el.selectionEnd; const val = el.value;
                    el.value = val.substring(0, start) + text + val.substring(end); el.selectionStart = el.selectionEnd = start + text.length;
                } else { el.value += text; }
                el.dispatchEvent(new Event('input', { bubbles: true })); this.showToast("Pasted!");
            }
        } catch (err) { console.error(err); alert("Clipboard permission denied. Please paste manually."); }
    }
    addBlobToGallery(blob) {
        this.processImage(blob, 1024, (b64) => {
            const isGroup = document.getElementById('viewGroup').style.display === 'block';
            let target;
            if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
            else target = this.data.nomis.find(x => x.id === this.currentNomiId);
            if (!target.gallery) target.gallery = [];
            target.gallery.push({ id: Date.now() + Math.random(), img: b64, prompt: "" });
            this.saveToDB().then(() => this.renderPromptGallery());
        });
    }
    migrateData() {
        this.data.nomis.forEach(n => {
            if(n.isFavorite === undefined) n.isFavorite = false;
            if(!n.custom_sections) n.custom_sections = [];
            if(!n.sectionOrder) { n.sectionOrder = DEFAULT_SECTIONS.map(s => s.id); n.custom_sections.forEach(cs => n.sectionOrder.push(cs.id)); }
            if(!n.banner) n.banner = null;
        });
        this.data.groups.forEach(g => {
            if(!g.sectionOrder && g.custom_sections) { g.sectionOrder = ['backstory']; g.custom_sections.forEach(cs => g.sectionOrder.push(cs.id)); }
            if(!g.banner) g.banner = null;
            if(!g.gallery) g.gallery = []; 
            // MIGRATE MEMBERS TO OBJECTS
            if(g.members && g.members.length > 0 && typeof g.members[0] !== 'object') {
                g.members = g.members.map(id => ({ id: id, role: "" }));
            }
        });
    }
    openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' }); };
            request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            request.onerror = (e) => reject(e);
        });
    }
    saveToDB(skipAutoUpload = false) {
        return new Promise((resolve, reject) => {
            const t = this.db.transaction(['data'], 'readwrite');
            t.objectStore('data').put({ id: 'root', nomis: this.data.nomis, groups: this.data.groups, settings: this.data.settings });
            t.oncomplete = () => { if (this.data.settings.autoUpload && !skipAutoUpload) { this.triggerAutoUpload(); } resolve(); };
            t.onerror = reject;
        });
    }
    loadData() {
        return new Promise((resolve, reject) => {
            const t = this.db.transaction(['data'], 'readonly');
            t.objectStore('data').get('root').onsuccess = (e) => {
                if (e.target.result) {
                    this.data = e.target.result;
                }
                
                // SELF-HEALING: Always ensure these exist
                if (!this.data.nomis) this.data.nomis = [];
                if (!this.data.groups) this.data.groups = [];
                if (!this.data.settings) this.data.settings = {};
                
                // Ensure critical settings defaults
                if (!this.data.settings.theme) this.data.settings.theme = 'midnight';
                if (!this.data.settings.syncCache) this.data.settings.syncCache = {};
                
                resolve();
            };
        });
    }
    toggleCloudSync(checked) { this.data.settings.autoUpload = checked; this.data.settings.autoDownload = checked; this.saveToDB(); }
    triggerAutoUpload() { if (this.uploadTimer) clearTimeout(this.uploadTimer); this.cloudUpload(true); }
    toggleSettings() {
        const m = document.getElementById('settingsModal'); m.classList.toggle('active');
        if(m.classList.contains('active')) { 
            document.getElementById('themeSelect').value = this.data.settings.theme || 'midnight';
            document.getElementById('startUpSelect').value = this.data.settings.startView || 'home'; 
            document.getElementById('apiKeyInput').value = this.data.settings.apiKey || ''; 
            document.getElementById('ghTokenInput').value = localStorage.getItem('nomi_gh_token') || '';
            document.getElementById('gistIdInput').value = localStorage.getItem('nomi_gist_id') || '';
            ['apiKeyInput', 'ghTokenInput', 'gistIdInput'].forEach(id => {
                document.getElementById(id).readOnly = true;
                const btn = document.getElementById(id).nextElementSibling;
                if(btn) btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>';
                if(btn) btn.classList.remove('active');
            });
            document.getElementById('cloudSyncCheck').checked = this.data.settings.autoUpload || false;
            
            // NEW: Render the Storage Dashboard
            this.renderStorageDashboard();
        }
    }
    
    // NEW FUNCTION: STORAGE CALCULATOR & DASHBOARD
    async renderStorageDashboard() {
        // 1. Calculate Sizes
        const getSize = (obj) => new Blob([JSON.stringify(obj)]).size;
        
        let nomiTotal = 0;
        let groupTotal = 0;
        let totalImgCount = 0;
        let allItems = [];

        this.data.nomis.forEach(n => {
            const size = getSize(n);
            nomiTotal += size;
            const imgCount = (n.gallery ? n.gallery.length : 0) + (n.photo ? 1 : 0);
            totalImgCount += imgCount;
            allItems.push({ name: n.name, size: size, type: 'nomi' });
        });

        this.data.groups.forEach(g => {
            const size = getSize(g);
            groupTotal += size;
            const imgCount = (g.gallery ? g.gallery.length : 0) + (g.photo ? 1 : 0);
            totalImgCount += imgCount;
            allItems.push({ name: g.name, size: size, type: 'group' });
        });

        const totalUsed = nomiTotal + groupTotal;

        // 2. Update Bar Widths
        const pNomis = totalUsed > 0 ? (nomiTotal / totalUsed) * 100 : 0;
        const pGroups = totalUsed > 0 ? (groupTotal / totalUsed) * 100 : 0;
        
        document.getElementById('barNomis').style.width = pNomis + '%';
        document.getElementById('barGroups').style.width = pGroups + '%';

        // 3. Update Grid Stats
        document.getElementById('statTotalImages').innerText = totalImgCount;
        document.getElementById('statTotalNomis').innerText = this.data.nomis.length;

        // Storage Used
        const mbUsed = (totalUsed / 1024 / 1024).toFixed(2);
        const elUsed = document.getElementById('statStorageUsed');
        if(elUsed) elUsed.innerText = `${mbUsed} MB`;

        // 4. Update Top List
        allItems.sort((a, b) => b.size - a.size);
        const top3 = allItems.slice(0, 3);
        const listEl = document.getElementById('storageTopList');
        listEl.innerHTML = '';
        
        if(top3.length === 0) {
            listEl.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-muted); font-size:0.8rem;">No Data</div>';
        } else {
            top3.forEach(item => {
                const mb = (item.size / 1024 / 1024).toFixed(2);
                const dotClass = item.type === 'nomi' ? 'nomi' : 'group';
                listEl.innerHTML += `
                    <div class="storage-list-item">
                        <div class="list-name"><div class="legend-dot ${dotClass}"></div>${item.name}</div>
                        <div class="list-size">${mb} MB</div>
                    </div>`;
            });
        }
    }

    toggleEdit(inputId, btn, type) {
        const input = document.getElementById(inputId); const isLocked = input.readOnly;
        if (isLocked) { input.readOnly = false; input.focus(); btn.classList.add('active'); btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'; } else { input.readOnly = true; btn.classList.remove('active'); btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>'; const val = input.value; if (type === 'apiKey') this.saveSetting('apiKey', val); else if (type === 'ghToken') localStorage.setItem('nomi_gh_token', val); else if (type === 'gistId') localStorage.setItem('nomi_gist_id', val); this.showToast("Saved!"); }
    }
    
    setTheme(name) { this.data.settings.theme = name; localStorage.setItem('nomi_theme', name); this.applyTheme(name); this.saveToDB(true); }
    applyTheme(name) { const t = THEMES[name] || THEMES['midnight']; for (const [key, value] of Object.entries(t)) { document.documentElement.style.setProperty(key, value); } const hex = t['--accent']; if(hex && hex.startsWith('#')) { const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); document.documentElement.style.setProperty('--accent-dim', `rgba(${r}, ${g}, ${b}, 0.1)`); } const gallery = document.getElementById('nomiGallery'); if(gallery && gallery.innerHTML !== "") this.renderGallery(); }  
    saveSetting(k, v) { this.data.settings[k] = v; const isLocal = (k === 'theme' || k === 'startView' || k === 'apiKey'); this.saveToDB(isLocal); }
    saveState(viewType, id = null) { this.data.settings.lastState = { view: viewType, id: id }; this.saveToDB(true); }
    flashSyncSuccess() { const pill = document.getElementById('syncBtn'); pill.classList.add('success'); setTimeout(() => { pill.classList.remove('success'); }, 1500); }
    
    // --- UPDATED SPLIT SYNC LOGIC ---

    async uploadFileBatch(filesObj, token, gistId) {
        return fetch(`https://api.github.com/gists/${gistId}`, { 
            method: 'PATCH', 
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ files: filesObj }) 
        });
    }

    // --- SMART SYNC HELPER ---
    simpleHash(str) {
        let hash = 0;
        if (str.length === 0) return hash;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash;
    }

    // --- UPDATED SMART SYNC ---
    async cloudUpload(silent = false) {
        const token = localStorage.getItem('nomi_gh_token'); 
        const gistId = localStorage.getItem('nomi_gist_id');
        if (!token || !gistId) { if(!silent) alert("Please enter both a GitHub Token and Gist ID."); return; }
        
        if(!silent && !confirm("Overwrite Cloud Save with current data?")) return;

        const pill = document.getElementById('syncBtn'); 
        const icon = document.getElementById('syncIcon'); 
        const text = document.getElementById('syncText');
        
        if (silent) { pill.classList.add('expanded'); icon.classList.add('spin'); text.innerText = "Checking..."; } 
        else { this.showToast("Analyzing changes..."); }

        try {
            // 1. Get current Gist status
            const currentGistRes = await fetch(`https://api.github.com/gists/${gistId}`, { 
                method: 'GET', headers: { 'Authorization': `token ${token}` } 
            });
            
            if(!currentGistRes.ok) throw new Error("Could not access Gist.");
            const currentGist = await currentGistRes.json();
            const currentFiles = currentGist.files || {};
            
            // Load local sync cache (maps filename -> hash)
            let syncCache = this.data.settings.syncCache || {};
            let filesToUpload = {};
            let uploadCount = 0;

            // 2. DETECT DELETIONS
            // If a file exists in Cloud but not locally, delete it from Cloud
            const localNomiIds = new Set(this.data.nomis.map(n => `n_${n.id}.json`));
            const localGroupIds = new Set(this.data.groups.map(g => `g_${g.id}.json`));

            Object.keys(currentFiles).forEach(filename => {
                // Delete legacy monolith if exists
                if(filename === "nomi-data.json") { filesToUpload[filename] = { content: null }; uploadCount++; }

                // Check for deleted Nomis
                if(filename.startsWith('n_') && filename.endsWith('.json')) {
                    if(!localNomiIds.has(filename)) { 
                        filesToUpload[filename] = { content: null }; 
                        delete syncCache[filename]; // Remove from cache
                        uploadCount++;
                    }
                }
                // Check for deleted Groups
                if(filename.startsWith('g_') && filename.endsWith('.json')) {
                    if(!localGroupIds.has(filename)) { 
                        filesToUpload[filename] = { content: null }; 
                        delete syncCache[filename]; 
                        uploadCount++;
                    }
                }
            });

            // 3. DETECT CHANGES (SMART HASHING)
            
            // Helper to check and queue
            const checkAndQueue = (filename, dataObj) => {
                const content = JSON.stringify(dataObj);
                const hash = this.simpleHash(content);
                
                // If hash changed OR file doesn't exist in cloud yet -> Upload
                if (syncCache[filename] !== hash || !currentFiles[filename]) {
                    filesToUpload[filename] = { content: content };
                    syncCache[filename] = hash; // Update local cache
                    uploadCount++;
                    return true;
                }
                return false;
            };

            // Check Nomis
            for (const n of this.data.nomis) {
                checkAndQueue(`n_${n.id}.json`, n);
            }

            // Check Groups
            for (const g of this.data.groups) {
                checkAndQueue(`g_${g.id}.json`, g);
            }

            // Check Meta Files (Always check these)
            const metaSettings = { ...this.data.settings };
            delete metaSettings.theme; delete metaSettings.startView; delete metaSettings.syncCache; // Don't sync the cache itself to keep it clean
            checkAndQueue("settings.json", metaSettings);
            
            checkAndQueue("index.json", {
                nomis: this.data.nomis.map(n => ({ id: n.id, name: n.name })),
                groups: this.data.groups.map(g => ({ id: g.id, name: g.name }))
            });

            // 4. EXECUTE UPLOAD
            if(uploadCount === 0) {
                 if(silent) { 
                    text.innerText = "Up to Date"; 
                    setTimeout(() => { pill.classList.remove('expanded'); icon.classList.remove('spin'); }, 2000); 
                } else { 
                    this.showToast("Already up to date!"); 
                }
                // Save the cache anyway just in case
                this.data.settings.syncCache = syncCache;
                this.saveToDB(true);
                return;
            }

            if(silent) text.innerText = `Syncing ${uploadCount} files...`;
            else this.showToast(`Uploading ${uploadCount} changes...`);

            // Send to GitHub (Gist API accepts multiple files in one PATCH request)
            await fetch(`https://api.github.com/gists/${gistId}`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ files: filesToUpload }) 
            });

            // Save the new cache locally
            this.data.settings.syncCache = syncCache;
            await this.saveToDB(true); // Save local DB with new cache

            // Success UI
            if(silent) { 
                text.innerText = "Synced"; this.flashSyncSuccess(); 
                setTimeout(() => { pill.classList.remove('expanded'); icon.classList.remove('spin'); }, 2000); 
            } else { 
                this.showToast("Cloud Upload Complete!"); this.flashSyncSuccess(); 
            }

        } catch (e) {
            console.error(e);
            alert("SYNC FAILED: " + e.message);
            if(silent) { pill.classList.remove('expanded'); icon.classList.remove('spin'); }
        }
    }

    async cloudDownload(silent = false) {
        const token = localStorage.getItem('nomi_gh_token'); 
        const gistId = localStorage.getItem('nomi_gist_id');
        if (!token || !gistId) { if(!silent) alert("Please enter keys."); return; }
        
        if(!silent && !confirm("Overwrite LOCAL data with Cloud Save?")) return;

        const pill = document.getElementById('syncBtn'); 
        const icon = document.getElementById('syncIcon'); 
        const text = document.getElementById('syncText');
        
        if(silent) { pill.classList.add('expanded'); icon.classList.add('spin'); text.innerText = "Downloading..."; } 
        else { this.showToast("Connecting to Cloud..."); }

        try {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, { method: 'GET', headers: { 'Authorization': `token ${token}` } });
            if (!res.ok) throw new Error("Failed to connect");
            const gist = await res.json();
            const files = gist.files || {};

            // CHECK FOR LEGACY MONOLITH
            if(files["nomi-data.json"]) {
                if(!silent) alert("Old backup format detected. Migrating...");
                
                // 1. Download the old data
                const rawUrl = files["nomi-data.json"].raw_url;
                const rawRes = await fetch(rawUrl);
                const oldData = await rawRes.json();
                
                // 2. Load it into the app
                this.data = oldData;
                await this.saveToDB(true);
                
                // 3. Delete the old file from cloud & create new split files
                console.log("Migrating legacy file...");
                await this.cloudUpload(true); 

                // 4. Update the screen WITHOUT reloading (Breaks the loop)
                if(!silent) alert("Migration complete!");
                this.applyTheme(this.data.settings.theme || 'midnight');
                this.renderGallery();
                
                // 5. Update Storage Dashboard if open
                if(document.getElementById('settingsModal').classList.contains('active')) {
                    this.renderStorageDashboard();
                }
                
                return;
            }

            if(!files["settings.json"]) throw new Error("No Nomi data found.");

            // Parallel Download Logic
            const downloadPromises = [];
            
            // 1. Download Settings
            downloadPromises.push(fetch(files["settings.json"].raw_url).then(r => r.json()).then(d => ({ type: 'settings', data: d })));

            // 2. Identify all data files
            Object.keys(files).forEach(filename => {
                if(filename.startsWith('n_') && filename.endsWith('.json')) {
                    downloadPromises.push(fetch(files[filename].raw_url).then(r => r.json()).then(d => ({ type: 'nomi', data: d })));
                }
                else if(filename.startsWith('g_') && filename.endsWith('.json')) {
                    downloadPromises.push(fetch(files[filename].raw_url).then(r => r.json()).then(d => ({ type: 'group', data: d })));
                }
            });

            if(!silent) this.showToast(`Downloading ${downloadPromises.length} files...`);

            // Execute Downloads
            const results = await Promise.all(downloadPromises);

            // Reassemble Data
            const newData = { nomis: [], groups: [], settings: {} };
            
            results.forEach(res => {
                if(res.type === 'settings') newData.settings = res.data;
                else if(res.type === 'nomi') newData.nomis.push(res.data);
                else if(res.type === 'group') newData.groups.push(res.data);
            });

            // Restore Local-only settings
            const currentTheme = this.data.settings.theme;
            const currentStartView = this.data.settings.startView;
            
            this.data = newData;
            if(!this.data.settings) this.data.settings = {};
            if(currentTheme) this.data.settings.theme = currentTheme;
            if(currentStartView) this.data.settings.startView = currentStartView;

            this.applyTheme(this.data.settings.theme || 'cyber');
            await this.saveToDB(true);

            if(silent) { 
                text.innerText = "Synced"; this.flashSyncSuccess(); this.renderGallery();
                setTimeout(() => { pill.classList.remove('expanded'); icon.classList.remove('spin'); }, 2000); 
            } else { 
                alert("âœ… Download Complete. Reloading..."); location.reload(); 
            }

        } catch (e) {
            console.error(e);
            if(!silent) alert("Download Error: " + e.message);
            if(silent) { pill.classList.remove('expanded'); icon.classList.remove('spin'); }
        }
    }
    
    toggleCloudHelp() { document.getElementById('cloudHelpModal').classList.toggle('active'); }
    exportCloudCreds() { const token = localStorage.getItem('nomi_gh_token'); const gistId = localStorage.getItem('nomi_gist_id'); if(!token || !gistId) return alert("No Cloud Keys found to export."); const keys = { token: token, gistId: gistId }; const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(keys)); const a = document.createElement('a'); a.href = s; a.download = "nomi_cloud_keys.json"; document.body.appendChild(a); a.click(); a.remove(); }
    importCloudCreds(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const j = JSON.parse(e.target.result); if(j.token && j.gistId) { localStorage.setItem('nomi_gh_token', j.token); localStorage.setItem('nomi_gist_id', j.gistId); document.getElementById('ghTokenInput').value = j.token; document.getElementById('gistIdInput').value = j.gistId; alert("âœ… Keys Imported Successfully!"); } else { alert("Invalid Key File."); } } catch (err) { alert("Error reading file."); } input.value = ''; }; r.readAsText(f); }
    async syncFromApi() {
        if(this.isSyncing) return; const key = this.data.settings.apiKey; if (!key) { alert("Please go to Settings and enter your Nomi.ai API Key first."); this.toggleSettings(); return; } this.isSyncing = true; const pill = document.getElementById('syncBtn'); const icon = document.getElementById('syncIcon'); const text = document.getElementById('syncText'); pill.classList.add('expanded'); icon.classList.add('spin'); text.innerText = "Importing..."; try { const listRes = await fetch("https://corsproxy.io/?https://api.nomi.ai/v1/nomis", { headers: { "Authorization": key } }); if (!listRes.ok) throw new Error("Check API Key."); const listData = await listRes.json(); let added=0, updated=0; for (const r of listData.nomis) { let l = this.data.nomis.find(n => n.uuid === r.uuid || n.name === r.name); if (!l) { l = { id: Date.now() + Math.random(), uuid: r.uuid, name: r.name, photo: null, banner: null, data: { key_traits: [] }, gallery: [], custom_sections: [], sectionOrder: DEFAULT_SECTIONS.map(s=>s.id), isFavorite: false }; this.data.nomis.push(l); added++; } else { if(!l.uuid) l.uuid = r.uuid; updated++; } if (!l.photo) { try { const avRes = await fetch(`https://corsproxy.io/?https://api.nomi.ai/v1/nomis/${r.uuid}/avatar`, { headers: { "Authorization": key } }); if (avRes.ok) { const b = await avRes.blob(); l.photo = await new Promise(r=>{const fr=new FileReader();fr.onloadend=()=>r(fr.result);fr.readAsDataURL(b);}); if(l.gallery === undefined) l.gallery = []; l.gallery.unshift({ id: Date.now() + Math.random(), img: l.photo, prompt: "Imported from Nomi.ai" }); } } catch (e) {} } } await this.saveToDB(); this.renderGallery(false); pill.classList.remove('expanded'); icon.classList.remove('spin'); this.flashSyncSuccess(); alert(`Import Complete:\nâ€¢ ${added} New Nomis\nâ€¢ ${updated} Updated`); } catch (e) { pill.classList.remove('expanded'); icon.classList.remove('spin'); alert("Error: " + e.message); } finally { this.isSyncing = false; }
    }
    initStartView() { if(this.data.settings.startView === 'last' && this.data.settings.lastState) { const state = this.data.settings.lastState; if(state.view === 'nomi' && state.id) { const exists = this.data.nomis.find(n => n.id === state.id); if(exists) return this.editNomi(state.id); } else if(state.view === 'group' && state.id) { const exists = this.data.groups.find(g => g.id === state.id); if(exists) return this.editGroup(state.id); } } this.goHome(); }
    goHome(pushHistory = true) { this.isReordering = false; this.isBatchMode = false; this.selectedImages.clear(); document.getElementById('viewHome').style.display = 'block'; document.getElementById('viewNomi').style.display = 'none'; document.getElementById('viewGroup').style.display = 'none'; document.getElementById('heroBackground').style.backgroundImage = 'none'; this.currentNomiId = null; this.currentGroupId = null; this.renderGallery(false); this.saveState('home'); if(pushHistory) history.pushState({view: 'home'}, '', '#home'); }
    switchTab(t) {
        if(this.currentNomiId) history.replaceState({view: 'nomi', id: this.currentNomiId, tab: t}, '', '#nomi/'+this.currentNomiId);
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById('tab' + (t.charAt(0).toUpperCase() + t.slice(1))).classList.add('active');
        this.isReordering = false;
        const btnNomi = document.getElementById('btnSortNomi'); if(btnNomi) btnNomi.classList.remove('active'); const rstNomi = document.getElementById('btnResetNomi'); if(rstNomi) rstNomi.style.visibility = 'hidden';
        if (t === 'profile') { document.getElementById('contentProfile').style.display = 'block'; document.getElementById('contentGallery').style.display = 'none'; this.renderFormGrid(); } else { document.getElementById('contentProfile').style.display = 'none'; document.getElementById('contentGallery').style.display = 'block'; this.renderPromptGallery(); }
    }
    switchGroupTab(t) {
        if(this.currentGroupId) history.replaceState({view: 'group', id: this.currentGroupId, tab: t}, '', '#group/'+this.currentGroupId);
        document.querySelectorAll('#viewGroup .tab-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById('tabGroup' + (t.charAt(0).toUpperCase() + t.slice(1))).classList.add('active');
        this.isReordering = false;
        const btnGroup = document.getElementById('btnSortGroup'); if(btnGroup) btnGroup.classList.remove('active'); const rstGroup = document.getElementById('btnResetGroup'); if(rstGroup) rstGroup.style.visibility = 'hidden';
        
        document.getElementById('contentGroupProfile').style.display = 'none';
        document.getElementById('contentGroupGallery').style.display = 'none';
        document.getElementById('contentGroupMembers').style.display = 'none';
        
        if(t === 'profile') { 
            document.getElementById('contentGroupProfile').style.display = 'block'; 
            this.renderGroupSections(); 
        } else if (t === 'gallery') { 
            document.getElementById('contentGroupGallery').style.display = 'block'; 
            this.renderPromptGallery(); 
        } else if (t === 'members') {
            document.getElementById('contentGroupMembers').style.display = 'block';
            this.renderGroupMembers();
        }
    }
    createNomi() { const n = { id: Date.now(), name: "New Nomi", photo: null, banner: null, data: {}, gallery: [], custom_sections: [], sectionOrder: DEFAULT_SECTIONS.map(s=>s.id), isFavorite: false }; this.data.nomis.push(n); this.saveToDB().then(() => this.editNomi(n.id)); }
    
    editNomi(id, pushHistory = true, initialTab = 'profile') { 
        this.currentNomiId = id; 
        this.saveState('nomi', id);
        this.isReordering = false;
        
        const btnNomi = document.getElementById('btnSortNomi');
        if(btnNomi) btnNomi.classList.remove('active');
        const rstNomi = document.getElementById('btnResetNomi');
        if(rstNomi) rstNomi.style.visibility = 'hidden';
        this.isBatchMode = false;
        this.selectedImages.clear();

        if(pushHistory) history.pushState({view: 'nomi', id: id, tab: initialTab}, '', '#nomi/'+id);
        
        const n = this.data.nomis.find(x => x.id === id); 
        if(!n.sectionOrder) { n.sectionOrder = DEFAULT_SECTIONS.map(s=>s.id); (n.custom_sections||[]).forEach(c=>n.sectionOrder.push(c.id)); } 
        
        document.getElementById('viewHome').style.display = 'none'; 
        document.getElementById('viewNomi').style.display = 'block'; 
        document.getElementById('viewGroup').style.display = 'none'; 
        
        window.scrollTo(0, 0);
        this.switchTab(initialTab); 
        
        this.toggleNameEdit('nomi', false); 
        document.getElementById('nomiNameDisplay').innerText = n.name; 
        document.getElementById('nomiName').value = n.name; 
        
        const disp = document.getElementById('nomiImageDisplay'); 
        const plac = document.getElementById('nomiImagePlaceholder'); 
        
        if(n.photo) { 
            disp.src = n.photo; disp.style.display='block'; plac.style.display='none'; 
        } else { 
            disp.style.display='none'; plac.style.display='flex'; 
            plac.innerText = n.name ? n.name.charAt(0) : '?';
        }

        this.renderTraits(); 
        this.renderFormGrid(); 
    }

    selectGalleryImageOptions(imgUrl, imgId) {
        cropper.initFromUrl(imgUrl, this.currentNomiId ? 'nomi' : 'group');
    }
    
    toggleFavorite(e, id) { e.stopPropagation(); const n = this.data.nomis.find(x => x.id === id); n.isFavorite = !n.isFavorite; this.saveToDB(); this.renderGallery(false); }
    
    renderGallery(animate = false) { 
        const isList = this.dashboardView === 'list';
        const g = document.getElementById('nomiGallery'); 
        const gg = document.getElementById('groupGallery'); 
        if(g) { g.innerHTML = ''; if(isList) g.classList.add('list-mode'); else g.classList.remove('list-mode'); }
        if(gg) { gg.innerHTML = ''; if(isList) gg.classList.add('list-mode'); else gg.classList.remove('list-mode'); }

        const term = document.getElementById('searchInput').value.toLowerCase(); 
        
        let sorted = this.data.nomis.filter(n => n.name.toLowerCase().includes(term)).sort((a,b) => (b.isFavorite === a.isFavorite) ? 0 : b.isFavorite ? 1 : -1); 
        
        sorted.forEach(n => { 
            const favClass = n.isFavorite ? 'active' : ''; 
            const animClass = animate ? 'pop-in' : ''; 
            const letter = n.name ? n.name.charAt(0) : '?';
            const imgHtml = n.photo 
                ? `<img src="${n.photo}" loading="lazy">` 
                : `<div class="card-placeholder">${letter}</div>`;
            const html = `
                <div class="nomi-card ${animClass}" onclick="app.editNomi(${n.id})" oncontextmenu="app.showContextMenu(event, ${n.id}, 'nomi')">
                    ${imgHtml}
                    <button class="fav-btn ${favClass}" onclick="app.toggleFavorite(event, ${n.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </button>
                    <div class="nomi-card-info">${n.name}</div>
                </div>`; 
            g.insertAdjacentHTML('beforeend', html); 
        }); 
        
        this.data.groups.filter(gr => gr.name.toLowerCase().includes(term)).forEach(gr => { 
            const animClass = animate ? 'pop-in' : '';
            const letter = gr.name ? gr.name.charAt(0) : '?';
            const imgHtml = gr.photo 
                ? `<img src="${gr.photo}" loading="lazy">` 
                : `<div class="card-placeholder">${letter}</div>`;
            const html = `
                <div class="nomi-card ${animClass}" onclick="app.editGroup(${gr.id})" oncontextmenu="app.showContextMenu(event, ${gr.id}, 'group')">
                    ${imgHtml}
                    <div class="nomi-card-info">${gr.name}</div>
                </div>`; 
            gg.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    
    toggleNameEdit(type, isEditing) {
        const display = document.getElementById(type + 'NameDisplay');
        const btn = document.getElementById(type + 'EditBtn'); 
        const editor = document.getElementById(type + 'NameEdit');
        
        if(isEditing) {
            if(type === 'nomi') document.getElementById('nomiName').value = this.data.nomis.find(n=>n.id===this.currentNomiId).name;
            else document.getElementById('groupName').value = this.data.groups.find(g=>g.id===this.currentGroupId).name;

            display.style.display = 'none';
            btn.style.display = 'none';
            editor.classList.add('active');
            document.getElementById(type + 'Name').focus();
        } else {
            display.style.display = 'block';
            btn.style.display = 'flex'; 
            editor.classList.remove('active');
        }
    }

    cancelNameEdit(type) {
        let currentName = "";
        if (type === 'nomi') {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            currentName = n.name;
        } else {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            currentName = g.name;
        }
        document.getElementById(type + 'Name').value = currentName;
        this.toggleNameEdit(type, false);
    }

    cancelSection(id, isGroup) {
        if (isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            let val = "";
            if (id === 'backstory') val = g.backstory || "";
            else {
                const s = g.custom_sections.find(cs => cs.id === id);
                val = s ? s.content : "";
            }
            document.getElementById(`group_sec_${id}`).value = val;
            this.updateGroupSectionContent(id, val);
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            let val = "";
            const def = DEFAULT_SECTIONS.find(d => d.id === id);
            if (def) val = n.data[id] || "";
            else {
                const s = n.custom_sections.find(cs => cs.id === id);
                val = s ? s.content : "";
            }
            document.getElementById(`field_${id}`).value = val;
            this.handleInput(id, 5000, !def);
        }
        this.showToast("Changes Reverted");
    }
    
    saveName(type) { 
        const val = document.getElementById(type + 'Name').value; 
        if(type === 'nomi') { 
            const n = this.data.nomis.find(x => x.id === this.currentNomiId); 
            n.name = val; 
            document.getElementById('nomiNameDisplay').innerText = val; 
            this.autoSaveNomi(); 
        } else { 
            const g = this.data.groups.find(x => x.id === this.currentGroupId); 
            g.name = val; 
            document.getElementById('groupNameDisplay').innerText = val; 
            this.autoSaveGroup(); 
        } 
        this.toggleNameEdit(type, false); 
    }
    
    setAllSections(collapsed) {
        document.querySelectorAll('.glass-card').forEach(card => {
            if(collapsed) {
                card.classList.add('collapsed');
            } else {
                card.classList.remove('collapsed');
                const ta = card.querySelector('textarea');
                this.autoResize(ta);
            }
        });
    }

    copyAllSections(isGroup) {
        let text = "";
        let count = 0;
        
        if(isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            g.sectionOrder.forEach(sid => {
                const isBackstory = sid === 'backstory';
                const cust = g.custom_sections ? g.custom_sections.find(cs => cs.id === sid) : null;
                if(!isBackstory && !cust) return;
                const title = isBackstory ? "Group Backstory" : cust.title;
                const content = isBackstory ? (g.backstory || '') : cust.content;
                if(content.trim()) { text += `## ${title}\n${content}\n\n`; count++; }
            });
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            n.sectionOrder.forEach(sid => {
                const def = DEFAULT_SECTIONS.find(d => d.id === sid);
                const cust = n.custom_sections ? n.custom_sections.find(cs => cs.id === sid) : null;
                if (!def && !cust) return;
                const title = def ? def.label : cust.title;
                const val = def ? (n.data[sid] || '') : cust.content;
                if(val && val.trim()) { text += `## ${title}\n${val}\n\n`; count++; }
            });
        }
        if(count > 0) { navigator.clipboard.writeText(text).then(() => this.showToast(`Copied ${count} sections!`)); } else { this.showToast("Nothing to copy!"); }
    }
    
    toggleReorderMode() {
        this.isReordering = !this.isReordering;
        const btnNomi = document.getElementById('btnSortNomi');
        const btnGroup = document.getElementById('btnSortGroup');
        const rstNomi = document.getElementById('btnResetNomi');
        const rstGroup = document.getElementById('btnResetGroup');
        
        if(this.isReordering) {
            if(btnNomi) btnNomi.classList.add('active');
            if(btnGroup) btnGroup.classList.add('active');
            if(rstNomi) rstNomi.style.visibility = 'visible';
            if(rstGroup) rstGroup.style.visibility = 'visible';
        } else {
            if(btnNomi) btnNomi.classList.remove('active');
            if(btnGroup) btnGroup.classList.remove('active');
            if(rstNomi) rstNomi.style.visibility = 'hidden';
            if(rstGroup) rstGroup.style.visibility = 'hidden';
        }
        if(document.getElementById('viewGroup').style.display === 'block') { this.renderGroupSections(); } else { this.renderFormGrid(); }
    }
    
    resetSort() {
        if(!confirm("Reset sections to default order?")) return;
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        if (isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            let newOrder = ['backstory'];
            if(g.custom_sections) { g.custom_sections.forEach(cs => { if(!newOrder.includes(cs.id)) newOrder.push(cs.id); }); }
            g.sectionOrder = newOrder;
            this.saveToDB();
            this.renderGroupSections();
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            let newOrder = DEFAULT_SECTIONS.map(s => s.id);
            if(n.custom_sections) { n.custom_sections.forEach(cs => { if(!newOrder.includes(cs.id)) newOrder.push(cs.id); }); }
            n.sectionOrder = newOrder;
            this.saveToDB();
            this.renderFormGrid();
        }
    }

    toggleBatchMode() {
        this.isBatchMode = !this.isBatchMode;
        this.selectedImages.clear();
        
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let btn, delBtn;
        
        if (isGroup) {
            btn = document.getElementById('btnGroupBatchMode');
            delBtn = document.getElementById('btnGroupBatchDelete');
        } else {
            btn = document.getElementById('btnBatchMode');
            delBtn = document.getElementById('btnBatchDelete');
        }

        if(this.isBatchMode) { btn.classList.add('active'); delBtn.style.display = 'flex'; } 
        else { btn.classList.remove('active'); delBtn.style.display = 'none'; }
        
        const searchInputId = isGroup ? 'groupGallerySearch' : 'nomiGallerySearch';
        const term = document.getElementById(searchInputId).value;
        this.filterGallery(term);
    }

    toggleGallerySelection(id) {
        if(this.selectedImages.has(id)) { this.selectedImages.delete(id); } else { this.selectedImages.add(id); }
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        const searchInputId = isGroup ? 'groupGallerySearch' : 'nomiGallerySearch';
        this.filterGallery(document.getElementById(searchInputId).value);
    }

    deleteBatchImages() {
        if(this.selectedImages.size === 0) return this.showToast("No images selected");
        if(!confirm(`Delete ${this.selectedImages.size} selected images?`)) return;
        
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);

        target.gallery = target.gallery.filter(g => !this.selectedImages.has(g.id));
        this.saveToDB();
        this.toggleBatchMode();
        this.showToast("Images Deleted!");
    }

    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.glass-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    handleDragStart(e, id, isGroup) { 
        if(!this.isReordering) { e.preventDefault(); return; } 
        this.dragSrcEl = e.target.closest('.glass-card'); 
        this.dragSrcEl.classList.add('dragging'); 
        e.dataTransfer.effectAllowed = 'move'; 
        e.dataTransfer.setData('text/plain', id);
    }

    handleDragOver(e) {
        if(!this.isReordering) return;
        e.preventDefault();
        const container = e.target.closest('.form-column-container') || document.getElementById('groupSectionsContainer');
        if(!container) return;
        const afterElement = this.getDragAfterElement(container, e.clientY);
        const draggable = document.querySelector('.dragging');
        if(!draggable) return;
        if (afterElement == null) { container.appendChild(draggable); } else { container.insertBefore(draggable, afterElement); }
    }

    handleDragEnd(e) {
        const draggable = document.querySelector('.dragging');
        if(draggable) draggable.classList.remove('dragging');
        this.saveOrderFromDOM();
    }

    handleTouchStart(e) {
        if(!this.isReordering) return;
        if(e.cancelable) e.preventDefault();
        const handle = e.currentTarget;
        const card = handle.closest('.glass-card');
        this.touchDragItem = card;
        card.classList.add('dragging');
    }

    handleTouchMove(e) {
        if(!this.isReordering) return;
        if(e.cancelable) e.preventDefault();
        if (!this.touchDragItem) return;
        const touch = e.touches[0];
        const elementUnderFinger = document.elementFromPoint(touch.clientX, touch.clientY);
        if(!elementUnderFinger) return;
        const container = elementUnderFinger.closest('.form-column-container') || document.getElementById('groupSectionsContainer');
        if(!container) return;
        const afterElement = this.getDragAfterElement(container, touch.clientY);
        if (afterElement == null) { container.appendChild(this.touchDragItem); } else { container.insertBefore(this.touchDragItem, afterElement); }
    }

    handleTouchEnd(e) {
        if (this.touchDragItem) {
            this.touchDragItem.classList.remove('dragging');
            this.touchDragItem = null;
            this.saveOrderFromDOM();
        }
    }

    saveOrderFromDOM() {
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        if (isGroup) {
            const g = this.data.groups.find(x => x.id === this.currentGroupId);
            const container = document.getElementById('groupSectionsContainer');
            const newOrder = [];
            Array.from(container.children).forEach(child => {
                 const textArea = child.querySelector('textarea');
                 if(textArea) { const parts = textArea.id.split('group_sec_'); if(parts.length > 1) newOrder.push(parts[1]); }
            });
            if(newOrder.length > 0) { g.sectionOrder = newOrder; this.saveToDB(); }
        } else {
            const n = this.data.nomis.find(x => x.id === this.currentNomiId);
            const container = document.getElementById('profileGrid');
            const newOrder = [];
            Array.from(container.children).forEach(child => {
                const textArea = child.querySelector('textarea');
                if(textArea) { const parts = textArea.id.split('field_'); if(parts.length > 1) newOrder.push(parts[1]); }
            });
            if(newOrder.length > 0) { n.sectionOrder = newOrder; this.saveToDB(); }
        }
    }

    renderFormGrid() { 
        const c = document.getElementById('profileGrid'); c.innerHTML = ''; 
        const n = this.data.nomis.find(x => x.id === this.currentNomiId); 
        if(!n) return; 
        if(!n.sectionOrder || n.sectionOrder.length === 0) { n.sectionOrder = DEFAULT_SECTIONS.map(s=>s.id); if(n.custom_sections) n.custom_sections.forEach(cs=>n.sectionOrder.push(cs.id)); } 
        const draggableAttr = this.isReordering ? 'draggable="true"' : 'draggable="false"';
        const handleStyle = this.isReordering ? 'display:block;' : '';
        if(this.isReordering) { c.ondragover = (e) => app.handleDragOver(e); }

        n.sectionOrder.forEach((sid, idx) => { 
            const def = DEFAULT_SECTIONS.find(d => d.id === sid); 
            const cust = n.custom_sections ? n.custom_sections.find(cs => cs.id === sid) : null; 
            if (!def && !cust) return; 
            const label = def ? def.label : cust.title; 
            const val = def ? (n.data[sid] || '') : cust.content; 
            const limit = def ? def.limit : 5000; 
            const isCust = !!cust; 
            const html = ` <div class="glass-card collapsed ${def && val.length > limit ? 'over-limit' : ''}" id="card_${sid}" ${draggableAttr} ondragstart="app.handleDragStart(event, '${sid}', false)" ondragend="app.handleDragEnd(event)"> <div class="card-header" onclick="app.toggleCard(this.parentNode)"> <div class="card-header-left"> <span class="drag-handle" style="${handleStyle}" onmousedown="event.stopPropagation()" ontouchstart="app.handleTouchStart(event)" ontouchmove="app.handleTouchMove(event)" ontouchend="app.handleTouchEnd(event)"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg> </span> ${isCust ? `<input type="text" value="${label}" style="background:transparent;border:none;color:var(--accent);font-weight:700;font-size:0.85rem;width:100%;font-family:inherit;letter-spacing:1px;text-transform:uppercase;padding:0;margin:0;-webkit-user-select:text;user-select:text;" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" oninput="app.updateNomiSectionTitle('${sid}', this.value)">` : `<span>${label}</span>`} </div> <div class="card-controls"> ${isCust ? `<button class="tool-btn del" style="width:20px;height:20px;" onclick="event.stopPropagation(); app.deleteNomiSection('${sid}')">Ã—</button>` : `<span id="count_${sid}" style="font-size:0.7rem; opacity:0.6">${val.length}/${limit}</span>`} <span class="card-arrow">â–¼</span> </div> </div> <div class="card-body"> <textarea id="field_${sid}" class="ghost-input" oninput="app.handleInput('${sid}', ${limit}, ${isCust})">${val}</textarea> <div class="btn-row"> <div style="display:flex; gap:10px;"> <button class="save-btn" onclick="app.saveCurrentNomi(true)">Save</button> <button class="copy-btn" style="background:rgba(239,68,68,0.2); border-color:rgba(239,68,68,0.3); color:#fca5a5;" onclick="app.cancelSection('${sid}', false)">Cancel</button> </div> <div style="display:flex; gap:10px;"> <button class="copy-btn" onclick="app.pasteText('field_${sid}')">Paste</button> <button class="copy-btn" onclick="app.copyText('field_${sid}')">Copy</button> </div> </div> </div> </div>`; 
            c.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    
    addNomiSection() { const n = this.data.nomis.find(x => x.id === this.currentNomiId); if(!n.custom_sections) n.custom_sections = []; const newId = 'cs_' + Date.now(); n.custom_sections.push({ id: newId, title: "New Section", content: "" }); n.sectionOrder.push(newId); this.saveToDB(); this.renderFormGrid(); }
    updateNomiSectionTitle(id, val) { const n = this.data.nomis.find(x => x.id === this.currentNomiId); const s = n.custom_sections.find(c => c.id === id); if(s) { s.title = val; this.saveToDB(); } }
    deleteNomiSection(id) { if(!confirm("Delete this section?")) return; const n = this.data.nomis.find(x => x.id === this.currentNomiId); n.custom_sections = n.custom_sections.filter(c => c.id !== id); n.sectionOrder = n.sectionOrder.filter(o => o !== id); this.saveToDB(); this.renderFormGrid(); }
    handleInput(id, limit, isCust) { 
        if(!isCust) { 
            const el = document.getElementById(`field_${id}`); 
            const card = document.getElementById(`card_${id}`); 
            const count = document.getElementById(`count_${id}`); 
            if(count) count.innerText = `${el.value.length}/${limit}`; 
            if(el.value.length > limit) { card.classList.add('over-limit'); count.style.color='#ef4444'; } 
            else { card.classList.remove('over-limit'); count.style.color='inherit'; } 
        } 
        this.autoResize(document.getElementById(`field_${id}`));
    }    
    autoSaveNomi() { this.saveCurrentNomi(false); }
    saveCurrentNomi(toast) { const n = this.data.nomis.find(x => x.id === this.currentNomiId); DEFAULT_SECTIONS.forEach(s => { const el = document.getElementById(`field_${s.id}`); if(el) n.data[s.id] = el.value; }); if(n.custom_sections) { n.custom_sections.forEach(s => { const el = document.getElementById(`field_${s.id}`); if(el) s.content = el.value; }); } this.saveToDB().then(() => { if(toast) this.showToast("Profile Saved!"); }); }
    renderTraits() { const n = this.data.nomis.find(x => x.id === this.currentNomiId); const c = document.getElementById('traitContainer'); c.innerHTML = ''; (n.data.key_traits || []).forEach(t => { const d=document.createElement('div'); d.className='tag'; d.innerText=t+' Ã—'; d.onclick=()=>{ n.data.key_traits=n.data.key_traits.filter(x=>x!==t); this.saveToDB(); this.renderTraits(); }; c.appendChild(d); }); }
    addTrait(t) { const n=this.data.nomis.find(x=>x.id===this.currentNomiId); if(!n.data.key_traits)n.data.key_traits=[]; if(n.data.key_traits.length>=7)return alert("Max 7 traits"); if(t.trim()){ n.data.key_traits.push(t.trim()); this.saveToDB(); this.renderTraits(); } }
    async addGalleryImages(inpt) { 
        const files=Array.from(inpt.files); 
        if(files.length===0)return; 
        
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);

        for(const f of files){ 
            await new Promise(r=>{ 
                this.processImage(f,1024,(b64)=>{ 
                    if(!target.gallery) target.gallery=[]; 
                    target.gallery.push({id:Date.now()+Math.random(),img:b64,prompt:""}); 
                    r(); 
                }); 
            }); 
        } 
        this.saveToDB().then(()=>this.renderPromptGallery()); 
    }
    
    filterGallery(term) {
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);
        let filtered = (target.gallery || []);
        if(term && term.trim() !== '') {
            const lowerTerm = term.toLowerCase();
            filtered = filtered.filter(item => (item.prompt || "").toLowerCase().includes(lowerTerm));
        }
        this.renderPromptGallery(filtered);
    }

    renderPromptGallery(filteredList = null) { 
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target, containerId;
        if (isGroup) {
            target = this.data.groups.find(x => x.id === this.currentGroupId);
            containerId = 'groupPromptGalleryGrid';
        } else {
            target = this.data.nomis.find(x => x.id === this.currentNomiId);
            containerId = 'promptGalleryGrid';
        }

        const g = document.getElementById(containerId); 
        if(!g) return;
        g.innerHTML = ''; 
        
        let listToRender = filteredList || (target.gallery || []);
        if(this.gallerySort === 'newest') listToRender = [...listToRender].reverse();

        const sizeMap = { small: '100px', medium: '160px', large: '260px', xlarge: '360px' };
        g.style.setProperty('--grid-min', sizeMap[this.gallerySize]);

        listToRender.forEach(i => { 
            const isSel = this.selectedImages.has(i.id);
            const d = document.createElement('div'); 
            d.className = `prompt-card ${isSel ? 'selected' : ''}`; 
            d.id = `card_${i.id}`; 

            let clickHandler;
            if(this.isBatchMode) {
                clickHandler = `onclick="app.toggleGallerySelection(${i.id})"`;
            } else {
                clickHandler = `onclick="app.openLightbox('${i.img}')"`;
            }
            
            const promptText = (i.prompt && i.prompt.trim()) ? i.prompt : "No prompt";
            const promptOverlay = this.galleryShowPrompts 
                ? `<div class="prompt-preview-text">${promptText}</div>` 
                : '';

            d.innerHTML = `
                <img src="${i.img}" ${clickHandler}>
                ${promptOverlay}
                <div class="ghost-overlay" style="${this.isBatchMode ? 'display:none;' : ''}">
                    <button class="tool-btn star" onclick="event.stopPropagation(); app.selectGalleryImageOptions('${i.img}', ${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                    </button>
                    <button class="tool-btn" onclick="event.stopPropagation(); app.openPromptPopup(${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="tool-btn del" onclick="event.stopPropagation(); app.deleteGalleryItem(${i.id})">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2-2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>`; 
            g.appendChild(d); 
        }); 
    }
    
    openPromptPopup(imgId) {
        this.currentEditingImageId = imgId;
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);
        const i = target.gallery.find(g => g.id === imgId);
        if(!i) return;
        document.getElementById('globalPromptInput').value = i.prompt || '';
        document.getElementById('globalPromptPopup').classList.add('active');
        setTimeout(() => document.getElementById('globalPromptInput').focus(), 50);
    }
    closePromptPopup() {
        document.getElementById('globalPromptPopup').classList.remove('active');
        this.currentEditingImageId = null;
    }

    updatePrompt(imgId, text) { 
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);

        const i=target.gallery.find(g=>g.id===imgId); 
        if(i){ i.prompt=text; } 
        
        const globalEl = document.getElementById('globalPromptInput');
        const localEl = document.getElementById(`inplace_input_${imgId}`);
        if(globalEl && globalEl.value !== text) globalEl.value = text;
        if(localEl && localEl.value !== text) localEl.value = text;
    }

    savePromptManual() { 
        if(!this.currentEditingImageId) return;
        const val = document.getElementById('globalPromptInput').value;
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);

        const i = target.gallery.find(g => g.id === this.currentEditingImageId);
        if(i) {
            i.prompt = val;
            const card = document.getElementById(`card_${this.currentEditingImageId}`);
            if(card) {
                const overlay = card.querySelector('.prompt-preview-text');
                if(overlay) overlay.innerText = val;
            }
        }
        this.saveToDB(); this.showToast("Prompt Saved!"); this.closePromptPopup(); 
    }

    deleteGalleryItem(id) { 
        if(!confirm("Remove image?")) return; 
        const isGroup = document.getElementById('viewGroup').style.display === 'block';
        let target;
        if(isGroup) target = this.data.groups.find(x => x.id === this.currentGroupId);
        else target = this.data.nomis.find(x => x.id === this.currentNomiId);

        target.gallery = target.gallery.filter(g => g.id !== id); 
        this.saveToDB(); this.renderPromptGallery(); 
    }
    
    setNomiPhoto(b64, optionalId) { 
        const id = optionalId || this.currentNomiId;
        const n = this.data.nomis.find(x => x.id === id); 
        if(n) {
            n.photo = b64; this.saveToDB(); 
            if(this.currentNomiId === id) {
                document.getElementById('nomiImageDisplay').src = b64; 
                document.getElementById('nomiImageDisplay').style.display = 'block'; 
                document.getElementById('nomiImagePlaceholder').style.display = 'none'; 
            }
            this.renderGallery(false);
        }
    }

    setGroupPhoto(b64, optionalId) { 
        const id = optionalId || this.currentGroupId;
        const g = this.data.groups.find(x => x.id === id); 
        if(g) {
            g.photo = b64; this.saveToDB(); 
            if(this.currentGroupId === id) {
                document.getElementById('groupImageDisplay').src = b64; 
                document.getElementById('groupImageDisplay').style.display = 'block'; 
                document.getElementById('groupImagePlaceholder').style.display = 'none'; 
            }
            this.renderGallery(false);
        }
    }

    editGroup(id, pushHistory = true, initialTab = 'profile') { 
        this.currentGroupId=id; this.saveState('group', id);
        this.isReordering = false;
        const btnGroup = document.getElementById('btnSortGroup');
        if(btnGroup) btnGroup.classList.remove('active');
        const rstGroup = document.getElementById('btnResetGroup');
        if(rstGroup) rstGroup.style.visibility = 'hidden';

        if(pushHistory) history.pushState({view: 'group', id: id, tab: initialTab}, '', '#group/'+id);
        
        const g=this.data.groups.find(x=>x.id===id); 
        if(!g.sectionOrder) { g.sectionOrder = ['backstory']; (g.custom_sections||[]).forEach(c=>g.sectionOrder.push(c.id)); } 
        
        document.getElementById('viewHome').style.display='none'; 
        document.getElementById('viewNomi').style.display='none'; 
        document.getElementById('viewGroup').style.display='block'; 
        document.getElementById('heroBackground').style.backgroundImage='none'; 
        
        this.toggleNameEdit('group', false); 
        document.getElementById('groupNameDisplay').innerText=g.name; 
        document.getElementById('groupName').value=g.name; 
        
        const d=document.getElementById('groupImageDisplay'); 
        const p=document.getElementById('groupImagePlaceholder'); 
        
        if(g.photo) {
            d.src=g.photo; d.style.display='block'; p.style.display='none';
        } else {
            d.style.display='none'; p.style.display='flex';
            p.innerText = g.name ? g.name.charAt(0) : '?';
        } 
        
        this.switchGroupTab(initialTab); 
    }
    createGroup() { const g={ id:Date.now(), name:"New Group", photo:null, members:[], custom_sections:[], sectionOrder:['backstory'], gallery: [] }; this.data.groups.push(g); this.saveToDB().then(()=>this.editGroup(g.id)); }
    
    renderGroupMembers() { 
        const c = document.getElementById('groupMembersGrid'); 
        c.innerHTML = ''; 
        const g = this.data.groups.find(x => x.id === this.currentGroupId); 
        
        if(g.members.length === 0) {
            c.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:var(--text-muted);">No members yet. Add one above!</div>';
            return;
        }

        g.members.forEach(m => { 
            const n = this.data.nomis.find(x => x.id === m.id); 
            if(n) { 
                const d = document.createElement('div'); 
                d.className = 'member-card'; 
                
                const roleText = m.role && m.role.trim() !== "" ? m.role : '<em style="opacity:0.5">Add Note...</em>';
                // Clean role for attribute safety (removes quotes)
                const safeRole = (m.role || "").replace(/"/g, '&quot;');
                
                d.innerHTML = `
                    <div class="member-remove" onclick="app.removeMember(${n.id})" title="Remove">âœ•</div>
                    <img src="${n.photo || ''}" onerror="this.style.display='none'" onclick="app.editNomi(${n.id})">
                    <div class="member-name" onclick="app.editNomi(${n.id})">${n.name}</div>
                    
                    <div id="role_disp_${n.id}" class="member-role-display" title="${safeRole}" onclick="app.toggleMemberRoleEdit(${n.id}, true)">
                        <span>${roleText}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.5; flex-shrink:0;"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </div>

                    <div id="role_edit_${n.id}" class="member-role-edit">
                        <textarea id="role_input_${n.id}" class="member-role-input" placeholder="Role / Note">${m.role || ''}</textarea>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <div class="role-btn save" onclick="app.saveMemberRole(${n.id})">âœ“</div>
                            <div class="role-btn cancel" onclick="app.cancelMemberRole(${n.id})">âœ•</div>
                        </div>
                    </div>
                `; 
                c.appendChild(d); 
            } 
        }); 
    }
    
    toggleMemberDropdown() { const d=document.getElementById('memberOptions'); if(d.classList.contains('open')){d.classList.remove('open');return;} d.innerHTML=''; const g=this.data.groups.find(x=>x.id===this.currentGroupId); let h=false; this.data.nomis.forEach(n=>{ if(!g.members.find(m => m.id === n.id)){ h=true; const dv=document.createElement('div'); dv.className='custom-option'; dv.innerHTML=`<img src="${n.photo||''}" onerror="this.style.display='none'"><span>${n.name}</span>`; dv.onclick=()=>app.addMember(n.id); d.appendChild(dv); } }); if(!h)d.innerHTML='<div style="padding:10px;color:var(--text-muted);font-size:0.9rem;">No other Nomis available.</div>'; d.classList.add('open'); }
    addMember(id) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.members.push({id: id, role: ""}); this.saveToDB(); this.renderGroupMembers(); document.getElementById('memberOptions').classList.remove('open'); }
    removeMember(id) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.members=g.members.filter(m=>m.id!==id); this.saveToDB(); this.renderGroupMembers(); }
    updateMemberRole(id, val) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); const m=g.members.find(x=>x.id===id); if(m){ m.role=val; this.saveToDB(); } }
    toggleMemberRoleEdit(id, show) {
        // 1. Force close any OTHER open edit boxes to keep the grid clean
        if (show) {
            const activeEdits = document.querySelectorAll('.member-role-edit.active');
            activeEdits.forEach(el => {
                const otherId = el.id.split('role_edit_')[1];
                if (otherId && otherId != id) {
                    this.cancelMemberRole(otherId);
                }
            });
        }

        // 2. Toggle the specific one requested
        const disp = document.getElementById(`role_disp_${id}`);
        const edit = document.getElementById(`role_edit_${id}`);
        const input = document.getElementById(`role_input_${id}`);
        
        if(show) {
            disp.style.display = 'none';
            edit.classList.add('active');
            setTimeout(() => input.focus(), 50);
        } else {
            disp.style.display = 'flex';
            edit.classList.remove('active');
        }
    }

    saveMemberRole(id) {
        const g = this.data.groups.find(x => x.id === this.currentGroupId);
        const m = g.members.find(x => x.id === id);
        const input = document.getElementById(`role_input_${id}`);
        if(m) {
            m.role = input.value;
            this.saveToDB();
            this.renderGroupMembers(); // Re-render to show updated text
        }
    }

    cancelMemberRole(id) {
        const g = this.data.groups.find(x => x.id === this.currentGroupId);
        const m = g.members.find(x => x.id === id);
        const input = document.getElementById(`role_input_${id}`);
        
        // Reset input to original value and hide edit mode
        input.value = m.role || "";
        this.toggleMemberRoleEdit(id, false);
    }
    addGroupSection() { const g=this.data.groups.find(x=>x.id===this.currentGroupId); if(!g.custom_sections)g.custom_sections=[]; const nid='cs_g_'+Date.now(); g.custom_sections.push({id:nid,title:"New Section",content:""}); g.sectionOrder.push(nid); this.saveToDB(); this.renderGroupSections(); }
    renderGroupSections() { 
        const c=document.getElementById('groupSectionsContainer'); c.innerHTML=''; 
        const g=this.data.groups.find(x=>x.id===this.currentGroupId); 
        if(!g.sectionOrder) { g.sectionOrder=['backstory']; (g.custom_sections||[]).forEach(cs=>g.sectionOrder.push(cs.id)); } 
        const draggableAttr = this.isReordering ? 'draggable="true"' : 'draggable="false"';
        const handleStyle = this.isReordering ? 'display:block;' : '';
        if(this.isReordering) { c.ondragover = (e) => app.handleDragOver(e); }

        g.sectionOrder.forEach(sid => { 
            const isBackstory = sid === 'backstory'; 
            const cust = g.custom_sections ? g.custom_sections.find(cs => cs.id === sid) : null; 
            if(!isBackstory && !cust) return; 
            const title = isBackstory ? "Group Backstory" : cust.title; 
            const content = isBackstory ? (g.backstory || '') : cust.content; 
            const html = ` <div class="glass-card collapsed" id="card_group_${sid}" draggable="${this.isReordering}" ondragstart="app.handleDragStart(event, '${sid}', true)" ondragend="app.handleDragEnd(event)"> <div class="card-header" onclick="app.toggleCard(this.parentNode)"> <div class="card-header-left"> <span class="drag-handle" style="${handleStyle}" onmousedown="event.stopPropagation()" ontouchstart="app.handleTouchStart(event)" ontouchmove="app.handleTouchMove(event)" ontouchend="app.handleTouchEnd(event)"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg> </span> ${isBackstory ? `<span>${title}</span>` : `<input type="text" value="${title}" style="background:transparent;border:none;color:var(--accent);font-weight:700;font-size:0.85rem;width:100%;font-family:inherit;letter-spacing:1px;text-transform:uppercase;padding:0;margin:0;-webkit-user-select:text;user-select:text;" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()" oninput="app.updateGroupSectionTitle('${sid}', this.value)">`} </div> <div class="card-controls"> ${isBackstory ? `<span id="groupCount" style="margin-right:10px;opacity:0.6">${content.length}/1000</span>` : `<button class="tool-btn del" style="width:20px;height:20px;" onclick="event.stopPropagation(); app.deleteGroupSection('${sid}')">Ã—</button>`} <span class="card-arrow">â–¼</span> </div> </div> <div class="card-body"> <textarea id="group_sec_${sid}" class="ghost-input" oninput="app.updateGroupSectionContent('${sid}', this.value)">${content}</textarea> <div class="btn-row"> <div style="display:flex; gap:10px;"> <button class="save-btn" onclick="app.saveCurrentGroup(true)">Save</button> <button class="copy-btn" style="background:rgba(239,68,68,0.2); border-color:rgba(239,68,68,0.3); color:#fca5a5;" onclick="app.cancelSection('${sid}', true)">Cancel</button> </div> <div style="display:flex; gap:10px;"> <button class="copy-btn" onclick="app.pasteText('group_sec_${sid}')">Paste</button> <button class="copy-btn" onclick="app.copyText('group_sec_${sid}')">Copy</button> </div> </div> </div> </div>`; 
            c.insertAdjacentHTML('beforeend', html); 
        }); 
    }
    updateGroupSectionTitle(id, val) { const g=this.data.groups.find(x=>x.id===this.currentGroupId); const s=g.custom_sections.find(x=>x.id===id); if(s){ s.title=val; this.saveToDB(); } }
    updateGroupSectionContent(id, val) { 
        const g=this.data.groups.find(x=>x.id===this.currentGroupId); 
        if(id==='backstory') { document.getElementById('groupCount').innerText=`${val.length}/1000`; }
        this.autoResize(document.getElementById(`group_sec_${id}`));
    }    
    deleteGroupSection(id) { if(!confirm("Delete?"))return; const g=this.data.groups.find(x=>x.id===this.currentGroupId); g.custom_sections=g.custom_sections.filter(x=>x.id!==id); g.sectionOrder=g.sectionOrder.filter(x=>x!==id); this.saveToDB(); this.renderGroupSections(); }
    autoSaveGroup() { this.saveCurrentGroup(false); }
    saveCurrentGroup(showToast = true) {
        const g = this.data.groups.find(x => x.id === this.currentGroupId);
        const bsEl = document.getElementById('group_sec_backstory');
        if(bsEl) g.backstory = bsEl.value;
        if(g.custom_sections) {
            g.custom_sections.forEach(s => {
                const el = document.getElementById('group_sec_' + s.id);
                if(el) s.content = el.value;
            });
        }
        this.saveToDB();
        if (showToast) this.showToast("Group Saved!");
    }
    autoResize(el) {
        if (!el) return;
        el.style.height = 'auto';
        const newHeight = el.scrollHeight;
        el.style.height = newHeight + 'px';
        if (newHeight > 300) { el.style.overflowY = "auto"; } else { el.style.overflowY = "hidden"; }
    }
    toggleCard(c) { c.classList.toggle('collapsed'); if (!c.classList.contains('collapsed')) { const ta = c.querySelector('textarea'); this.autoResize(ta); } }
    deleteNomi() { if(confirm("Delete permanently?")) { this.data.nomis=this.data.nomis.filter(n=>n.id!==this.currentNomiId); this.saveToDB(); this.goHome(); } }
    deleteGroup() { if(confirm("Delete Group?")) { this.data.groups=this.data.groups.filter(g=>g.id!==this.currentGroupId); this.saveToDB(); this.goHome(); } }

    exportData() { const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this.data)); const a=document.createElement('a'); a.href=s; a.download="nomi_backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
    importData(i) { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ try{const j=JSON.parse(e.target.result); if(confirm("Overwrite data?")){this.data=j;this.saveToDB().then(()=>{alert("Done!");location.reload();});}}catch(e){alert("Invalid JSON");} }; r.readAsText(f); }
    
    processImage(f,mw,cb) { 
        if(!f)return; 
        const r=new FileReader(); 
        r.onload=(e)=>{ 
            const i=new Image(); i.src=e.target.result; 
            i.onload=()=>{ 
                const c=document.createElement('canvas'); const s=mw/i.width; c.width=mw; c.height=i.height*s; 
                const x=c.getContext('2d'); x.drawImage(i,0,0,c.width,c.height); cb(c.toDataURL('image/webp',0.8)); 
            }; 
        }; 
        r.readAsDataURL(f); 
    }
    
    async optimizeStorage() {
        const btn = document.getElementById('btnOptimize'); const originalText = btn.innerText;
        btn.innerText = "Processing... (Do not close)"; btn.disabled = true;
        let count = 0;
        const recompress = (b64) => {
            return new Promise((resolve) => {
                if(!b64 || !b64.startsWith('data:image')) return resolve(b64);
                const img = new Image(); img.src = b64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 1024;
                    let width = img.naturalWidth; let height = img.naturalHeight;
                    if(width > maxWidth) { height = (height * maxWidth) / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/webp', 0.8));
                };
                img.onerror = () => resolve(b64);
            });
        };
        for(let n of this.data.nomis) {
            if(n.photo) { n.photo = await recompress(n.photo); count++; }
            if(n.gallery) { for(let g of n.gallery) { if(g.img) { g.img = await recompress(g.img); count++; } } }
        }
        for(let g of this.data.groups) {
            if(g.photo) { g.photo = await recompress(g.photo); count++; }
            if(g.gallery) { for(let pic of g.gallery) { if(pic.img) { pic.img = await recompress(pic.img); count++; } } }
        }
        await this.saveToDB();
        btn.innerText = "Done! Processed " + count + " images.";
        this.renderStorageDashboard();
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 3000);
        alert(`Optimization Complete!\nProcessed ${count} images.\nCheck "Local Data" to see how much space you saved.`);
    }

    copyText(id) { navigator.clipboard.writeText(document.getElementById(id).value).then(()=>this.showToast("Copied!")); }
    showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    openLightbox(s) { if(!s)return; document.getElementById('lightboxImg').src=s; document.getElementById('lightbox').classList.add('active'); history.pushState({ view: 'lightbox' }, '', '#lightbox');}
    closeLightbox() { document.getElementById('lightbox').classList.remove('active'); if(history.state && history.state.view === 'lightbox') { history.back(); } }
}

const app = new NomiApp(); window.onload = () => app.init();
</script>
</body>
</html>

